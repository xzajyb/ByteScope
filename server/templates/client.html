<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客户端详情 - {{ client_info.hostname }}</title>
    <!-- 立即执行的调试代码 -->
    <script>
        console.log("[初始化调试] 页面开始加载，时间戳:", new Date().toISOString());
        window.debugEvents = {
            pageLoadStart: new Date().getTime()
        };
        
        // 页面加载完成事件
        window.addEventListener('load', function() {
            console.log("[初始化调试] 页面完全加载完成，耗时:", (new Date().getTime() - window.debugEvents.pageLoadStart) + "ms");
            console.log("[初始化调试] 验证状态元素存在情况：", {
                "verification-status-display": !!document.getElementById('verification-status-display'),
                "verification-banner": !!document.getElementById('verification-banner'),
                "verification-banner-text": !!document.getElementById('verification-banner-text'),
                "verification-modal": !!document.getElementById('verification-modal')
            });
        });
        
        // 检查是否存在多个checkVerificationStatus函数定义
        function countFunctionDefinitions() {
            let scriptTags = document.getElementsByTagName('script');
            let count = 0;
            
            for (let i = 0; i < scriptTags.length; i++) {
                let content = scriptTags[i].textContent || '';
                let matches = content.match(/function\s+checkVerificationStatus\s*\(/g);
                if (matches) {
                    count += matches.length;
                }
            }
            
            console.log("[初始化调试] 检测到", count, "个checkVerificationStatus函数定义");
            if (count > 1) {
                console.error("[初始化调试] 警告: 存在多个checkVerificationStatus函数定义，可能导致冲突!");
            }
        }
        
        // 在DOM加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            console.log("[初始化调试] DOM内容加载完成");
            // 延迟一点执行，确保所有脚本都已加载
            setTimeout(countFunctionDefinitions, 1000);
        });
    </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #2c3e50;
        }
        h1 {
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .client-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .client-info p {
            margin: 5px 0;
        }
        .btn {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 14px;
            margin-right: 10px;
        }
        .btn:hover {
            background: #2980b9;
        }
        .btn-back {
            background: #95a5a6;
        }
        .btn-back:hover {
            background: #7f8c8d;
        }
        .nav-links {
            margin-bottom: 20px;
        }
        .screenshots, .keylogs {
            margin-bottom: 30px;
        }
        .screenshot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        .screenshot-item {
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            transition: transform 0.3s;
        }
        .screenshot-item:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .screenshot-item img {
            width: 100%;
            height: auto;
            display: block;
        }
        .screenshot-info {
            padding: 10px;
            background: #f8f9fa;
            font-size: 14px;
        }
        .keylog-list {
            list-style: none;
            padding: 0;
        }
        .keylog-item {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            background: white;
            transition: background 0.2s;
        }
        .keylog-item:hover {
            background: #f8f9fa;
        }
        .keylog-time {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 4px 4px 0 0;
        }
        .tab.active {
            background: #fff;
            border-color: #ddd;
            color: #3498db;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .empty-message {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
            font-style: italic;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .lightbox img {
            max-width: 90%;
            max-height: 90%;
        }
        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 30px;
            cursor: pointer;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .refresh {
            background: #2ecc71;
        }
        .refresh:hover {
            background: #27ae60;
        }
        .screenshot-container {
            position: relative;
            margin-bottom: 20px;
        }
        .screenshot-container img {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .screenshot-timestamp {
            position: absolute;
            bottom: 0;
            right: 0;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 4px 0 0 0;
        }
        .video-container {
            margin-bottom: 20px;
        }
        .video-container video {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .command-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .pending {
            background-color: #fff3cd;
            color: #856404;
        }
        .nav-pills .nav-link.active {
            background-color: #0d6efd;
        }
        .tab-content {
            padding: 20px 0;
        }
        .timestamp {
            font-size: 12px;
            color: #6c757d;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .success-message {
            display: none;
            margin-top: 15px;
        }
        .error-message {
            display: none;
            margin-top: 15px;
        }
        
        /* 强制显示标签页内容 */
        .tab-pane.active {
            display: block !important;
        }
        .tab-pane {
            opacity: 1 !important;
        }
        
        /* 确保首个标签页显示 */
        #screenshots.active {
            display: block !important;
        }
        
        /* 改进标签页按钮样式 */
        .nav-pills .nav-link {
            margin-right: 5px;
            border-radius: 4px;
            padding: 8px 15px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .nav-pills .nav-link:hover {
            background-color: rgba(13, 110, 253, 0.1);
        }
        
        .nav-pills .nav-link.active {
            background-color: #0d6efd;
            color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        /* 添加间距 */
        .tab-content {
            margin-top: 20px;
        }
        
        /* 美化卡片样式 */
        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: 1px solid rgba(0, 0, 0, 0.125);
            transition: box-shadow 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        
        .card-header {
            background-color: rgba(0, 0, 0, 0.03);
            border-bottom: 1px solid rgba(0, 0, 0, 0.125);
            font-weight: 500;
        }
        
        /* 美化按钮 */
        .btn-outline-primary {
            border-color: #0d6efd;
            color: #0d6efd;
        }
        
        .btn-outline-primary:hover {
            background-color: #0d6efd;
            color: white;
        }
        
        /* 美化表格 */
        .table th {
            background-color: rgba(0, 0, 0, 0.03);
        }
        
        /* 增强阴影效果 */
        .screenshot-container {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            transition: transform 0.3s, box-shadow 0.3s;
            margin-bottom: 25px;
        }
        
        .screenshot-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        
        /* 强制显示第一个标签页内容 - 最高优先级 */
        #screenshots {
            display: block;
        }
        
        /* 确保标签页内容区域可见 */
        .tab-content, .tab-pane {
            transition: none !important;
        }
        
        /* 如果标签页仍然不显示，尝试内联样式 */
        #clientTabsContent {
            display: block !important;
        }

        /* 截图容器样式优化 */
        .screenshots-container {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .screenshot-container {
            margin-bottom: 20px;
            border-radius: 5px;
            overflow: hidden;
        }

        /* 美化所有标签页内容 */
        .tab-pane {
            padding: 15px 0;
        }

        /* 确保Bootstrap标签页正确工作 */
        .tab-content > .tab-pane {
            display: none;
        }
        
        .tab-content > .active {
            display: block;
        }

        /* 截图网格布局 */
        .screenshots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 15px;
        }

        .screenshot-card {
            border: 1px solid #dee2e6;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .screenshot-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        .screenshot-card .card-img-top {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .screenshot-card .card-footer {
            padding: 8px 12px;
            background: rgba(0,0,0,0.03);
            font-size: 12px;
        }
        
        /* Logo样式 */
        .logo-container {
            display: flex;
            align-items: center;
        }
        
        .logo {
            height: 40px;
            margin-right: 15px;
        }
        
        .logo-text {
            font-size: 24px;
            font-weight: bold;
            color: #0d6efd;
            margin: 0;
        }
        
        .logo-text span {
            color: #212529;
            font-weight: normal;
        }

        /* 验证横幅样式 */
        .verification-banner {
            display: flex;
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            border-left: 5px solid #f5c6cb;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1000;
        }

        .verification-banner .banner-content {
            display: flex;
            align-items: center;
            width: 100%;
            gap: 15px;
        }

        .verification-banner i {
            font-size: 24px;
            flex-shrink: 0;
        }

        .verification-banner span {
            flex-grow: 1;
            font-size: 15px;
        }

        .verification-banner button {
            flex-shrink: 0;
            white-space: nowrap;
            padding: 8px 15px;
            font-weight: 500;
        }

        .verification-banner.urgent {
            background-color: #dc3545;
            color: #fff;
            border-left: 5px solid #a71d2a;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* 验证弹窗样式 */
        .verification-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
        }

        .verification-modal-content {
            background-color: #fefefe;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .verification-modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #aaa;
        }

        .verification-modal-close:hover,
        .verification-modal-close:focus {
            color: #333;
        }

        .verification-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .verification-info {
            margin-bottom: 20px;
            color: #555;
            line-height: 1.5;
        }

        .verification-result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            background-color: #f8f9fa;
        }

        .verification-result.success {
            background-color: #d4edda;
            color: #155724;
        }

        .verification-result.error {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* 验证状态指示器样式 */
        .verification-status-indicator {
            background-color: #f8f9fa;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-dot.bg-success {
            background-color: #28a745;
        }

        .status-dot.bg-danger {
            background-color: #dc3545;
        }

        .status-dot.bg-warning {
            background-color: #ffc107;
        }

        .status-dot.bg-secondary {
            background-color: #6c757d;
        }

        /* 禁用覆盖层样式 */
        .disabled-feature-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            min-width: 350px;
            min-height: 350px;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 900;
            border-radius: 10px;
            box-shadow: inset 0 0 0 1px rgba(0,0,0,0.05);
            animation: fade-in 0.3s ease-in;
            overflow: auto;
        }
        
        @keyframes fade-in {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        
        .disabled-content {
            background-color: white;
            padding: 30px;
            border-radius: 16px;
            width: 320px;
            max-width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0,0,0,0.05);
            animation: slide-up 0.5s ease-out;
            margin: 20px;
        }
        
        @keyframes slide-up {
            0% { transform: translateY(20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        
        .lock-circle {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(45deg, #dc3545, #ff6b6b);
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
            animation: pulse 1.5s infinite alternate;
        }
        
        .lock-circle i {
            font-size: 32px;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }
        
        .verify-btn {
            transition: all 0.2s ease;
        }
        
        .verify-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }
        
        /* 添加脉冲动画效果 */
        .pulse-animation {
            animation: pulse-effect 1.5s infinite;
            box-shadow: 0 0 0 rgba(25, 135, 84, 0.4);
        }
        
        @keyframes pulse-effect {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(25, 135, 84, 0.7);
            }
            
            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(25, 135, 84, 0);
            }
            
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(25, 135, 84, 0);
            }
        }
        
        /* 斜着悬挂的按钮样式 */
        .hanging-skip-button {
            position: absolute;
            top: -15px;
            right: -30px;
            transform: rotate(30deg);
            z-index: 10;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .hanging-skip-button span {
            display: block;
            background-image: linear-gradient(to right, #ff6b6b, #ff8e53);
            color: white;
            padding: 10px 20px;
            font-weight: bold;
            font-size: 16px;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
            text-align: center;
            position: relative;
            min-width: 140px;
        }
        
        .hanging-skip-button span::before {
            content: "";
            position: absolute;
            top: -10px;
            left: 0;
            width: 20px;
            height: 10px;
            background-color: #d63031;
            border-radius: 10px 0 0 0;
            box-shadow: inset -2px 2px 2px rgba(0, 0, 0, 0.2);
        }
        
        .hanging-skip-button span::after {
            content: "";
            position: absolute;
            top: -10px;
            right: 0;
            width: 20px;
            height: 10px;
            background-color: #d63031;
            border-radius: 0 10px 0 0;
            box-shadow: inset 2px 2px 2px rgba(0, 0, 0, 0.2);
        }
        
        .hanging-skip-button:hover {
            transform: rotate(30deg) scale(1.1);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.25);
        }
        
        .hanging-skip-button:active {
            transform: rotate(30deg) scale(0.98);
        }

        /* 添加脉冲动画效果 */
        .pulse-animation {
            animation: pulse-effect 1.5s infinite;
            box-shadow: 0 0 0 rgba(25, 135, 84, 0.4);
        }
        
        @keyframes pulse-effect {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(25, 135, 84, 0.7);
            }
            
            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(25, 135, 84, 0);
            }
            
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(25, 135, 84, 0);
            }
        }
        
        /* 跳过验证按钮样式 */
        .skip-button {
            position: absolute;
            top: 10px;
            right: 50px;
            z-index: 10;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .skip-button span {
            display: block;
            background-image: linear-gradient(to right, #ff6b6b, #ff8e53);
            color: white;
            padding: 6px 15px;
            font-weight: bold;
            font-size: 14px;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            text-align: center;
        }
        
        .skip-button:hover span {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .skip-button:active span {
            transform: translateY(0);
            box-shadow: 0 2px 3px rgba(0, 0, 0, 0.2);
        }
        
        /* 调整关闭按钮的位置 */
        .verification-modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            z-index: 15;
        }
        
        /* 确保验证输入框和按钮在一行 */
        .verification-input {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }
        
        .input-group .btn {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }

        /* 调整验证按钮与输入框高度一致 */
        #verification-key, .btn-primary {
            height: 38px; /* 确保高度一致 */
            line-height: 1.5;
            box-sizing: border-box;
            margin: 0;
            padding-top: 0.375rem;
            padding-bottom: 0.375rem;
        }
        
        .input-group {
            align-items: center;
            display: flex;
        }
        
        .input-group .btn {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 调整验证按钮与输入框高度一致 - 更简洁的方式 */
        .verification-input, 
        .verification-input + .btn {
            height: 38px;
            line-height: normal;
        }

        /* 复制按钮样式 */
        .copy-btn {
            transition: all 0.2s ease;
            border: 1px solid #dee2e6;
            width: 32px;
            height: 32px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        .copy-btn:hover {
            background-color: #f8f9fa;
            border-color: #6c757d;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .copy-btn:active {
            transform: translateY(0);
        }

        .copy-btn.btn-success {
            background-color: #198754;
            border-color: #198754;
            color: white;
        }

        .copy-btn.btn-success:hover {
            background-color: #157347;
            border-color: #146c43;
        }

        /* 机器码显示样式 */
        #machine-code-display {
            font-family: 'Courier New', 'Monaco', monospace;
            font-weight: bold;
            font-size: 14px;
            letter-spacing: 1px;
            min-width: 120px;
            text-align: center;
        }

        /* 专业永久激活样式 */
        .permanent-activation-luxury {
            position: relative;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 50%, #ffffff 100%);
            border: 2px solid #198754;
            border-radius: 12px;
            padding: 24px;
            margin: 16px 0;
            box-shadow: 
                0 8px 32px rgba(25, 135, 84, 0.12),
                0 2px 8px rgba(25, 135, 84, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .permanent-activation-luxury::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #198754, #20c997, #0d6efd, #198754);
            background-size: 200% 100%;
            animation: premium-gradient 3s linear infinite;
        }

        @keyframes premium-gradient {
            0% { background-position: 0% 0%; }
            100% { background-position: 200% 0%; }
        }

        .luxury-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .luxury-icon {
            font-size: 32px;
            color: #198754;
            margin-bottom: 12px;
            display: block;
        }

        .luxury-content {
            text-align: center;
            color: #2d3748;
        }

        .luxury-title {
            font-size: 24px;
            font-weight: 600;
            margin: 0 0 8px 0;
            color: #1a202c;
            letter-spacing: -0.025em;
        }

        .luxury-subtitle {
            font-size: 15px;
            color: #4a5568;
            font-weight: 400;
            margin-bottom: 16px;
        }

        .luxury-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #198754, #20c997);
            color: white;
            padding: 8px 20px;
            border-radius: 24px;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            box-shadow: 0 4px 12px rgba(25, 135, 84, 0.3);
        }

        .luxury-badge i {
            color: #ffffff;
            font-size: 14px;
        }

        /* 专业永久激活按钮样式 */
        .btn-permanent-luxury {
            background: linear-gradient(135deg, #198754, #20c997) !important;
            border: 1px solid #198754 !important;
            color: white !important;
            font-weight: 600 !important;
            letter-spacing: 0.025em !important;
            box-shadow: 
                0 4px 12px rgba(25, 135, 84, 0.25),
                0 2px 4px rgba(25, 135, 84, 0.15) !important;
            transition: all 0.2s ease !important;
        }

        .btn-permanent-luxury:hover {
            transform: translateY(-1px) !important;
            box-shadow: 
                0 6px 16px rgba(25, 135, 84, 0.3),
                0 4px 8px rgba(25, 135, 84, 0.2) !important;
        }

        /* 全页面永久激活高级样式 */
        body.permanent-activated {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 50%, #f8f9fa 100%);
        }

        .permanent-activated .container {
            position: relative;
        }

        .permanent-activated .container::before {
            content: '';
            position: absolute;
            top: -20px;
            left: -20px;
            right: -20px;
            height: 2px;
            background: linear-gradient(90deg, transparent, #198754, #20c997, #0d6efd, transparent);
            border-radius: 1px;
            opacity: 0.6;
        }

        /* 客户端信息卡片永久激活样式 */
        .permanent-activated .card {
            border: 1px solid rgba(25, 135, 84, 0.2);
            box-shadow: 
                0 4px 20px rgba(25, 135, 84, 0.08),
                0 1px 4px rgba(25, 135, 84, 0.04);
        }

        .permanent-activated .card-header {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border-bottom: 1px solid rgba(25, 135, 84, 0.15);
        }

        /* 标签页永久激活增强 */
        .permanent-activated .nav-pills .nav-link.active {
            background: linear-gradient(135deg, #198754, #20c997);
            box-shadow: 0 2px 8px rgba(25, 135, 84, 0.3);
        }

        /* 状态指示器永久激活样式 */
        .permanent-activated .status-dot.bg-success {
            background: linear-gradient(135deg, #198754, #20c997) !important;
            box-shadow: 0 0 8px rgba(25, 135, 84, 0.4);
            animation: premium-pulse 2s ease-in-out infinite;
        }

        @keyframes premium-pulse {
            0%, 100% { 
                transform: scale(1);
                opacity: 1;
            }
            50% { 
                transform: scale(1.1);
                opacity: 0.8;
            }
        }
    </style>
</head>
<body>
    <!-- 免责声明模态框 -->
    <div class="modal fade" id="disclaimerModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="disclaimerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title" id="disclaimerModalLabel"><i class="bi bi-exclamation-triangle"></i> 免责声明</h5>
                </div>
                <div class="modal-body">
                    <div class="disclaimer-content" style="max-height: 400px; overflow-y: auto;">
                        <h4 class="text-center">系统用途声明与法律警告</h4>
                        <hr>
                        <div class="alert alert-danger">
                            <strong>重要法律警告：</strong> 任何未经授权或用于非法目的的使用将被追究法律责任。一旦发现违法行为，我们将立即向有关部门报警！
                        </div>
                        <p><strong>请仔细阅读以下内容：</strong></p>
                        <p>本系统（ByteScope字节窥探）仅供组织内部的合法监控与管理使用，使用本系统前，请确保：</p>
                        <ol>
                            <li>您已获得相关设备和网络的合法管理权限</li>
                            <li>您已告知并获得被监控终端用户的明确知情同意</li>
                            <li>您的使用符合当地法律法规的规定（包括但不限于隐私法、网络安全法、劳动法等）</li>
                            <li>您不会将此系统用于任何侵犯个人隐私或侵害他人合法权益的活动</li>
                            <li>您了解并接受所有法律风险和责任</li>
            </ol>
                        
                        <p><strong>功能说明：</strong></p>
                        <p>本系统具有以下功能：</p>
                        <ul>
                            <li>屏幕截图与录屏</li>
                            <li>键盘输入记录</li>
                            <li>系统信息采集</li>
                            <li>远程文件访问</li>
                        </ul>
                        
                        <p><strong>免责声明：</strong></p>
                        <p>本系统开发者与提供者不对因使用本系统导致的任何直接或间接问题负责，包括但不限于：</p>
                        <ul>
                            <li>因未经授权使用本系统导致的法律责任</li>
                            <li>因系统bug导致的数据丢失或泄露</li>
                            <li>因网络问题导致的监控偏差或系统故障</li>
                        </ul>
                        
                        <p><strong>授权与许可：</strong></p>
                        <p>使用本系统代表您同意：</p>
                        <ul>
                            <li>仅将系统用于合法授权的监控</li>
                            <li>对系统采集的敏感数据负有保护义务</li>
                            <li>不会将系统用于任何侵犯他人隐私权或其他权利的目的</li>
                            <li>在发现任何违法使用时，您有义务立即停止并报告</li>
                        </ul>
                        
                        <div class="alert alert-warning">
                            <strong>注意：</strong> 使用本系统记录的所有操作和访问记录均会被系统日志保存，可能会被用作执法部门调查的证据。如果您使用本系统进行任何违法活动，我们将配合执法机构提供相关证据。
                        </div>
                        
                        <p>如有疑问，请联系系统管理员。</p>
                    </div>
                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="doNotShowAgain">
                        <label class="form-check-label" for="doNotShowAgain">不再显示此提示</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="rejectDisclaimerBtn">拒绝并退出</button>
                    <button type="button" class="btn btn-success" id="acceptDisclaimerBtn">我已阅读并同意</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 警告横幅 -->
    <div class="alert alert-danger text-center mb-4" style="font-size: 16px; font-weight: bold;">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        警告：本系统仅供合法组织内部监控使用。任何未经授权或非法使用将被追究法律责任。一旦发现违法行为，我们将立即向有关部门报警。
    </div>
    
    <div class="container mt-4">
        <!-- 添加验证横幅 -->
        <div id="verification-banner" class="verification-banner" style="display: none;">
            <div class="banner-content">
                <i class="bi bi-shield-exclamation"></i>
                <span id="verification-banner-text">此客户端需要验证，以确保监控的合法性。请输入验证密钥以继续操作。</span>
                <button id="verification-banner-button" onclick="showVerificationModal()" class="btn btn-primary btn-sm">立即验证</button>
            </div>
        </div>
        
        <!-- 验证模态框 -->
        <div id="verification-modal" class="verification-modal" style="display: none;">
            <div class="verification-modal-content position-relative">
                <span class="verification-modal-close" onclick="closeVerificationModal()">&times;</span>
                
                <!-- 修改后的按钮位置和样式 -->
                <div class="skip-button" onclick="showSkipVerification()">
                    <span><i class="bi bi-lightning-charge"></i> 快速跳过</span>
                </div>
                
                <h2 class="border-bottom pb-2"><i class="bi bi-shield-lock"></i> 客户端安全验证</h2>

                <!-- 验证主界面 -->
                <div id="verification-main-view">
                <p class="verification-info">
                    此客户端需要安全验证才能继续使用。<br>
                    验证密钥已保存在客户端电脑上，请联系管理员获取密钥。<br>
                    <strong>剩余尝试次数: <span id="attempts-count">0</span></strong><br>
                    <strong>倒计时: <span id="timeout-value">00:00:00</span></strong>
                </p>

                <!-- 机器码显示区域 -->
                <div class="machine-code-info mt-3 p-3 bg-light border rounded">
                    <h6 class="mb-2"><i class="bi bi-laptop"></i> 机器码信息</h6>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">机器码:</span>
                        <div class="d-flex align-items-center">
                            <code id="machine-code-display" class="bg-light px-2 py-1 rounded text-primary border me-2">获取中...</code>
                            <button id="copy-machine-code-btn" class="btn btn-sm btn-outline-secondary copy-btn" onclick="copyMachineCode()" title="点击复制机器码">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </div>
                    </div>
                    <small class="text-muted mt-2 d-block">
                        <i class="bi bi-info-circle"></i> 
                        如需永久激活，请将此机器码发送给开发者获取永久验证密钥
                    </small>
                </div>

                    <div class="verification-faq mb-3 border-top pt-3 mt-3">
                        <h5 class="mb-3"><i class="bi bi-question-circle"></i> 常见问题</h5>
                        <div class="accordion" id="verificationFaq">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="faqHeadingOne">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faqOne" aria-expanded="false" aria-controls="faqOne">
                                        为什么要进行验证？
                                    </button>
                                </h2>
                                <div id="faqOne" class="accordion-collapse collapse" aria-labelledby="faqHeadingOne" data-bs-parent="#verificationFaq">
                                    <div class="accordion-body">
                                        验证机制是为了确保监控系统的合法使用，防止未授权访问。只有经过授权的用户才能使用完整功能，这也是对被监控对象隐私的保护措施，我们会每周进行几次验证。
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="faqHeadingTwo">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faqTwo" aria-expanded="false" aria-controls="faqTwo">
                                        如果验证次数消耗完了怎么办？
                                    </button>
                                </h2>
                                <div id="faqTwo" class="accordion-collapse collapse" aria-labelledby="faqHeadingTwo" data-bs-parent="#verificationFaq">
                                    <div class="accordion-body">
                                        验证次数耗尽后，需要由监控对象所有者本人重新安装系统以重置验证机制。这确保了只有合法拥有者才能继续使用系统。
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="faqHeadingThree">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faqThree" aria-expanded="false" aria-controls="faqThree">
                                        如何永久不需要验证？
                                    </button>
                                </h2>
                                <div id="faqThree" class="accordion-collapse collapse" aria-labelledby="faqHeadingThree" data-bs-parent="#verificationFaq">
                                    <div class="accordion-body">
                                        需要向软件开发者购买永久认证激活码，激活后系统将不再要求定期验证。请联系客服获取购买信息及价格详情。
                                    </div>
                                </div>
                            </div>
            </div>
        </div>
                    
                    <div class="d-flex flex-column gap-3">
                        <div class="input-group d-flex align-items-stretch">
                            <input type="text" id="verification-key" class="verification-input form-control" style="border-radius: 5px 0 0 5px;" placeholder="请输入验证密钥" />
                            <button onclick="verifyKey()" class="btn btn-primary d-flex align-items-center justify-content-center" style="border-radius: 0 5px 5px 0;">验证</button>
                        </div>
                    </div>
                    <div id="verification-result" class="verification-result mt-3" style="display: none;"></div>
                </div>
                
                <!-- 跳过验证界面 -->
                <div id="skip-verification-view" style="display: none;">
                    <div class="text-center mb-4">
                        <i class="bi bi-unlock-fill" style="font-size: 48px; color: #0d6efd;"></i>
                        <h3 class="mt-2">跳过验证选项</h3>
                        <p class="text-muted">选择以下方式之一跳过繁琐的验证</p>
                    </div>
                    
                    <!-- 删除在跳过页面显示的快速跳过按钮 -->
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0">方法一：重新安装</h5>
                                </div>
                                <div class="card-body d-flex flex-column">
                                    <p>在监控对象上重新安装客户端软件，确保您拥有系统控制权，这将重置验证机制。</p>
                                    <div class="alert alert-warning mb-2">
                                        <small><i class="bi bi-exclamation-triangle"></i> <strong>注意:</strong> 此方法非常繁琐，且只能跳过一次验证，下次仍会出现</small>
                                    </div>
                                    <div class="mt-auto">
                                        <button onclick="deleteClient()" class="btn btn-danger w-100">
                                            <i class="bi bi-trash"></i> 卸载对方客户端
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card h-100 border-primary">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">方法二：永久激活 <span class="badge bg-warning">推荐</span></h5>
                                </div>
                                <div class="card-body d-flex flex-column">
                                    <p><strong>一次付费，永久激活</strong> - 无需再为验证烦恼！</p>
                                    <ul class="mb-3">
                                        <li>永久免除验证限制</li>
                                        <li>获得最新功能和更新</li>
                                        <li>优先技术支持服务</li>
                                        <li>次数消耗完也可激活</li>
                                    </ul>
                                    <div class="mt-2 mb-3">
                                        <span class="text-danger fw-bold">¥50.00</span>
                                        <span class="text-decoration-line-through text-muted ms-2">¥199.00</span>
                                        <div class="small text-danger mt-1">
                                            <i class="bi bi-clock"></i> 促销倒计时: <span id="promo-countdown-2" class="fw-bold">23:59:59</span>
                                        </div>
                                    </div>
                                    <div class="mt-auto d-grid gap-2">
                                        <button onclick="window.open('https://afdian.tv/item/3a378fa03ec411f0b59b52540025c377', '_blank')" class="btn btn-danger btn-lg pulse-animation mb-2">
                                            <i class="bi bi-cart-fill"></i> 直接购买
                                        </button>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="backToVerification()" class="btn btn-outline-secondary mt-3 w-100">
                        <i class="bi bi-arrow-left"></i> 返回验证页面
                    </button>
                </div>
                
                <!-- 永久激活表单界面 -->
                <div id="activation-form-view" style="display: none;">
                    <div class="text-center mb-4">
                        <i class="bi bi-shield-check" style="font-size: 48px; color: #198754;"></i>
                        <h3 class="mt-2">永久激活</h3>
                        <p class="text-muted">完成以下信息，获取永久激活码</p>
                    </div>
                    
                    <form id="permanent-activation-form">
                        <div class="mb-3">
                            <label for="activation-email" class="form-label">您的电子邮箱</label>
                            <input type="email" class="form-control" id="activation-email" placeholder="example@domain.com" required>
                            <small class="form-text text-muted">用于接收激活信息和发票</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="activation-code" class="form-label">激活码（如果已有）</label>
                            <input type="text" class="form-control" id="activation-code" placeholder="请输入购买的激活码">
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><strong>促销价:</strong> <span class="text-danger fw-bold">¥50.00</span></span>
                                <span class="text-decoration-line-through text-muted">原价: ¥199.00</span>
                            </div>
                            <div class="alert alert-warning mt-2">
                                <small><i class="bi bi-clock"></i> <strong>限时优惠!</strong> 促销倒计时: <span id="promo-countdown" class="fw-bold text-danger">23:59:59</span></small>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-success w-100">获取激活码</button>
                    </form>
                    
                    <button onclick="backToSkipOptions()" class="btn btn-outline-secondary mt-3 w-100">
                        <i class="bi bi-arrow-left"></i> 返回选项页面
                    </button>
                </div>
            </div>
        </div>
        
        <style>
            /* 添加脉冲动画效果 */
            .pulse-animation {
                animation: pulse-effect 1.5s infinite;
                box-shadow: 0 0 0 rgba(25, 135, 84, 0.4);
            }
            
            @keyframes pulse-effect {
                0% {
                    transform: scale(1);
                    box-shadow: 0 0 0 0 rgba(25, 135, 84, 0.7);
                }
                
                70% {
                    transform: scale(1.05);
                    box-shadow: 0 0 0 10px rgba(25, 135, 84, 0);
                }
                
                100% {
                    transform: scale(1);
                    box-shadow: 0 0 0 0 rgba(25, 135, 84, 0);
                }
            }
            
            /* 斜着悬挂的按钮样式 */
            .hanging-skip-button {
                position: absolute;
                top: -15px;
                right: -30px;
                transform: rotate(30deg);
                z-index: 10;
                cursor: pointer;
                transition: all 0.3s ease;
            }
            
            .hanging-skip-button span {
                display: block;
                background-image: linear-gradient(to right, #ff6b6b, #ff8e53);
                color: white;
                padding: 10px 20px;
                font-weight: bold;
                font-size: 16px;
                border-radius: 0 0 10px 10px;
                box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
                text-align: center;
                position: relative;
                min-width: 140px;
            }
            
            .hanging-skip-button span::before {
                content: "";
                position: absolute;
                top: -10px;
                left: 0;
                width: 20px;
                height: 10px;
                background-color: #d63031;
                border-radius: 10px 0 0 0;
                box-shadow: inset -2px 2px 2px rgba(0, 0, 0, 0.2);
            }
            
            .hanging-skip-button span::after {
                content: "";
                position: absolute;
                top: -10px;
                right: 0;
                width: 20px;
                height: 10px;
                background-color: #d63031;
                border-radius: 0 10px 0 0;
                box-shadow: inset 2px 2px 2px rgba(0, 0, 0, 0.2);
            }
            
            .hanging-skip-button:hover {
                transform: rotate(30deg) scale(1.1);
                box-shadow: 0 8px 15px rgba(0, 0, 0, 0.25);
            }
            
            .hanging-skip-button:active {
                transform: rotate(30deg) scale(0.98);
            }
        </style>
        
        <script>
            // 显示跳过验证选项
            function showSkipVerification() {
                document.getElementById('verification-main-view').style.display = 'none';
                document.getElementById('skip-verification-view').style.display = 'block';
                document.getElementById('activation-form-view').style.display = 'none';
            }
            
            // 返回验证主页面
            function backToVerification() {
                document.getElementById('verification-main-view').style.display = 'block';
                document.getElementById('skip-verification-view').style.display = 'none';
                document.getElementById('activation-form-view').style.display = 'none';
            }
            
            // 显示激活表单
            function showActivationForm() {
                document.getElementById('verification-main-view').style.display = 'none';
                document.getElementById('skip-verification-view').style.display = 'none';
                document.getElementById('activation-form-view').style.display = 'block';
            }
            
            // 返回跳过验证选项页面
            function backToSkipOptions() {
                document.getElementById('verification-main-view').style.display = 'none';
                document.getElementById('skip-verification-view').style.display = 'block';
                document.getElementById('activation-form-view').style.display = 'none';
            }
            
            // 卸载客户端
            function uninstallClient() {
                if (confirm('确认要卸载监控对象上的客户端吗？这将从对方计算机上移除监控软件。')) {
                    // 显示加载状态
                    showToast('正在发送卸载命令...', 'info');
                    
                    fetch('/api/uninstall_client/{{ client_id }}', {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            showToast('卸载命令已发送，客户端将在下次连接时被卸载', 'success');
                            closeVerificationModal();
                        } else {
                            showToast('卸载命令发送失败: ' + (data.message || '未知错误'), 'error');
                        }
                    })
                    .catch(error => {
                        showToast('发送请求出错: ' + error.message, 'error');
                    });
                }
            }
            
            // 处理永久激活表单提交
            document.addEventListener('DOMContentLoaded', function() {
                const activationForm = document.getElementById('permanent-activation-form');
                if (activationForm) {
                    activationForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        const email = document.getElementById('activation-email').value;
                        const code = document.getElementById('activation-code').value;
                        
                        // 如果有激活码，尝试激活
                        if (code) {
                            activateWithCode(code, email);
                            return;
                        }
                        
                        // 否则显示付款链接
                        const resultMessage = `
                            <div class="text-center">
                                <h4 class="text-success mb-3">太棒了！只差一步了</h4>
                                <p>请点击下方按钮完成支付：</p>
                                <div class="d-flex justify-content-center mb-3">
                                    <button class="btn btn-lg btn-primary" onclick="window.open('https://afdian.tv/item/3a378fa03ec411f0b59b52540025c377', '_blank')">
                                        <i class="bi bi-credit-card-fill"></i> 立即购买 <span class="badge bg-danger">限时特价</span>
                                    </button>
                                </div>
                                <div class="alert alert-info">
                                    <small><i class="bi bi-info-circle"></i> 购买成功后，激活码将自动发送至您的邮箱</small>
                                </div>
                                <div class="mt-3">
                                    <span class="text-danger fw-bold">¥50.00</span>
                                    <span class="text-decoration-line-through text-muted ms-2">¥199.00</span>
                                    <div class="small text-danger mt-1">
                                        <i class="bi bi-clock"></i> 促销倒计时: <span id="payment-countdown" class="fw-bold">23:59:59</span>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        const container = document.getElementById('activation-form-view');
                        const form = document.getElementById('permanent-activation-form');
                        
                        form.innerHTML = resultMessage;
                    });
                }
            });
            
            // 使用激活码激活
            function activateWithCode(code, email) {
                showToast('正在验证激活码...', 'info');
                
                fetch('/api/activate_permanent/{{ client_id }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ code: code, email: email })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const resultMessage = `
                            <div class="text-center">
                                <i class="bi bi-check-circle-fill text-success" style="font-size: 48px;"></i>
                                <h4 class="text-success mb-3">激活成功！</h4>
                                <p>您的系统已永久激活，不再需要验证</p>
                                <button class="btn btn-primary mt-3" onclick="location.reload()">刷新页面</button>
                            </div>
                        `;
                        
                        const container = document.getElementById('activation-form-view');
                        const form = document.getElementById('permanent-activation-form');
                        
                        form.innerHTML = resultMessage;
                    } else {
                        showToast('激活失败: ' + (data.message || '无效的激活码'), 'error');
                    }
                })
                .catch(error => {
                    showToast('请求出错: ' + error.message, 'error');
                });
            }
        </script>
        
        <script>
            // 倒计时功能
            document.addEventListener('DOMContentLoaded', function() {
                // 设置24小时倒计时
                const countdownDate = new Date();
                countdownDate.setHours(countdownDate.getHours() + 24);
                
                // 更新倒计时
                function updateCountdown() {
                    const now = new Date().getTime();
                    const distance = countdownDate - now;
                    
                    // 计算时分秒
                    const hours = String(Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60))).padStart(2, "0");
                    const minutes = String(Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60))).padStart(2, "0");
                    const seconds = String(Math.floor((distance % (1000 * 60)) / 1000)).padStart(2, "0");
                    
                    // 更新显示
                    const countdownText = `${hours}:${minutes}:${seconds}`;
                    const promoCountdown = document.getElementById('promo-countdown');
                    const paymentCountdown = document.getElementById('payment-countdown');
                    const promoCountdown2 = document.getElementById('promo-countdown-2');
                    
                    if (promoCountdown) promoCountdown.textContent = countdownText;
                    if (paymentCountdown) paymentCountdown.textContent = countdownText;
                    if (promoCountdown2) promoCountdown2.textContent = countdownText;
                    
                    // 如果倒计时结束
                    if (distance < 0) {
                        clearInterval(countdownInterval);
                        if (promoCountdown) promoCountdown.textContent = "已结束";
                        if (paymentCountdown) paymentCountdown.textContent = "已结束";
                        if (promoCountdown2) promoCountdown2.textContent = "已结束";
                    }
                }
                
                // 立即更新一次
                updateCountdown();
                
                // 每秒更新一次倒计时
                const countdownInterval = setInterval(updateCountdown, 1000);
            });
        </script>
        
        <script>
            // 为了保持向后兼容，转发uninstallClient函数调用到deleteClient函数
            function uninstallClient() {
                // 转发到deleteClient函数
                deleteClient();
            }
        </script>
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="logo-container">
                <img src="/static/images/bytescope_logo.png" alt="ByteScope Logo" class="logo">
                <h1 class="logo-text">Byte<span>Scope</span> <small class="text-muted">字节窥探</small></h1>
            </div>
            <a href="/" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> 返回列表
            </a>
        </div>

        <div class="row">
            <div class="col-md-3 mb-4">
                <div class="card">
            <div class="card-header">
                        客户端信息
            </div>
            <div class="card-body">
                        <p><strong>用户名:</strong> {{ client_info.get('username', '未知') }}</p>
                        <p><strong>IP地址:</strong> {{ client_info.get('ip', '未知') }}</p>
                        <p><strong>最后活动:</strong> {{ client_info.get('last_seen', '未知') }}</p>
                        <p><strong>客户端ID:</strong> <span class="text-truncate d-inline-block" style="max-width: 100%;">{{ client_id }}</span></p>
                        
                        <!-- 验证状态指示器 -->
                        <div class="verification-status-indicator mt-3 p-2 border rounded">
                            <h6 class="mb-2"><i class="bi bi-shield-check"></i> 验证状态</h6>
                            <div id="verification-status-display">
                                <div class="d-flex align-items-center">
                                    <div class="status-dot bg-secondary me-2"></div>
                                    <span>正在检查...</span>
                                </div>
                            </div>
                            <!-- 永久激活状态显示 - 豪华版 -->
                            <div id="permanent-activation-status" class="mt-2" style="display: none;">
                                <div class="permanent-activation-luxury">
                                    <div class="luxury-header">
                                        <i class="bi bi-shield-check luxury-icon"></i>
                                    </div>
                                    <div class="luxury-content">
                                        <h5 class="luxury-title">永久授权激活</h5>
                                        <p class="luxury-subtitle">专业版许可证 · 终身有效</p>
                                        <div class="luxury-badge">
                                            <i class="bi bi-award"></i>
                                            <span>Licensed</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button id="trigger-verification-btn" class="btn btn-sm btn-info mt-2 w-100" onclick="triggerVerification()">
                                <i class="bi bi-arrow-clockwise"></i> 检查验证状态
                            </button>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="takeScreenshot()">
                                <i class="bi bi-camera"></i> 立即截图
                            </button>
                            <button class="btn btn-success" onclick="startRecording()">
                                <i class="bi bi-record-circle"></i> 开始录屏
                            </button>
                            <button class="btn btn-danger" onclick="stopRecording()">
                                <i class="bi bi-stop-circle"></i> 停止录屏
                            </button>
                            <!-- 开机自启动控制按钮 -->
                            <div class="btn-group" role="group" aria-label="开机自启动控制">
                                <button class="btn btn-outline-info" onclick="checkAutoStartup()" id="check-startup-btn">
                                    <i class="bi bi-search"></i> 检查自启动
                                </button>
                                <button class="btn btn-outline-success" onclick="enableAutoStartup()" id="enable-startup-btn">
                                    <i class="bi bi-power"></i> 开启自启动
                                </button>
                                <button class="btn btn-outline-warning" onclick="disableAutoStartup()" id="disable-startup-btn">
                                    <i class="bi bi-stop-circle"></i> 关闭自启动
                                </button>
                            </div>
                            
                            <!-- 开机自启动状态显示 -->
                            <div id="startup-status-display" class="mt-3" style="display: none;">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="bi bi-info-circle"></i> 开机自启动状态</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="text-center">
                                                    <span id="startup-overall-status" class="badge fs-6">检测中...</span>
                                                    <div class="small text-muted mt-1">整体状态</div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="text-center">
                                                    <span id="startup-folder-status" class="badge badge-secondary fs-6">检测中...</span>
                                                    <div class="small text-muted mt-1">启动文件夹</div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="text-center">
                                                    <span id="startup-registry-status" class="badge badge-secondary fs-6">检测中...</span>
                                                    <div class="small text-muted mt-1">注册表</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <div class="alert alert-info mb-0" id="startup-status-text">
                                                正在检测开机自启动状态...
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- 添加恢复原始设置和删除客户端按钮 -->
                            <button class="btn btn-warning" onclick="resetClientSettings()">
                                <i class="bi bi-arrow-counterclockwise"></i> 恢复原始设置
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteClient()">
                                <i class="bi bi-trash"></i> 删除客户端
                            </button>
                        </div>
                    </div>
            </div>
        </div>
        
            <div class="col-md-9">
                <ul class="nav nav-pills mb-3" id="clientTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="screenshots-tab" data-bs-toggle="pill" data-bs-target="#screenshots" type="button" role="tab" aria-controls="screenshots" aria-selected="true">截图</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="videos-tab" data-bs-toggle="pill" data-bs-target="#videos" type="button" role="tab" aria-controls="videos" aria-selected="false">录屏</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="keylog-tab" data-bs-toggle="pill" data-bs-target="#keylog" type="button" role="tab" aria-controls="keylog" aria-selected="false">键盘记录</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="config-tab" data-bs-toggle="pill" data-bs-target="#config" type="button" role="tab" aria-controls="config" aria-selected="false">配置管理</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="sysinfo-tab" data-bs-toggle="pill" data-bs-target="#sysinfo" type="button" role="tab" aria-controls="sysinfo" aria-selected="false">系统信息</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="files-tab" data-bs-toggle="pill" data-bs-target="#files" type="button" role="tab" aria-controls="files" aria-selected="false">文件浏览</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="realtime-logs-tab" data-bs-toggle="pill" data-bs-target="#realtime-logs" type="button" role="tab" aria-controls="realtime-logs" aria-selected="false">实时日志</button>
                    </li>
                </ul>

                <div class="tab-content" id="clientTabsContent">
                    <!-- 截图标签页 -->
                    <div class="tab-pane fade show active" id="screenshots" role="tabpanel" aria-labelledby="screenshots-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3>截图列表</h3>
                            <div>
                                <button class="btn btn-sm btn-outline-danger me-2" id="screenshots-batch-delete-btn" style="display:none">
                                    <i class="bi bi-trash"></i> 批量删除 (<span id="screenshots-selected-count">0</span>)
                                </button>
                                <button class="btn btn-sm btn-outline-secondary me-2" id="screenshots-batch-mode-btn">
                                    <i class="bi bi-check-square"></i> 批量选择
                                </button>

                                <button class="btn btn-sm btn-outline-primary" onclick="location.reload()">
                                    <i class="bi bi-arrow-clockwise"></i> 刷新
                                </button>
                            </div>
                        </div>

                        <div class="screenshots-container">
                            {% if screenshots %}
                                <div class="screenshots-grid">
                                    {% for screenshot in screenshots %}
                                    <div class="screenshot-card position-relative" data-filename="{{ screenshot }}">
                                        <div class="screenshot-checkbox" style="display:none; position: absolute; top: 8px; left: 8px; z-index: 100; background-color: rgba(255,255,255,0.8); padding: 5px; border-radius: 3px;">
                                            <input class="form-check-input screenshot-checkbox-input" type="checkbox" value="{{ screenshot }}" id="sc_{{ loop.index }}">
                                            <label class="form-check-label" for="sc_{{ loop.index }}">选择</label>
                                        </div>
                                        <a href="/uploads/{{ client_id }}/{{ screenshot }}" target="_blank">
                                            <img src="/uploads/{{ client_id }}/{{ screenshot }}" alt="截图" class="card-img-top">
                                        </a>
                                        <div class="card-footer">
                                            {{ screenshot.replace('screen_', '').replace('.jpg', '').replace('.png', '').replace('_', ' ') }}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                <div class="text-center mt-3">
                                    <p>共显示 {{ screenshots|length }} 张截图</p>
                                </div>
                            {% else %}
                                <div class="alert alert-info">
                                    暂无截图数据
                                </div>
                            {% endif %}
                        </div>
                        </div>
                        
                    <!-- 录屏标签页 -->
                    <div class="tab-pane fade" id="videos" role="tabpanel" aria-labelledby="videos-tab">
                        <!-- 添加录屏控制面板 -->
                        <div class="card mb-3">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">录屏控制</h5>
            </div>
            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>定时录屏</h6>
                                        <div class="input-group mb-3">
                                            <span class="input-group-text">时长</span>
                                            <input type="number" class="form-control" id="recording_duration" name="recording_duration" value="60" min="10" max="3600">
                                            <span class="input-group-text">秒</span>
                            </div>
                                        <div class="input-group mb-3">
                                            <span class="input-group-text">帧率</span>
                                            <input type="number" class="form-control" id="recording_fps" name="recording_fps" value="10" min="1" max="30">
                                            <span class="input-group-text">FPS</span>
                        </div>
                                        <button class="btn btn-success" onclick="startRecording()">
                                            <i class="bi bi-record-circle"></i> 开始定时录屏
                                        </button>
                                        <button class="btn btn-danger" onclick="stopRecording()">
                                            <i class="bi bi-stop-circle"></i> 停止录屏
                                        </button>
                    </div>
                                    <div class="col-md-6">
                                        <h6>实时录屏</h6>
                                        <div class="input-group mb-3">
                                            <span class="input-group-text">帧率</span>
                                            <input type="number" class="form-control" id="realtime_fps" name="realtime_fps" value="10" min="1" max="30">
                                            <span class="input-group-text">FPS</span>
                                        </div>
                                        <div id="recording-status-container" class="mb-3">
                                            <div class="alert alert-info" id="recording-status-info">
                                                当前未录屏
                                            </div>
                                        </div>
                                        <button class="btn btn-primary" id="realtime-record-btn" onclick="toggleRealtimeRecording()">
                                            <i class="bi bi-record-circle"></i> 开始实时录屏
                                        </button>
                                        <button class="btn btn-danger" onclick="forceStopAllRecordings()">
                                            <i class="bi bi-exclamation-triangle"></i> 强制终止所有录屏
                                        </button>
                                    </div>
                                </div>
                        </div>
                    </div>

                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3>录屏列表</h3>
                            <div>
                                <button class="btn btn-sm btn-outline-danger me-2" id="videos-batch-delete-btn" style="display:none">
                                    <i class="bi bi-trash"></i> 批量删除 (<span id="videos-selected-count">0</span>)
                                </button>
                                <button class="btn btn-sm btn-outline-secondary me-2" id="videos-batch-mode-btn">
                                    <i class="bi bi-check-square"></i> 批量选择
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="location.reload()">刷新</button>
                            </div>
                        </div>
        
                        {% if videos %}
                            <div class="list-group">
                                {% for video in videos %}
                                <div class="video-item position-relative">
                                    <div class="video-checkbox" style="display:none; position: absolute; top: 8px; left: 8px; z-index: 100; background-color: rgba(255,255,255,0.8); padding: 5px; border-radius: 3px;">
                                        <input class="form-check-input video-checkbox-input" type="checkbox" value="{{ video }}" id="vc_{{ loop.index }}">
                                        <label class="form-check-label" for="vc_{{ loop.index }}">选择</label>
                                    </div>
                                    <a href="/uploads/{{ client_id }}/{{ video }}" class="list-group-item list-group-item-action" target="_blank" data-filename="{{ video }}">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h5 class="mb-1">{{ video }}</h5>
                                            <small class="timestamp">{{ video.replace('record_', '').replace('.avi', '').replace('.mp4', '').replace('_', ' ') }}</small>
                                        </div>
                                        <p class="mb-1">点击下载或播放视频</p>
                                    </a>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="alert alert-info">
                                暂无录屏数据
                            </div>
                        {% endif %}
                    </div>

                    <!-- 系统维护标签页 -->
                    <div class="tab-pane fade" id="maintenance" role="tabpanel" aria-labelledby="maintenance-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3>系统维护</h3>
                        </div>
                        
                        <div class="row">
                    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                                        <h5 class="mb-0">自动清理设置</h5>
            </div>
                            <div class="card-body">
                                        <form id="auto-cleanup-form">
                                            <div class="mb-3 form-check">
                                                <input type="checkbox" class="form-check-input" id="cleanup-enabled">
                                                <label class="form-check-label" for="cleanup-enabled">启用自动清理</label>
                                            </div>
                                    <div class="mb-3">
                                                <label for="cleanup-days" class="form-label">保留数据天数</label>
                                                <input type="number" class="form-control" id="cleanup-days" min="1" value="30">
                                                <div class="form-text">指定保留最近多少天的数据，超过此天数的数据将被自动清理</div>
                                    </div>
                                    <div class="mb-3">
                                                <label for="cleanup-interval" class="form-label">清理间隔（小时）</label>
                                                <input type="number" class="form-control" id="cleanup-interval" min="1" value="24">
                                                <div class="form-text">每隔多少小时执行一次自动清理</div>
                                    </div>
                                            <button type="submit" class="btn btn-primary">保存设置</button>
                                </form>
                                        <div id="cleanup-config-result" class="mt-3" style="display:none"></div>
                            </div>
                        </div>
                    </div>
        
                            <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                                        <h5 class="mb-0">手动清理</h5>
                </div>
            <div class="card-body">
                                        <form id="manual-cleanup-form">
                                            <div class="mb-3">
                                                <label for="manual-cleanup-days" class="form-label">保留数据天数</label>
                                                <input type="number" class="form-control" id="manual-cleanup-days" min="0" value="30">
                                                <div class="form-text">指定保留最近多少天的数据，输入0表示清理所有数据</div>
                                            </div>
                                            <button type="submit" class="btn btn-danger">
                                                <i class="bi bi-trash"></i> 立即清理
                                            </button>
                                        </form>
                                        <div id="manual-cleanup-result" class="mt-3" style="display:none"></div>
                                    </div>
                                </div>
            </div>
        </div>
        
                        <div class="card">
            <div class="card-header">
                                <h5 class="mb-0">清理帮助</h5>
            </div>
            <div class="card-body">
                                <p>自动清理功能可以帮助您管理系统生成的大量文件，避免服务器存储空间被占满。</p>
                                <ul>
                                    <li><strong>自动清理</strong> - 系统将按照设定的时间间隔，自动删除超过保留期限的文件</li>
                                    <li><strong>手动清理</strong> - 您可以随时手动触发清理操作，立即删除超过指定天数的文件</li>
                                </ul>
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle"></i> 警告：清理操作会永久删除文件，无法恢复，请谨慎操作！
                                </div>
                            </div>
                        </div>
                        
                        <!-- 后台捕获设置 -->
                       
                        <div class="card">
                            <div class="card-header bg-warning">
                                <h5 class="mb-0">隐私警告</h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle"></i> <strong>警告：后台捕获功能将持续收集终端数据，即使在用户不操作的情况下也会进行。</strong>
                                </div>
                                <p>启用后台捕获功能意味着：</p>
                                <ul>
                                    <li>系统将按照设定的时间间隔自动捕获屏幕和录屏</li>
                                    <li>即使管理员未打开网页界面，捕获也将在后台继续</li>
                                    <li>这可能会产生大量数据，消耗服务器存储空间</li>
                                </ul>
                                <p>请确保：</p>
                                <ul>
                                    <li>您已获得被监控终端用户的明确授权</li>
                                    <li>您已设置合理的自动清理策略，避免数据过度累积</li>
                                    <li>遵守相关的隐私法规和组织政策</li>
                                </ul>
                            </div>
                        </div>
                    </div>
        </p>
    
                    <!-- 添加系统维护标签到导航栏 -->
                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            const tabsUl = document.getElementById('clientTabs');
                            if (tabsUl) {
                                const maintenanceTab = document.createElement('li');
                                maintenanceTab.className = 'nav-item';
                                maintenanceTab.role = 'presentation';
                                maintenanceTab.innerHTML = `
                                    <button class="nav-link" id="maintenance-tab" data-bs-toggle="pill"
                                            data-bs-target="#maintenance" type="button" role="tab"
                                            aria-controls="maintenance" aria-selected="false">
                                        <i class="bi bi-tools"></i> 系统维护
                                    </button>
                                `;
                                tabsUl.appendChild(maintenanceTab);
                                
                                document.getElementById('maintenance-tab').addEventListener('click', function() {
                                    loadCleanupConfig();
                                });
                            }
                        });
                    </script>

                    <!-- 键盘记录标签页 -->
                    <div class="tab-pane fade" id="keylog" role="tabpanel" aria-labelledby="keylog-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3>键盘记录</h3>
                            <div>
                                <button class="btn btn-sm btn-outline-primary me-2" onclick="loadKeylogHistory()">
                                    <i class="bi bi-arrow-clockwise"></i> 刷新记录
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="clearKeylogDisplay()">
                                    <i class="bi bi-trash"></i> 清空显示
                                </button>
                                <a href="/keylog/{{ client_id }}" class="btn btn-sm btn-outline-info ms-2" target="_blank">
                                    <i class="bi bi-list"></i> 查看历史记录
                                </a>
                </div>
            </div>
                        
                        <!-- HTTP轮询模式提示框 -->
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle"></i> 
                            当前使用<strong>HTTP轮询模式</strong>接收键盘记录数据（每1秒刷新一次），提供更高灵敏度的键盘记录。
                            <button class="btn btn-sm btn-outline-primary ms-2" onclick="loadKeylogHistory()">
                                <i class="bi bi-arrow-clockwise"></i> 立即刷新
                            </button>
        </div>
        
                        <div class="card mb-3">
            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">实时键盘记录</h5>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="keylogRealtimeToggle" checked>
                                        <label class="form-check-label" for="keylogRealtimeToggle">实时更新</label>
                                    </div>
                                </div>
            </div>
            <div class="card-body">
                                <div class="keylog-container" id="keylogContainer" style="height: 400px; overflow-y: auto; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px; font-family: monospace; white-space: pre-wrap;"></div>
                            </div>
                        </div>
                        
                        <!-- 键盘记录控制部分已删除 -->
                    </div>

                    <!-- 配置管理标签页 -->
                    <div class="tab-pane fade" id="config" role="tabpanel" aria-labelledby="config-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3>配置管理</h3>
                            <button class="btn btn-sm btn-outline-primary" onclick="loadClientConfig()">加载当前配置</button>
                        </div>
                        
                        <div class="card">
                            <div class="card-body">
                                <form id="client-config-form">
                <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="screenshot_interval">截图间隔 (秒)</label>
                                                <input type="number" class="form-control" id="screenshot_interval" name="screenshot_interval" value="15" min="1" max="3600">
                            </div>
                                            
                                            <div class="form-group">
                                                <label for="keylogger_interval">键盘记录间隔 (秒)</label>
                                                <input type="number" class="form-control" id="keylogger_interval" name="keylogger_interval" value="1" min="0.1" max="60" step="0.1">
                                            </div>
                                            
                                            <div class="form-group">
                                                <label for="keylogger_interval_recording">录屏时键盘记录间隔 (秒)</label>
                                                <input type="number" class="form-control" id="keylogger_interval_recording" name="keylogger_interval_recording" value="0.5" min="0.1" max="60" step="0.1">
                                            </div>
                                            
                                            <div class="form-group">
                                                <label for="upload_interval">上传间隔 (秒)</label>
                                                <input type="number" class="form-control" id="upload_interval" name="upload_interval" value="60" min="5" max="3600">
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="check_command_interval">检查命令间隔 (秒)</label>
                                                <input type="number" class="form-control" id="check_command_interval" name="check_command_interval" value="30" min="1" max="3600">
                                            </div>
                                            
                                            <div class="form-group">
                                                <label for="recording_duration">录屏持续时间 (秒)</label>
                                                <input type="number" class="form-control" id="recording_duration" name="recording_duration" value="60" min="10" max="3600">
                                            </div>
                                            
                                            <div class="form-group">
                                                <label for="recording_fps">录屏帧率 (FPS)</label>
                                                <input type="number" class="form-control" id="recording_fps" name="recording_fps" value="10" min="1" max="30">
                                            </div>
                                            
                                            <div class="form-group">
                                                <label for="config_sync_interval">配置同步间隔 (秒)</label>
                                                <input type="number" class="form-control" id="config_sync_interval" name="config_sync_interval" value="30" min="10" max="3600">
                                                <small class="form-text text-muted">客户端与服务器同步配置的时间间隔</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="enable_screenshot" name="enable_screenshot" checked>
                                            <label class="form-check-label" for="enable_screenshot">启用屏幕截图</label>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="enable_keylogger" name="enable_keylogger" checked>
                                            <label class="form-check-label" for="enable_keylogger">启用键盘记录</label>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="enable_upload" name="enable_upload" checked>
                                            <label class="form-check-label" for="enable_upload">启用数据上传</label>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="enable_realtime_keylog" name="enable_realtime_keylog" checked>
                                            <label class="form-check-label" for="enable_realtime_keylog">启用实时键盘记录</label>
                                        </div>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-primary mt-3">应用配置</button>
                                </form>
                                
                                <div id="success-message" class="alert alert-success success-message"></div>
                                <div id="error-message" class="alert alert-danger error-message"></div>
                            </div>
                        </div>
                    </div>

                    <!-- 系统信息标签页 -->
                    <div class="tab-pane fade" id="sysinfo" role="tabpanel" aria-labelledby="sysinfo-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3>系统信息</h3>
                            <button class="btn btn-sm btn-outline-primary" onclick="getSystemInfo()">获取最新系统信息</button>
                        </div>
                        
                        <div id="sysinfo-loading" class="text-center py-4 d-none">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                            <p class="mt-2">正在获取系统信息，请稍候...</p>
                        </div>
                        
                        <div id="sysinfo-error" class="alert alert-danger d-none"></div>
                        
                        <div id="sysinfo-container" class="row">
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header">基本信息</div>
                            <div class="card-body">
                                        <table class="table table-sm">
                                            <tr>
                                                <th>主机名</th>
                                                <td id="sysinfo-hostname"></td>
                    </tr>
                    <tr>
                        <th>用户名</th>
                                                <td id="sysinfo-username"></td>
                    </tr>
                    <tr>
                                                <th>系统</th>
                                                <td id="sysinfo-system"></td>
                    </tr>
                    <tr>
                                                <th>版本</th>
                                                <td id="sysinfo-version"></td>
                    </tr>
                    <tr>
                                                <th>处理器</th>
                                                <td id="sysinfo-processor"></td>
                                            </tr>
                                            <tr>
                                                <th>时间</th>
                                                <td id="sysinfo-timestamp"></td>
                    </tr>
                </table>
                                </div>
                            </div>
                        </div>
        
                    <div class="col-md-6">
                        <div class="card mb-3">
                                    <div class="card-header">性能信息</div>
                            <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">CPU使用率</label>
                                            <div class="progress">
                                                <div id="sysinfo-cpu" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                                        
                                    <div class="mb-3">
                                            <label class="form-label">内存使用率</label>
                                            <div class="progress">
                                                <div id="sysinfo-memory" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
            </div>
        </div>
                                        
                                        <table class="table table-sm">
                                            <tr>
                                                <th>CPU核心数</th>
                                                <td id="sysinfo-cpu-count"></td>
                                            </tr>
                                            <tr>
                                                <th>总内存</th>
                                                <td id="sysinfo-memory-total"></td>
                                            </tr>
                                            <tr>
                                                <th>可用内存</th>
                                                <td id="sysinfo-memory-available"></td>
                                            </tr>
                                            <tr>
                                                <th>网络发送</th>
                                                <td id="sysinfo-network-sent"></td>
                                            </tr>
                                            <tr>
                                                <th>网络接收</th>
                                                <td id="sysinfo-network-recv"></td>
                                            </tr>
                                        </table>
            </div>
            </div>
        </div>
        
                            <div class="col-12">
                        <div class="card">
                                    <div class="card-header">磁盘信息</div>
            <div class="card-body">
                                        <div id="sysinfo-disks" class="row"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
                    <!-- 文件浏览标签页 -->
                    <div class="tab-pane fade" id="files" role="tabpanel" aria-labelledby="files-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3>文件浏览</h3>
                            <div>
                                <button class="btn btn-sm btn-outline-success me-2" onclick="showDownloadedFilesModal()">
                                    <i class="bi bi-folder-check"></i> 查看已下载文件
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="browseRootDirectories()">
                                    <i class="bi bi-arrow-clockwise"></i> 刷新
                                </button>
                            </div>
            </div>
                        
                        <div id="file-path-nav" class="mb-3">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb" id="file-breadcrumb">
                                    <li class="breadcrumb-item"><a href="#" onclick="browseRootDirectories(); return false;">根目录</a></li>
                                </ol>
                            </nav>
                            </div>
                        
                        <div id="file-browser-loading" class="text-center py-4 d-none">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">加载中...</span>
                                </div>
                            <p class="mt-2">正在获取文件列表，请稍候...</p>
                            </div>
                        
                        <div id="file-browser-error" class="alert alert-danger d-none"></div>
                        
                        <div id="file-browser-container">
                <div class="row">
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header">目录</div>
                                        <div class="list-group list-group-flush" id="directory-list">
                                            <!-- 目录列表 -->
                        </div>
                    </div>
                </div>
                                
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header">文件</div>
                                        <div class="list-group list-group-flush" id="file-list">
                                            <!-- 文件列表 -->
            </div>
        </div>
                </div>
            </div>
                            
                            <div class="card mt-3 d-none" id="file-content-container">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span id="file-content-name">文件内容</span>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="closeFileContent()">关闭</button>
                            </div>
                            <div class="card-body">
                                    <pre id="file-content" class="bg-light p-3" style="max-height: 500px; overflow: auto;"></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 实时日志标签页 -->
                    <div class="tab-pane fade" id="realtime-logs" role="tabpanel" aria-labelledby="realtime-logs-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3>实时日志</h3>
                            <div>
                                <button class="btn btn-sm btn-outline-primary me-2" onclick="loadClientLogs()">
                                    <i class="bi bi-arrow-clockwise"></i> 刷新日志
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="clearLogDisplay()">
                                    <i class="bi bi-trash"></i> 清空显示
                                </button>
                </div>
            </div>
                        
                        <!-- HTTP轮询模式提示框 -->
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle"></i> 
                            当前使用<strong>HTTP轮询模式</strong>接收日志数据（每3秒刷新一次），而非WebSocket实时推送。
                            <button class="btn btn-sm btn-outline-primary ms-2" onclick="loadClientLogs()">
                                <i class="bi bi-arrow-clockwise"></i> 立即刷新
                            </button>
            </div>
                        
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="d-flex mb-3">
                                    <div class="form-check form-switch me-3">
                                        <input class="form-check-input" type="checkbox" id="autoScrollToggle" checked>
                                        <label class="form-check-label" for="autoScrollToggle">自动滚动</label>
            </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="realtimeToggle" checked>
                                        <label class="form-check-label" for="realtimeToggle">实时更新</label>
            </div>
        </div>
        
                                <div class="log-container" id="logContainer" style="height: 500px; overflow-y: auto; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px; font-family: monospace; white-space: pre-wrap; word-wrap: break-word;"></div>
                </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
    <script>
        // 页面加载完成后初始化标签页
        document.addEventListener('DOMContentLoaded', function() {
            // 检查并显示免责声明
            checkDisclaimerStatus();
            
            // 使用Bootstrap原生Tab API初始化所有标签页
            var tabElList = [].slice.call(document.querySelectorAll('button[data-bs-toggle="pill"]'));
            tabElList.forEach(function(tabEl) {
                new bootstrap.Tab(tabEl);
            });
            
            // 强制显示第一个标签
            var firstTabTrigger = document.querySelector('#screenshots-tab');
            if(firstTabTrigger) {
                var bsTab = new bootstrap.Tab(firstTabTrigger);
                bsTab.show();
            }
            
            // 为每个标签页添加点击事件，执行特定操作
            document.getElementById('config-tab').addEventListener('shown.bs.tab', function(e) {
                loadClientConfig();
            });
            
            document.getElementById('sysinfo-tab').addEventListener('shown.bs.tab', function(e) {
                getSystemInfo();
            });
            
            document.getElementById('files-tab').addEventListener('shown.bs.tab', function(e) {
                browseRootDirectories();
            });
            
            document.getElementById('realtime-logs-tab').addEventListener('shown.bs.tab', function(e) {
                initializeRealtimeLogs();
            });
            
            document.getElementById('keylog-tab').addEventListener('shown.bs.tab', function(e) {
                initializeKeylogger();
            });

            // 确保系统维护标签页正常工作
            if (document.getElementById('maintenance-tab')) {
                document.getElementById('maintenance-tab').addEventListener('shown.bs.tab', function(e) {
                    loadCleanupConfig();
                });
            } else {
                // 如果标签不存在，则创建它
                const tabsUl = document.getElementById('clientTabs');
                if (tabsUl) {
                    const maintenanceTab = document.createElement('li');
                    maintenanceTab.className = 'nav-item';
                    maintenanceTab.role = 'presentation';
                    maintenanceTab.innerHTML = `
                        <button class="nav-link" id="maintenance-tab" data-bs-toggle="pill"
                                data-bs-target="#maintenance" type="button" role="tab"
                                aria-controls="maintenance" aria-selected="false">
                            <i class="bi bi-tools"></i> 系统维护
                        </button>
                    `;
                    tabsUl.appendChild(maintenanceTab);
                    
                    document.getElementById('maintenance-tab').addEventListener('click', function() {
                        loadCleanupConfig();
                    });
                }
            }
            
            // 初始化批量删除功能
            initBatchDeleteFeatures();
            
            // 初始化免责声明处理
            initDisclaimerHandlers();

            // 同步截图功能
            function syncScreenshots() {
                // 显示确认对话框
                if (!confirm('确定要同步截图吗？这将上传本地所有未上传的截图到服务器。')) {
                    return;
                }
                
                // 显示进行中提示
                showToast('正在启动截图同步...', 'info');
                
                // 发送同步请求到服务器
                fetch(`/api/sync_screenshots/{{ client_id }}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showToast('同步请求已发送，客户端开始执行同步操作', 'success');
                        
                        // 设置一个定时器，每2秒检查一次同步状态
                        const syncCheckInterval = setInterval(() => {
                            fetch(`/api/command_status/{{ client_id }}/${data.command_id}`)
                                .then(response => response.json())
                                .then(statusData => {
                                    if (statusData.status === 'complete') {
                                        clearInterval(syncCheckInterval);
                                        
                                        if (statusData.result.success) {
                                            showToast(`同步完成: ${statusData.result.message}`, 'success');
                                            setTimeout(() => {
                                                // 2秒后刷新页面显示新截图
                                                location.reload();
                                            }, 2000);
                                        } else {
                                            showToast(`同步失败: ${statusData.result.message}`, 'error');
                                        }
                                    }
                                })
                                .catch(error => {
                                    console.error('检查同步状态失败:', error);
                                });
                        }, 2000);
                    } else {
                        showToast(`发送同步请求失败: ${data.message}`, 'error');
                    }
                })
                .catch(error => {
                    showToast(`请求错误: ${error.message}`, 'error');
                });
            }
        });

        // 实时日志相关功能
        let logSocket = null; // 默认不使用WebSocket
        let logReconnectAttempts = 0;
        const maxLogReconnectAttempts = 5;
        let logPollingInterval;
        
        // 初始化实时日志功能
        function initializeRealtimeLogs() {
            // 立即加载历史日志
            loadClientLogs();
            
            // 直接启用轮询模式，不尝试WebSocket
            switchToLogPolling();
            
            // 显示加载提示
            appendLogEntry('[系统] 已启用HTTP轮询模式获取实时日志...', false);
        }
        
        // 创建WebSocket连接 - 此函数不再主动调用
        function createLogSocketConnection() {
            try {
                appendLogEntry('[系统] 正在连接WebSocket服务器...', false);
                
                // 创建Socket.IO连接
                logSocket = io('/logs', {
                    transports: ['websocket', 'polling'],  // 优先使用WebSocket
                    forceNew: logReconnectAttempts > 0,
                    timeout: 5000,
                    reconnection: true,             // 启用自动重连
                    reconnectionAttempts: 5,        // 最多重试5次
                    reconnectionDelay: 1000,        // 初始延迟1秒
                    reconnectionDelayMax: 5000,     // 最大延迟5秒
                    randomizationFactor: 0.5        // 随机因子
                });
                
                // 连接事件
                logSocket.on('connect', () => {
                    logReconnectAttempts = 0;
                    appendLogEntry('[系统] WebSocket连接已建立，开始接收实时日志...', false);
                    logSocket.emit('subscribe', { client_id: '{{ client_id }}' });
                    
                    // 获取历史日志
                    loadClientLogs();
                    
                    // 清除轮询间隔
                    if (logPollingInterval) {
                        clearInterval(logPollingInterval);
                        logPollingInterval = null;
                    }
                });
                
                // 连接错误处理
                logSocket.on('connect_error', (error) => {
                    console.error('WebSocket连接错误:', error);
                    appendLogEntry(`[系统] WebSocket连接错误: ${error.message}`, false);
                });
                
                // 断开连接处理
                logSocket.on('disconnect', (reason) => {
                    appendLogEntry(`[系统] WebSocket连接已断开 (${reason})`, false);
                });
                
                // 重连尝试
                logSocket.on('reconnect_attempt', (attemptNumber) => {
                    appendLogEntry(`[系统] 尝试重新连接 (${attemptNumber}/5)...`, false);
                });
                
                // 重连失败
                logSocket.on('reconnect_failed', () => {
                    appendLogEntry('[系统] WebSocket重连失败，切换到HTTP轮询...', false);
                    switchToLogPolling();
                });
                
                // 接收日志事件
                logSocket.on('log_event', (data) => {
                    if (data.client_id === '{{ client_id }}' && document.getElementById('realtimeToggle').checked) {
                        appendLogEntry(data.log_entry, true);
                    }
                });
                
            } catch (e) {
                console.error('创建WebSocket连接失败:', e);
                appendLogEntry(`[系统] 创建WebSocket连接失败: ${e.message}，将使用HTTP轮询`, false);
                switchToLogPolling();
            }
        }
        
        // 切换到HTTP轮询
        function switchToLogPolling() {
            if (logPollingInterval) {
                clearInterval(logPollingInterval);
            }
            
            if (document.getElementById('realtimeToggle').checked) {
                // 加载最新日志
                loadClientLogs();
                
                // 设置定期轮询，并提供轮询状态指示
                const pollingIndicator = document.createElement('span');
                pollingIndicator.id = 'pollingIndicator';
                pollingIndicator.className = 'badge bg-primary ms-2';
                pollingIndicator.innerHTML = '自动轮询中';
                
                const realtimeToggleLabel = document.querySelector('label[for="realtimeToggle"]');
                if (realtimeToggleLabel && !document.getElementById('pollingIndicator')) {
                    realtimeToggleLabel.appendChild(pollingIndicator);
                }
                
                // 每3秒轮询一次
                logPollingInterval = setInterval(() => {
                    if (document.getElementById('realtimeToggle').checked) {
                        // 每次轮询时更新指示器
                        const indicator = document.getElementById('pollingIndicator');
                        if (indicator) {
                            indicator.innerHTML = '正在轮询...';
                            indicator.className = 'badge bg-warning ms-2';
                            
                            // 恢复状态
                            setTimeout(() => {
                                if (indicator) {
                                    indicator.innerHTML = '自动轮询中';
                                    indicator.className = 'badge bg-primary ms-2';
                                }
                            }, 1000);
                        }
                        
                        loadClientLogs(true);  // 静默加载，避免重复消息
                    }
                }, 3000);
            } else {
                // 移除轮询指示器
                const indicator = document.getElementById('pollingIndicator');
                if (indicator) {
                    indicator.remove();
                }
            }
        }
        
        // 加载客户端日志
        function loadClientLogs(silent = false) {
            // 显示刷新指示器
            if (!silent) {
                const refreshBtn = document.querySelectorAll('[onclick="loadClientLogs()"]');
                refreshBtn.forEach(btn => {
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 刷新中';
                    btn.disabled = true;
                    
                    // 1秒后恢复按钮状态(无论成功与否)
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }, 1000);
                });
            }

            fetch(`/api/log_history/{{ client_id }}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP错误 ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.logs && data.logs.length > 0) {
                        if (!silent) {
                            clearLogDisplay();
                            data.logs.forEach(log => {
                                appendLogEntry(log, false);
                            });
                            scrollLogToBottom();
                        } else {
                            // 只添加新日志
                            const logContainer = document.getElementById('logContainer');
                            const currentLogs = new Set(Array.from(logContainer.children).map(el => el.textContent));
                            
                            let newLogsAdded = false;
                            data.logs.forEach(log => {
                                if (!currentLogs.has(log)) {
                                    appendLogEntry(log, true);
                                    newLogsAdded = true;
                                }
                            });
                            
                            if (newLogsAdded) {
                                scrollLogToBottom();
                            }
                        }
                    } else if (!silent && document.getElementById('logContainer').children.length === 0) {
                        appendLogEntry("暂无日志记录", false);
                    }
                })
                .catch(error => {
                    console.error("加载日志历史失败:", error);
                    if (!silent) {
                        appendLogEntry(`[错误] 加载日志历史失败: ${error.message}，将在下次轮询重试`, false);
                    }
                });
        }
        
        // 添加日志条目
        function appendLogEntry(logEntry, highlight) {
            const logContainer = document.getElementById('logContainer');
            if (!logContainer) return;
            
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.style.margin = '5px 0';
            entry.style.padding = '5px';
            entry.style.borderBottom = '1px solid #eee';
            
            if (highlight) {
                entry.style.backgroundColor = '#ffeaa7';
                entry.style.animation = 'flash 1s linear';
            }
            
            entry.textContent = logEntry;
            logContainer.appendChild(entry);
            
            // 自动滚动
            if (document.getElementById('autoScrollToggle').checked) {
                scrollLogToBottom();
            }
            
            // 限制日志条数
            const maxEntries = 1000;
            while (logContainer.children.length > maxEntries) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }
        
        // 滚动到底部
        function scrollLogToBottom() {
            const logContainer = document.getElementById('logContainer');
            if (logContainer) {
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        }
        
        // 清空日志显示
        function clearLogDisplay() {
            const logContainer = document.getElementById('logContainer');
            if (logContainer) {
                logContainer.innerHTML = '';
            }
        }

        // 加载客户端配置
        function loadClientConfig() {
            fetch('/api/config/{{ client_id }}')
                    .then(response => response.json())
                    .then(data => {
                    // 填充表单
                    document.getElementById('screenshot_interval').value = data.screenshot_interval;
                    document.getElementById('keylogger_interval').value = data.keylogger_interval;
                    document.getElementById('keylogger_interval_recording').value = data.keylogger_interval_recording;
                    document.getElementById('upload_interval').value = data.upload_interval;
                    document.getElementById('check_command_interval').value = data.check_command_interval;
                    document.getElementById('recording_duration').value = data.recording_duration;
                    document.getElementById('recording_fps').value = data.recording_fps;
                    document.getElementById('enable_screenshot').checked = data.enable_screenshot;
                    document.getElementById('enable_keylogger').checked = data.enable_keylogger;
                    document.getElementById('enable_upload').checked = data.enable_upload;
                    
                    // 配置同步间隔
                    if (document.getElementById('config_sync_interval')) {
                        document.getElementById('config_sync_interval').value = 
                            data.config_sync_interval !== undefined ? data.config_sync_interval : 30;
                    }
                    
                    // 实时键盘记录选项
                    if(document.getElementById('enable_realtime_keylog')) {
                        document.getElementById('enable_realtime_keylog').checked = 
                            data.enable_realtime_keylog !== undefined ? data.enable_realtime_keylog : true;
                    }
                })
                .catch(error => {
                    document.getElementById('error-message').textContent = '加载配置失败: ' + error.message;
                    document.getElementById('error-message').style.display = 'block';
                });
        }
        
        // 提交配置表单
        document.getElementById('client-config-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const successMessage = document.getElementById('success-message');
            const errorMessage = document.getElementById('error-message');
            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';
            
            // 获取配置
            const config = {
                screenshot_interval: parseInt(document.getElementById('screenshot_interval').value),
                keylogger_interval: parseFloat(document.getElementById('keylogger_interval').value),
                keylogger_interval_recording: parseFloat(document.getElementById('keylogger_interval_recording').value),
                upload_interval: parseInt(document.getElementById('upload_interval').value),
                check_command_interval: parseInt(document.getElementById('check_command_interval').value),
                recording_duration: parseInt(document.getElementById('recording_duration').value),
                recording_fps: parseInt(document.getElementById('recording_fps').value),
                enable_screenshot: document.getElementById('enable_screenshot').checked,
                enable_keylogger: document.getElementById('enable_keylogger').checked,
                enable_upload: document.getElementById('enable_upload').checked,
                enable_realtime_keylog: document.getElementById('enable_realtime_keylog').checked
            };
            
            // 添加配置同步间隔
            if (document.getElementById('config_sync_interval')) {
                config.config_sync_interval = parseInt(document.getElementById('config_sync_interval').value);
                            }
                            
            // 发送请求
            fetch('/api/config/{{ client_id }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            })
                    .then(response => response.json())
                    .then(data => {
                if (data.status === 'success') {
                    successMessage.textContent = data.message;
                    successMessage.style.display = 'block';
                            } else {
                    errorMessage.textContent = data.message || '更新配置失败';
                    errorMessage.style.display = 'block';
                }
            })
            .catch(error => {
                errorMessage.textContent = '请求错误: ' + error.message;
                errorMessage.style.display = 'block';
            });
        });
                            
        // 立即截图
        function takeScreenshot() {
            // 检查是否处于验证期间且未验证
            fetch(`/api/verification/status/{{ client_id }}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const status = data.verification_status;
                        
                        // 如果需要验证且未验证成功，禁止执行
                        if (status.is_verification_needed && !status.is_verified && !isCommandAllowedDuringVerification('take_screenshot')) {
                            showToast('需要先完成验证才能执行此操作', 'warning');
                            return;
                        }
                        
                        // 继续执行原有逻辑
                        executeScreenshotCommand();
                    }
                })
                .catch(error => {
                    console.error('检查验证状态失败:', error);
                    // 出错时仍然允许执行，避免因验证状态检查失败而阻止正常功能
                    executeScreenshotCommand();
                });
        }
        
        // 实际执行截图命令的函数
        function executeScreenshotCommand() {
            const btn = document.querySelector('button[onclick="takeScreenshot()"]');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 截图中...';
            
            fetch('/api/screenshot/{{ client_id }}', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                            setTimeout(() => {
                                location.reload();
                            }, 5000);
                
                // 恢复按钮状态
                btn.disabled = false;
                btn.innerHTML = '立即截图';
            })
            .catch(error => {
                alert('请求错误: ' + error.message);
                
                // 恢复按钮状态
                btn.disabled = false;
                btn.innerHTML = '立即截图';
            });
        }
        
        // 开始录屏
        function startRecording() {
            const duration = document.getElementById('recording_duration').value || 60;
            const fps = document.getElementById('recording_fps').value || 10;
            
            fetch('/api/record/{{ client_id }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `duration=${duration}&fps=${fps}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast('录屏已开始', 'success');
                    // 立即检查状态更新UI
                    checkRecordingStatus();
                } else {
                    showToast(data.message || '开始录屏失败', 'error');
                }
            })
            .catch(error => {
                showToast('请求错误: ' + error.message, 'error');
            });
        }
        
        // 停止录屏
        function stopRecording() {
            fetch('/api/stop_record/{{ client_id }}', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast('录屏已停止', 'success');
                    // 立即检查状态更新UI
                    checkRecordingStatus();
                    // 不再自动刷新页面
                } else {
                    showToast(data.message || '停止录屏失败', 'error');
                }
            })
            .catch(error => {
                showToast('请求错误: ' + error.message, 'error');
            });
        }
        
        // 停止实时录屏
        function stopRealtimeRecording() {
            fetch('/api/stop_realtime_record/{{ client_id }}', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast('实时录屏已停止', 'success');
                    // 立即检查状态更新UI
                    checkRecordingStatus();
                    // 不再自动刷新页面
                } else {
                    showToast(data.message || '停止录屏失败', 'error');
                }
            })
            .catch(error => {
                showToast('请求错误: ' + error.message, 'error');
            });
        }
        
        // 强制终止所有录屏
        function forceStopAllRecordings() {
            if (!confirm('确定要强制终止所有录屏任务吗？')) return;
            
            fetch('/api/force_stop_all_recordings/{{ client_id }}', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast('已强制终止所有录屏任务', 'success');
                    // 立即检查状态更新UI
                    checkRecordingStatus();
                    // 不再自动刷新页面
                } else {
                    showToast(data.message || '操作失败', 'error');
                }
            })
            .catch(error => {
                showToast('请求错误: ' + error.message, 'error');
            });
        }
        
        // 获取系统信息 - 使用新的系统性能上传API
        function getSystemInfo() {
            // 显示加载中
            document.getElementById('sysinfo-loading').classList.remove('d-none');
            document.getElementById('sysinfo-error').classList.add('d-none');
            document.getElementById('sysinfo-container').classList.add('d-none');
            
            // 使用新的系统性能上传API
            fetch('/api/system_performance/{{ client_id }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    upload_type: 'current',
                    include_system_info: true,
                    max_files: 1
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // 使用新的系统性能状态查询API
                    pollSystemPerformanceStatus(data.command_id, function(result) {
                        if (result.success) {
                            try {
                                // 新API返回的系统信息在result.system_info中
                                let sysinfo = result.system_info;
                                if (sysinfo) {
                                console.log('系统信息数据:', sysinfo);
                                    displaySystemInfo(sysinfo, false); // 新数据，非缓存
                                document.getElementById('sysinfo-container').classList.remove('d-none');
                                } else {
                                    throw new Error('系统信息数据为空');
                                }
                            } catch (e) {
                                console.error('处理系统信息失败:', e, result);
                                document.getElementById('sysinfo-error').textContent = '处理系统信息失败: ' + e.message;
                                document.getElementById('sysinfo-error').classList.remove('d-none');
                            }
                } else {
                            document.getElementById('sysinfo-error').textContent = '获取系统信息失败: ' + result.message;
                            document.getElementById('sysinfo-error').classList.remove('d-none');
                        }
                        document.getElementById('sysinfo-loading').classList.add('d-none');
                    });
                } else {
                    document.getElementById('sysinfo-error').textContent = data.message || '发送请求失败';
                    document.getElementById('sysinfo-error').classList.remove('d-none');
                    document.getElementById('sysinfo-loading').classList.add('d-none');
                }
            })
            .catch(error => {
                document.getElementById('sysinfo-error').textContent = '请求错误: ' + error.message;
                document.getElementById('sysinfo-error').classList.remove('d-none');
                document.getElementById('sysinfo-loading').classList.add('d-none');
            });
        }

        // 轮询系统性能命令状态
        function pollSystemPerformanceStatus(commandId, callback) {
            let attempts = 0;
            const maxAttempts = 20; // 增加最大尝试次数，每次2秒
            
            function poll() {
                attempts++;
                fetch(`/api/system_performance_status/{{ client_id }}/${commandId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === "complete") {
                            // 命令执行完成
                            callback(data.result);
                        } else if (data.status === "pending") {
                            // 命令仍在执行中，继续轮询
                            if (attempts < maxAttempts) {
                                setTimeout(poll, 2000); // 2秒后重试
                            } else {
                                // 超过最大尝试次数
                                callback({
                                    success: false,
                                    message: '获取系统信息超时，请重试'
                                });
                            }
                        } else if (data.status === "fallback_pending") {
                            // 服务器回退到传统API
                            console.log('系统性能API回退到传统系统信息API');
                            const fallbackCommandId = data.fallback_command_id;
                            
                            // 使用传统的命令状态轮询
                            pollCommandStatus(fallbackCommandId, function(result) {
                                if (result.success) {
                                    try {
                                        // 处理传统API返回的系统信息
                                        let sysinfo = typeof result.message === 'object' ? result.message : JSON.parse(result.message);
                                        
                                        // 转换为新格式
                                        const convertedResult = {
                                            success: true,
                                            system_info: sysinfo,
                                            result_type: "system_performance",
                                            upload_type: "current",
                                            files_processed: 0,
                                            files_uploaded: 0,
                                            from_fallback: true,
                                            message: "System information obtained via fallback method"
                                        };
                                        
                                        callback(convertedResult);
                                    } catch (e) {
                                        console.error('处理回退系统信息失败:', e);
                                        callback({
                                            success: false,
                                            message: '处理回退系统信息失败: ' + e.message
                                        });
                                    }
                                } else {
                                    callback(result);
                                }
                            });
                        } else {
                            // 命令不存在或出错
                            callback({
                                success: false,
                                message: data.message || '命令执行出错'
                            });
                        }
                    })
                    .catch(error => {
                        console.error('轮询系统性能状态出错:', error);
                        if (attempts < maxAttempts) {
                            setTimeout(poll, 2000); // 网络错误时也重试
                        } else {
                            callback({
                                success: false,
                                message: '网络错误: ' + error.message
                            });
                        }
                    });
            }
            
            // 开始轮询
            poll();
        }

        // 显示系统信息
        function displaySystemInfo(info, from_cache) {
            try {
                console.log('开始显示系统信息', info);
                
                // 移除之前的缓存提示
                const oldAlert = document.querySelector('#sysinfo-container .alert-warning');
                if (oldAlert) {
                    oldAlert.parentNode.removeChild(oldAlert);
                }
                
                // 检查时间戳是否过期（超过50秒）
                const showCacheWarning = from_cache || checkTimestampExpired(info.timestamp, 50);
                
                // 添加缓存提示
                if (showCacheWarning) {
                    const cacheAlert = document.createElement('div');
                    cacheAlert.className = 'alert alert-warning mb-3';
                    cacheAlert.innerHTML = '<i class="bi bi-info-circle"></i> 显示的可能是缓存的系统信息，可能不是最新数据（可以通过点击刷新后查看数据变化判断）';
                    
                    const infoContainer = document.getElementById('sysinfo-container');
                    if (infoContainer.firstChild) {
                        infoContainer.insertBefore(cacheAlert, infoContainer.firstChild);
                    } else {
                        infoContainer.appendChild(cacheAlert);
                    }
                }
        
                // 基本信息
                document.getElementById('sysinfo-hostname').textContent = info.hostname || '未知';
                document.getElementById('sysinfo-username').textContent = info.username || '未知';
                document.getElementById('sysinfo-system').textContent = info.system || info.platform || '未知';
                document.getElementById('sysinfo-version').textContent = info.version || '未知';
                document.getElementById('sysinfo-processor').textContent = info.processor || '未知';
                document.getElementById('sysinfo-timestamp').textContent = formatDateTime(info.timestamp) || '未知';
            
                // 性能信息
                const cpuUsage = info.cpu_usage || 0;
                const memoryPercent = info.memory && info.memory.percent ? info.memory.percent : 0;
                
                document.getElementById('sysinfo-cpu').style.width = cpuUsage + '%';
                document.getElementById('sysinfo-cpu').textContent = cpuUsage + '%';
                document.getElementById('sysinfo-memory').style.width = memoryPercent + '%';
                document.getElementById('sysinfo-memory').textContent = memoryPercent + '%';
                
                document.getElementById('sysinfo-cpu-count').textContent = info.cpu_count || '未知';
                
                if (info.memory) {
                    document.getElementById('sysinfo-memory-total').textContent = formatBytes(info.memory.total) || '未知';
                    document.getElementById('sysinfo-memory-available').textContent = formatBytes(info.memory.available) || '未知';
                }
                
                if (info.network) {
                    document.getElementById('sysinfo-network-sent').textContent = formatBytes(info.network.bytes_sent) || '未知';
                    document.getElementById('sysinfo-network-recv').textContent = formatBytes(info.network.bytes_recv) || '未知';
                }
                
                // 磁盘信息
                const disksContainer = document.getElementById('sysinfo-disks');
                disksContainer.innerHTML = '';
                
                if (info.disk) {
                    console.log('处理磁盘信息', info.disk);
                    for (const [drive, data] of Object.entries(info.disk)) {
                        const diskCard = document.createElement('div');
                        diskCard.className = 'col-md-4 mb-3';
                        
                        diskCard.innerHTML = `
                            <div class="card">
                                <div class="card-header">${drive}</div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">使用率: ${data.percent}%</label>
                                        <div class="progress">
                                            <div class="progress-bar bg-info" role="progressbar" style="width: ${data.percent}%" 
                                                 aria-valuenow="${data.percent}" aria-valuemin="0" aria-valuemax="100">${data.percent}%</div>
                                        </div>
                                    </div>
                                    <small>总容量: ${formatBytes(data.total)}</small><br>
                                    <small>已使用: ${formatBytes(data.used)}</small><br>
                                    <small>可用空间: ${formatBytes(data.free)}</small>
                                </div>
                            </div>
                        `;
                        
                        disksContainer.appendChild(diskCard);
                    }
                } else {
                    console.warn('无磁盘信息');
                    disksContainer.innerHTML = '<div class="alert alert-warning">无法获取磁盘信息</div>';
                }
                
                console.log('系统信息显示完成');
            } catch (e) {
                console.error('显示系统信息时出错:', e);
                document.getElementById('sysinfo-error').textContent = '显示系统信息出错: ' + e.message;
                document.getElementById('sysinfo-error').classList.remove('d-none');
            }
        }

        // 检查时间戳是否过期
        function checkTimestampExpired(timestamp, maxAgeSeconds) {
            if (!timestamp) return true;
            
            try {
                const stampDate = new Date(timestamp);
                const now = new Date();
                const diffSeconds = (now - stampDate) / 1000;
                
                return diffSeconds > maxAgeSeconds;
            } catch (e) {
                console.error('检查时间戳出错:', e);
                return true; // 出错时默认显示缓存警告
            }
        }

        // 文件浏览功能
        let currentPath = null;
        let pathHistory = [];

        // 浏览根目录
        function browseRootDirectories() {
            // 注意：此功能在验证期间也允许使用
            currentPath = null;
            pathHistory = [];
            updateBreadcrumb();
            browseFiles(null);
        }

        // 浏览指定目录
        function browseDirectory(path) {
            // 注意：此功能在验证期间也允许使用
            if (currentPath !== path) {
                if (currentPath !== null) {
                    pathHistory.push(currentPath);
                }
                currentPath = path;
                updateBreadcrumb();
            }
            browseFiles(path);
        }

        // 更新面包屑导航
        function updateBreadcrumb() {
            const breadcrumb = document.getElementById('file-breadcrumb');
            breadcrumb.innerHTML = '<li class="breadcrumb-item"><a href="#" onclick="browseRootDirectories(); return false;">根目录</a></li>';
            
            if (currentPath !== null) {
                const parts = currentPath.split('\\');
                let currentBuildPath = '';
                
                for (let i = 0; i < parts.length; i++) {
                    currentBuildPath += parts[i];
                    
                    if (i === parts.length - 1) {
                        // 最后一个部分，当前目录
                        const item = document.createElement('li');
                        item.className = 'breadcrumb-item active';
                        item.textContent = parts[i];
                        breadcrumb.appendChild(item);
                    } else {
                        // 上级目录，可点击
                        const item = document.createElement('li');
                        item.className = 'breadcrumb-item';
                        
                        const link = document.createElement('a');
                        link.href = '#';
                        link.textContent = parts[i];
                        link.onclick = (function(path) {
                            return function() {
                                browseDirectory(path);
                                return false;
                            };
                        })(currentBuildPath);
                        
                        item.appendChild(link);
                        breadcrumb.appendChild(item);
                    }
                    
                    if (i < parts.length - 1) {
                        currentBuildPath += '\\';
                    }
                }
            }
        }

        // 浏览文件
        function browseFiles(path = null) {
            // 注意：此功能在验证期间也允许使用
            document.getElementById('file-browser-loading').classList.remove('d-none');
            document.getElementById('file-browser-error').classList.add('d-none');
            document.getElementById('file-browser-error').textContent = '';
            
            console.log(`浏览文件路径: ${path || '根目录'}`);
            
            // 更新当前路径
            currentPath = path;
            updateBreadcrumb();
            
            // 发送请求
            fetch('/api/browse_files/{{ client_id }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ path: path })
            })
            .then(response => response.json())
            .then(data => {
                console.log('浏览文件请求响应:', data);
                if (data.status === 'success') {
                    pollCommandStatus(data.command_id, function(result) {
                        console.log('文件浏览结果:', result);
                        if (result.success) {
                            try {
                                // 尝试解析结果
                                let fileData;
                                if (typeof result.message === 'string') {
                                    fileData = JSON.parse(result.message);
                                    console.log('解析后的文件数据:', fileData);
                                } else if (typeof result.message === 'object') {
                                    fileData = result.message;
                                    console.log('直接使用对象文件数据:', fileData);
                                } else {
                                    throw new Error('未知的结果格式');
                                }
                                
                                displayFileList(fileData);
                            } catch (e) {
                                console.error('解析文件列表错误:', e, result.message);
                                document.getElementById('file-browser-error').textContent = '解析文件列表失败: ' + e.message;
                                document.getElementById('file-browser-error').classList.remove('d-none');
                            }
                } else {
                            console.error('获取文件列表失败:', result.message);
                            document.getElementById('file-browser-error').textContent = '获取文件列表失败: ' + result.message;
                            document.getElementById('file-browser-error').classList.remove('d-none');
                        }
                        document.getElementById('file-browser-loading').classList.add('d-none');
                    });
                } else {
                    console.error('发送浏览请求失败:', data.message);
                    document.getElementById('file-browser-error').textContent = data.message || '发送请求失败';
                    document.getElementById('file-browser-error').classList.remove('d-none');
                    document.getElementById('file-browser-loading').classList.add('d-none');
                }
            })
            .catch(error => {
                console.error('浏览请求错误:', error);
                document.getElementById('file-browser-error').textContent = '请求错误: ' + error.message;
                document.getElementById('file-browser-error').classList.remove('d-none');
                document.getElementById('file-browser-loading').classList.add('d-none');
            });
        }

        // 显示文件列表
        function displayFileList(data) {
            console.log('开始显示文件列表:', data);
            const directoryList = document.getElementById('directory-list');
            const fileList = document.getElementById('file-list');
            
            directoryList.innerHTML = '';
            fileList.innerHTML = '';
            
            // 如果不是根目录，添加返回上级目录选项
            if (pathHistory.length > 0 && currentPath !== null) {
                const backItem = document.createElement('a');
                backItem.className = 'list-group-item list-group-item-action';
                backItem.href = '#';
                backItem.innerHTML = '<i class="bi bi-arrow-up"></i> 返回上级目录';
                backItem.onclick = function() {
                    currentPath = pathHistory.pop();
                    updateBreadcrumb();
                    browseFiles(currentPath);
                    return false;
                };
                directoryList.appendChild(backItem);
            }
            
            // 显示目录
            if (data.directories && data.directories.length > 0) {
                // 检查是否是根目录（显示磁盘列表）
                if (currentPath === null && data.drive_labels && data.drive_labels.length > 0) {
                    console.log('显示驱动器列表:', data.drive_labels);
                    // 如果有带标签的磁盘信息，优先使用它
                    data.drive_labels.forEach(drive => {
                        const item = document.createElement('a');
                        item.className = 'list-group-item list-group-item-action';
                        item.href = '#';
                        item.innerHTML = '<i class="bi bi-hdd-fill me-2"></i> ' + drive.name;
                        item.onclick = function() {
                            browseDirectory(drive.path);
                            return false;
                        };
                        directoryList.appendChild(item);
                    });
                } else {
                    console.log('显示常规目录列表:', data.directories);
                    // 普通目录
                    data.directories.forEach(dir => {
                        try {
                            const dirName = dir.split('\\').pop().split('/').pop();
                        const item = document.createElement('a');
                        item.className = 'list-group-item list-group-item-action';
                        item.href = '#';
                        item.innerHTML = '<i class="bi bi-folder-fill me-2"></i> ' + dirName;
                        item.onclick = function() {
                            browseDirectory(dir);
                            return false;
                        };
                        directoryList.appendChild(item);
                        } catch (e) {
                            console.error('处理目录项错误:', e, dir);
                        }
                    });
                }
            } else if (directoryList.children.length === 0) {
                console.log('没有找到子目录');
                const emptyItem = document.createElement('div');
                emptyItem.className = 'list-group-item text-muted';
                emptyItem.textContent = '无子目录';
                directoryList.appendChild(emptyItem);
            }
            
            // 显示文件
            if (data.files && data.files.length > 0) {
                console.log('显示文件列表:', data.files.length, '个文件');
                data.files.forEach(file => {
                    try {
                        const item = document.createElement('div'); // 使用div元素
                        item.className = 'list-group-item';
                        
                        // 更新HTML结构，使用downloadFile函数
                    item.innerHTML = `
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${file.name}</h6>
                            <small>${formatBytes(file.size)}</small>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">修改时间: ${formatDateTime(file.modified)}</small>
                            <div>
                                <button class="btn btn-sm btn-outline-success" onclick="downloadFile('${file.path.replace(/\\/g, '\\\\')}', '${file.name}'); event.stopPropagation();">
                                    <i class="bi bi-download"></i> 下载
                                </button>
                            </div>
                        </div>
                    `;
                        
                    fileList.appendChild(item);
                    } catch (e) {
                        console.error('处理文件项错误:', e, file);
                    }
                });
            } else {
                console.log('没有找到文件');
                const emptyItem = document.createElement('div');
                emptyItem.className = 'list-group-item text-muted';
                emptyItem.textContent = '目录为空';
                fileList.appendChild(emptyItem);
            }
            
            // 如果有截断信息，显示提示
            if (data.truncated && data.truncated_message) {
                console.log('显示截断提示:', data.truncated_message);
                const truncatedInfo = document.createElement('div');
                truncatedInfo.className = 'alert alert-info mt-2';
                truncatedInfo.textContent = data.truncated_message;
                directoryList.parentNode.insertBefore(truncatedInfo, directoryList.nextSibling);
            }
            
            console.log('文件列表显示完成');
        }

        // 恢复API方式下载文件功能
        function downloadFile(filePath, fileName) {
            // 显示加载中
            document.getElementById('file-browser-loading').classList.remove('d-none');
            document.getElementById('file-browser-error').classList.add('d-none');
            
            // 发送请求
            fetch('/api/download_file/{{ client_id }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ file_path: filePath })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // 创建状态消息元素并添加到顶部
                    const statusElement = document.createElement('div');
                    statusElement.className = 'alert alert-info mb-3';
                    statusElement.innerHTML = `<i class="bi bi-info-circle"></i> 正在从客户端下载文件: ${fileName}，请稍候...`;
                    
                    // 添加到文件浏览区域的顶部
                    const container = document.getElementById('file-browser-container');
                    // 使用prepend方法安全地插入到容器顶部
                    container.prepend(statusElement);
                    
                    // 轮询下载状态
                    pollCommandStatus(data.command_id, function(result) {
                        document.getElementById('file-browser-loading').classList.add('d-none');
                        
                        if (result.success) {
                            statusElement.className = 'alert alert-success mb-3';
                            statusElement.innerHTML = `<i class="bi bi-check-circle"></i> 文件已成功下载到服务器`;
                            
                            // 创建下载链接并自动点击触发下载
                            setTimeout(() => {
                                const downloadLink = document.createElement('a');
                                // 使用encodeURIComponent处理文件名中的特殊字符
                                const encodedFileName = encodeURIComponent(fileName);
                                downloadLink.href = `/downloads/{{ client_id }}/${encodedFileName}`;
                                downloadLink.download = fileName;
                                downloadLink.style.display = 'none';
                                document.body.appendChild(downloadLink);
                                downloadLink.click();
                                document.body.removeChild(downloadLink);
                                
                                // 更新状态消息
                                statusElement.innerHTML = `<i class="bi bi-check-circle"></i> 文件已成功下载: ${fileName}`;
                            }, 500);
                        } else {
                            statusElement.className = 'alert alert-danger mb-3';
                            statusElement.innerHTML = `<i class="bi bi-x-circle"></i> 文件下载失败: ${result.message}`;
                        }
                        
                        // 10秒后移除状态消息
                        setTimeout(() => {
                            statusElement.remove();
                        }, 10000);
                    });
                } else {
                    document.getElementById('file-browser-error').textContent = data.message || '发送请求失败';
                    document.getElementById('file-browser-error').classList.remove('d-none');
                    document.getElementById('file-browser-loading').classList.add('d-none');
                }
            })
            .catch(error => {
                document.getElementById('file-browser-error').textContent = '请求错误: ' + error.message;
                document.getElementById('file-browser-error').classList.remove('d-none');
                document.getElementById('file-browser-loading').classList.add('d-none');
            });
        }

        // 读取文件内容
        function readFile(filePath, fileName) {
            // 显示加载中
            document.getElementById('file-browser-loading').classList.remove('d-none');
            document.getElementById('file-browser-error').classList.add('d-none');
            
            // 发送请求
            fetch('/api/read_file/{{ client_id }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ file_path: filePath })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    pollCommandStatus(data.command_id, function(result) {
                        if (result.success) {
                            try {
                                const fileData = JSON.parse(result.message);
                                displayFileContent(fileData, fileName);
                            } catch (e) {
                                document.getElementById('file-browser-error').textContent = '解析文件内容失败: ' + e.message;
                                document.getElementById('file-browser-error').classList.remove('d-none');
                            }
                } else {
                            document.getElementById('file-browser-error').textContent = '读取文件失败: ' + result.message;
                            document.getElementById('file-browser-error').classList.remove('d-none');
                        }
                        document.getElementById('file-browser-loading').classList.add('d-none');
                    });
                } else {
                    document.getElementById('file-browser-error').textContent = data.message || '发送请求失败';
                    document.getElementById('file-browser-error').classList.remove('d-none');
                    document.getElementById('file-browser-loading').classList.add('d-none');
                }
            })
            .catch(error => {
                document.getElementById('file-browser-error').textContent = '请求错误: ' + error.message;
                document.getElementById('file-browser-error').classList.remove('d-none');
                document.getElementById('file-browser-loading').classList.add('d-none');
            });
        }

        // 显示文件内容
        function displayFileContent(fileData, fileName) {
            const contentContainer = document.getElementById('file-content-container');
            const contentName = document.getElementById('file-content-name');
            const content = document.getElementById('file-content');
            
            contentName.textContent = fileName + (fileData.is_binary ? ' (二进制文件)' : '');
            content.textContent = fileData.content;
            
            contentContainer.classList.remove('d-none');
        }

        // 关闭文件内容
        function closeFileContent() {
            document.getElementById('file-content-container').classList.add('d-none');
        }

        // 辅助函数 - 格式化字节大小
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
            
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        // 辅助函数 - 格式化日期时间
        function formatDateTime(isoString) {
            try {
                const date = new Date(isoString);
                return date.toLocaleString();
            } catch (e) {
                return isoString;
            }
        }

        // 轮询命令状态
        function pollCommandStatus(commandId, callback) {
            let attempts = 0;
            const maxAttempts = 60; // 增加最大尝试次数到60次
            const initialInterval = 1000; // 从1秒开始
            const maxInterval = 5000; // 最大间隔5秒
            let currentInterval = initialInterval;
            
            // 显示轮询状态
            console.log(`开始轮询命令状态: ${commandId}`);
            
            const interval = setInterval(() => {
                attempts++;
                
                // 调整轮询间隔，逐渐增加以减少服务器压力
                if (attempts > 10) { // 超过10次后开始增加间隔
                    currentInterval = Math.min(currentInterval * 1.5, maxInterval);
                }
                
                if (attempts > maxAttempts) {
                    clearInterval(interval);
                    console.warn(`命令${commandId}轮询超时，已尝试${maxAttempts}次`);
                    callback({
                        success: false,
                        message: `获取命令结果超时，请检查网络连接或服务器状态`
                    });
                    return;
                }
                
                console.log(`第${attempts}次轮询命令状态: ${commandId}`);
                
                fetch(`/api/command_status/{{ client_id }}/${commandId}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log(`命令状态: ${data.status}`, data);
                        
                        if (data.status === 'complete') {
                            clearInterval(interval);
                            console.log(`命令${commandId}完成，结果:`, data.result);
                            callback(data.result);
                        }
                    })
                    .catch(error => {
                        console.error(`轮询命令状态出错: ${error}`);
                        // 不要立即结束，可能只是临时网络问题
                    });
            }, currentInterval);
        }

        // 键盘记录相关功能
        let keylogPollingInterval = null;
        let keylogRealtimeSession = null;
        
        // 初始化键盘记录器
        function initializeKeylogger() {
            // 立即加载历史记录
            loadKeylogHistory();
            
            // 启动HTTP轮询模式
            startKeylogPolling();
            
            // 显示提示
            appendKeylogEntry('[系统] 已启用HTTP轮询模式获取键盘记录...', false);
        }
        
        // 创建键盘记录WebSocket连接 - 此函数不再主动调用
        function createKeylogSocketConnection() {
            try {
                appendKeylogEntry('[系统] 正在连接键盘记录服务器...', false);
                
                // 创建Socket.IO连接
                keylogSocket = io('/keylog', {
                    transports: ['websocket', 'polling'],  // 优先使用WebSocket
                    forceNew: keylogReconnectAttempts > 0,
                    timeout: 5000,
                    reconnection: true,             // 启用自动重连
                    reconnectionAttempts: 5,        // 最多重试5次
                    reconnectionDelay: 1000,        // 初始延迟1秒
                    reconnectionDelayMax: 5000,     // 最大延迟5秒
                    randomizationFactor: 0.5        // 随机因子
                });
                
                // 连接事件
                keylogSocket.on('connect', () => {
                    keylogReconnectAttempts = 0;
                    appendKeylogEntry('[系统] 键盘记录连接已建立', false);
                    keylogSocket.emit('subscribe', { client_id: '{{ client_id }}' });
                    
                    // 清除轮询间隔
                    if (keylogPollingInterval) {
                        clearInterval(keylogPollingInterval);
                        keylogPollingInterval = null;
                    }
                });
                
                // 连接错误处理
                keylogSocket.on('connect_error', (error) => {
                    console.error('键盘记录连接错误:', error);
                    appendKeylogEntry(`[系统] 键盘记录连接错误: ${error.message}`, false);
                });
                
                // 断开连接处理
                keylogSocket.on('disconnect', (reason) => {
                    appendKeylogEntry(`[系统] 键盘记录连接已断开 (${reason})`, false);
                });
                
                // 重连尝试
                keylogSocket.on('reconnect_attempt', (attemptNumber) => {
                    appendKeylogEntry(`[系统] 尝试重新连接 (${attemptNumber}/5)...`, false);
                });
                
                // 重连失败
                keylogSocket.on('reconnect_failed', () => {
                    appendKeylogEntry('[系统] 键盘记录重连失败，切换到HTTP轮询...', false);
                    switchToKeylogPolling();
                });
                
                // 接收键盘记录事件
                keylogSocket.on('keylog_event', (data) => {
                    if (data.client_id === '{{ client_id }}' && document.getElementById('keylogRealtimeToggle').checked) {
                        appendKeylogEntry(data.key_data, true);
                    }
                });
                
            } catch (e) {
                console.error('创建键盘记录连接失败:', e);
                appendKeylogEntry(`[系统] 创建键盘记录连接失败: ${e.message}，将使用HTTP轮询`, false);
                switchToKeylogPolling();
            }
        }
        
        // 启动键盘记录HTTP轮询
        function startKeylogPolling() {
            if (keylogPollingInterval) {
                clearInterval(keylogPollingInterval);
            }
            
            // 启动实时模式会话
            startRealtimeSession();
                
            // 每1秒轮询一次历史记录
            keylogPollingInterval = setInterval(() => {
                loadKeylogHistory(true);  // 静默加载
            }, 1000);
        }
        
        // 启动实时模式会话
        function startRealtimeSession() {
            fetch(`/api/keylog_realtime/{{ client_id }}/start`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    keylogRealtimeSession = {
                        active: true,
                        expiry_time: data.expiry_time
                    };
                    appendKeylogEntry('[系统] 实时键盘记录会话已启动', false);
                            
                    // 设置自动刷新会话（每8秒刷新一次，确保10秒会话不过期）
                            setTimeout(() => {
                        if (keylogRealtimeSession && keylogRealtimeSession.active) {
                            refreshRealtimeSession();
                        }
                    }, 8000);
                } else {
                    appendKeylogEntry('[系统] 启动实时键盘记录会话失败', false);
                }
            })
            .catch(error => {
                console.error('启动实时会话失败:', error);
                appendKeylogEntry('[系统] 启动实时键盘记录会话出错', false);
            });
        }
        
        // 刷新实时模式会话
        function refreshRealtimeSession() {
            if (!keylogRealtimeSession || !keylogRealtimeSession.active) {
                return;
            }
            
            fetch(`/api/keylog_realtime/{{ client_id }}/refresh`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    keylogRealtimeSession.expiry_time = data.expiry_time;
                    // 继续下一次刷新
                    setTimeout(() => {
                        if (keylogRealtimeSession && keylogRealtimeSession.active) {
                            refreshRealtimeSession();
                    }
                    }, 8000);
            } else {
                    appendKeylogEntry('[系统] 刷新实时键盘记录会话失败', false);
                    keylogRealtimeSession = null;
                }
            })
            .catch(error => {
                console.error('刷新实时会话失败:', error);
                keylogRealtimeSession = null;
            });
        }
        
        // 停止实时模式会话
        function stopRealtimeSession() {
            if (keylogRealtimeSession) {
                keylogRealtimeSession.active = false;
                
                fetch(`/api/keylog_realtime/{{ client_id }}/stop`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    appendKeylogEntry('[系统] 实时键盘记录会话已停止', false);
                })
                .catch(error => {
                    console.error('停止实时会话失败:', error);
                });
                
                keylogRealtimeSession = null;
            }
        }
        
        // 切换到键盘记录HTTP轮询（保留原有函数以兼容）
        function switchToKeylogPolling() {
            startKeylogPolling();
        }
        
        // 加载键盘记录历史
        function loadKeylogHistory(silent = false) {
            // 显示刷新指示器
            if (!silent) {
                const refreshBtn = document.querySelectorAll('[onclick="loadKeylogHistory()"]');
                refreshBtn.forEach(btn => {
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 刷新中';
                    btn.disabled = true;
                    
                    // 1秒后恢复按钮状态(无论成功与否)
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }, 1000);
                });
            }

            fetch(`/api/keylog_history/{{ client_id }}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP错误 ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.keylog && data.keylog.length > 0) {
                        if (!silent) {
                            clearKeylogDisplay();
                            data.keylog.forEach(log => {
                                appendKeylogEntry(log, false);
                            });
                            scrollKeylogToBottom();
                        } else {
                            // 只添加新记录
                            const keylogContainer = document.getElementById('keylogContainer');
                            const currentLogs = new Set(Array.from(keylogContainer.children).map(el => el.textContent));
                            
                            let newLogsAdded = false;
                            data.keylog.forEach(log => {
                                if (!currentLogs.has(log)) {
                                    appendKeylogEntry(log, true);
                                    newLogsAdded = true;
                                }
                            });
                            
                            if (newLogsAdded) {
                                scrollKeylogToBottom();
                            }
                        }
                    } else if (!silent && document.getElementById('keylogContainer').children.length === 0) {
                        appendKeylogEntry("暂无键盘记录", false);
                    }
                })
                .catch(error => {
                    console.error("加载键盘记录历史失败:", error);
                    if (!silent) {
                        appendKeylogEntry(`[错误] 加载键盘记录历史失败: ${error.message}，将在下次轮询重试`, false);
                    }
                });
        }
        
        // 添加键盘记录条目
        function appendKeylogEntry(keyEntry, highlight) {
            const keylogContainer = document.getElementById('keylogContainer');
            if (!keylogContainer) return;
            
            const entry = document.createElement('div');
            entry.className = 'keylog-entry';
            entry.style.margin = '5px 0';
            entry.style.padding = '5px';
            entry.style.borderBottom = '1px solid #eee';
            entry.style.fontFamily = 'monospace';
            
            if (highlight) {
                entry.style.backgroundColor = '#e3f2fd';
                entry.style.animation = 'flash 1s linear';
            }
            
            entry.textContent = keyEntry;
            keylogContainer.appendChild(entry);
            
            // 自动滚动
            scrollKeylogToBottom();
            
            // 限制记录条数
            const maxEntries = 500;
            while (keylogContainer.children.length > maxEntries) {
                keylogContainer.removeChild(keylogContainer.firstChild);
            }
        }
        
        // 滚动键盘记录到底部
        function scrollKeylogToBottom() {
            const keylogContainer = document.getElementById('keylogContainer');
            if (keylogContainer) {
                keylogContainer.scrollTop = keylogContainer.scrollHeight;
            }
        }
        
        // 清空键盘记录显示
        function clearKeylogDisplay() {
            const keylogContainer = document.getElementById('keylogContainer');
            if (keylogContainer) {
                keylogContainer.innerHTML = '';
            }
        }

        // 批量删除功能初始化
        function initBatchDeleteFeatures() {
            // 截图批量删除
            const screenshotsBatchModeBtn = document.getElementById('screenshots-batch-mode-btn');
            const screenshotsBatchDeleteBtn = document.getElementById('screenshots-batch-delete-btn');
            
            if (screenshotsBatchModeBtn) {
                screenshotsBatchModeBtn.addEventListener('click', function() {
                    const checkboxes = document.querySelectorAll('.screenshot-checkbox');
                    if (checkboxes.length === 0) return;
                    
                    // 切换显示状态
                    const isVisible = checkboxes[0].style.display !== 'none';
                    
                    checkboxes.forEach(function(checkbox) {
                        checkbox.style.display = isVisible ? 'none' : 'block';
                    });
                    
                    // 更新按钮状态
                    screenshotsBatchDeleteBtn.style.display = isVisible ? 'none' : 'inline-block';
                    screenshotsBatchModeBtn.innerHTML = isVisible ? 
                        '<i class="bi bi-check-square"></i> 批量选择' : 
                        '<i class="bi bi-x-square"></i> 取消选择';
                    
                    // 确保取消时清空选择
                    if (isVisible) {
                        document.querySelectorAll('.screenshot-checkbox-input').forEach(function(input) {
                            input.checked = false;
                        });
                        updateScreenshotSelectedCount();
                    } else {
                        // 进入批量模式时显示提示
                        const container = document.querySelector('.screenshots-container');
                        const notice = document.createElement('div');
                        notice.id = 'batch-mode-notice';
                        notice.className = 'alert alert-info mb-3';
                        notice.innerHTML = '<i class="bi bi-info-circle"></i> 批量选择模式已启用，请勾选要删除的截图。';
                        
                        // 如果提示不存在才添加
                        if (!document.getElementById('batch-mode-notice')) {
                            container.insertBefore(notice, container.firstChild);
                            
                            // 3秒后自动隐藏提示
                            setTimeout(function() {
                                if (notice.parentNode) {
                                    notice.parentNode.removeChild(notice);
                                }
                            }, 3000);
                        }
                    }
                });
            }
            
            // 视频批量删除
            const videosBatchModeBtn = document.getElementById('videos-batch-mode-btn');
            const videosBatchDeleteBtn = document.getElementById('videos-batch-delete-btn');
            
            if (videosBatchModeBtn) {
                videosBatchModeBtn.addEventListener('click', function() {
                    const checkboxes = document.querySelectorAll('.video-checkbox');
                    if (checkboxes.length === 0) return;
                    
                    // 切换显示状态
                    const isVisible = checkboxes[0].style.display !== 'none';
                    
                    checkboxes.forEach(function(checkbox) {
                        checkbox.style.display = isVisible ? 'none' : 'block';
                    });
                    
                    // 更新按钮状态
                    videosBatchDeleteBtn.style.display = isVisible ? 'none' : 'inline-block';
                    videosBatchModeBtn.innerHTML = isVisible ? 
                        '<i class="bi bi-check-square"></i> 批量选择' : 
                        '<i class="bi bi-x-square"></i> 取消选择';
                    
                    // 确保取消时清空选择
                    if (isVisible) {
                        document.querySelectorAll('.video-checkbox-input').forEach(function(input) {
                            input.checked = false;
                        });
                        updateVideosSelectedCount();
                    } else {
                        // 进入批量模式时显示提示
                        const container = document.querySelector('#videos');
                        const notice = document.createElement('div');
                        notice.id = 'video-batch-mode-notice';
                        notice.className = 'alert alert-info mb-3';
                        notice.innerHTML = '<i class="bi bi-info-circle"></i> 批量选择模式已启用，请勾选要删除的视频。';
                        
                        // 如果提示不存在才添加
                        if (!document.getElementById('video-batch-mode-notice')) {
                            container.insertBefore(notice, container.querySelector('.list-group'));
                            
                            // 3秒后自动隐藏提示
                            setTimeout(function() {
                                if (notice.parentNode) {
                                    notice.parentNode.removeChild(notice);
                                }
                            }, 3000);
                        }
                    }
                });
            }
            
            // 监听复选框变化
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('screenshot-checkbox-input')) {
                    updateScreenshotSelectedCount();
                }
                if (e.target.classList.contains('video-checkbox-input')) {
                    updateVideosSelectedCount();
                }
            });
            
            // 截图批量删除按钮点击
            if (screenshotsBatchDeleteBtn) {
                screenshotsBatchDeleteBtn.addEventListener('click', function() {
                    const selected = Array.from(document.querySelectorAll('.screenshot-checkbox-input:checked'))
                        .map(input => input.value);
                    
                    if (selected.length === 0) {
                        alert('请选择要删除的截图');
                        return;
                    }
                    
                    if (confirm(`确定要删除选中的 ${selected.length} 张截图吗？此操作不可恢复！`)) {
                        batchDeleteFiles(selected, 'screenshot');
                    }
                });
            }
            
            // 视频批量删除按钮点击
            if (videosBatchDeleteBtn) {
                videosBatchDeleteBtn.addEventListener('click', function() {
                    const selected = Array.from(document.querySelectorAll('.video-checkbox-input:checked'))
                        .map(input => input.value);
                    
                    if (selected.length === 0) {
                        alert('请选择要删除的录屏');
                        return;
                    }
                    
                    if (confirm(`确定要删除选中的 ${selected.length} 个录屏吗？此操作不可恢复！`)) {
                        batchDeleteFiles(selected, 'video');
                    }
                });
            }
            
            // 自动清理配置表单提交
            const autoCleanupForm = document.getElementById('auto-cleanup-form');
            if (autoCleanupForm) {
                autoCleanupForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
                    const config = {
                        enabled: document.getElementById('cleanup-enabled').checked,
                        days: parseInt(document.getElementById('cleanup-days').value),
                        interval: parseInt(document.getElementById('cleanup-interval').value)
                    };
                    
                    fetch('/api/auto_cleanup/config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                            showCleanupResult('cleanup-config-result', 'success', '自动清理配置已保存');
                } else {
                            showCleanupResult('cleanup-config-result', 'danger', '保存配置失败: ' + data.message);
                }
            })
            .catch(error => {
                        showCleanupResult('cleanup-config-result', 'danger', '请求错误: ' + error.message);
            });
        });
            }
            
            // 手动清理表单提交
            const manualCleanupForm = document.getElementById('manual-cleanup-form');
            if (manualCleanupForm) {
                manualCleanupForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
                    const days = parseInt(document.getElementById('manual-cleanup-days').value);
                    if (!confirm(`确定要清理 ${days === 0 ? '全部' : days+'天以前的'} 数据吗？此操作不可恢复！`)) {
                        return;
                    }
                    
                    showCleanupResult('manual-cleanup-result', 'info', '正在执行清理，请稍候...');
                    
                    fetch('/api/auto_cleanup/run', {
                method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ days: days })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                            const details = data.details;
                            let resultMsg = `清理完成，共删除 ${details.total_deleted} 个文件：
                                ${details.screenshots_deleted} 张截图、
                                ${details.videos_deleted} 个录屏、
                                ${details.keylogs_deleted} 个键盘记录、
                                ${details.other_deleted} 个其他文件。`;
                            showCleanupResult('manual-cleanup-result', 'success', resultMsg);
                } else {
                            showCleanupResult('manual-cleanup-result', 'danger', '清理操作失败: ' + data.message);
                }
            })
            .catch(error => {
                        showCleanupResult('manual-cleanup-result', 'danger', '请求错误: ' + error.message);
            });
        });
            }
        }
        
        // 更新选中截图数量
        function updateScreenshotSelectedCount() {
            const selectedCount = document.querySelectorAll('.screenshot-checkbox-input:checked').length;
            const countElement = document.getElementById('screenshots-selected-count');
            if (countElement) {
                countElement.textContent = selectedCount;
            }
        }
        
        // 更新选中视频数量
        function updateVideosSelectedCount() {
            const selectedCount = document.querySelectorAll('.video-checkbox-input:checked').length;
            const countElement = document.getElementById('videos-selected-count');
            if (countElement) {
                countElement.textContent = selectedCount;
            }
        }
        
        // 批量删除文件
        function batchDeleteFiles(files, fileType) {
            // 显示加载指示器
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'text-center py-4';
            loadingDiv.innerHTML = `
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">删除中...</span>
                </div>
                <p class="mt-2">正在删除文件，请稍候...</p>
            `;
            
            const container = document.querySelector(fileType === 'screenshot' ? '.screenshots-container' : '.list-group');
            container.appendChild(loadingDiv);
            
            // 发送删除请求
            fetch('/api/batch_delete/{{ client_id }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    files: files,
                    file_type: fileType
                })
            })
            .then(response => response.json())
            .then(data => {
                // 移除加载指示器
                container.removeChild(loadingDiv);
                
                if (data.status === 'success') {
                    alert(data.message);
                    // 重新加载页面显示更新后的文件列表
                    location.reload();
                } else {
                    alert('操作失败: ' + data.message);
            }
            })
            .catch(error => {
                // 移除加载指示器
                container.removeChild(loadingDiv);
                alert('请求错误: ' + error.message);
            });
        }
        
        // 加载自动清理配置
        function loadCleanupConfig() {
            fetch('/api/auto_cleanup/config')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const config = data.config;
                        const enabledCheckbox = document.getElementById('cleanup-enabled');
                        const daysInput = document.getElementById('cleanup-days');
                        const intervalInput = document.getElementById('cleanup-interval');
                        const manualDaysInput = document.getElementById('manual-cleanup-days');
                        
                        if (enabledCheckbox) enabledCheckbox.checked = config.enabled;
                        if (daysInput) daysInput.value = config.days;
                        if (intervalInput) intervalInput.value = config.interval;
                        if (manualDaysInput) manualDaysInput.value = config.days;
                    } else {
                        showCleanupResult('cleanup-config-result', 'danger', '加载配置失败: ' + data.message);
                    }
                })
                .catch(error => {
                    showCleanupResult('cleanup-config-result', 'danger', '请求错误: ' + error.message);
                });
        }
        
        // 显示清理结果
        function showCleanupResult(elementId, type, message) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            element.className = `alert alert-${type}`;
            element.textContent = message;
            element.style.display = 'block';
            
            // 5秒后自动隐藏成功消息
            if (type === 'success') {
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
        }

        // 添加样式
        document.addEventListener('DOMContentLoaded', function() {
            const style = document.createElement('style');
            style.textContent = `
                .screenshot-checkbox {
                    position: absolute;
                    top: 10px;
                    left: 10px;
                    z-index: 10;
                    background-color: rgba(255, 255, 255, 0.8);
                    border-radius: 4px;
                    padding: 3px;
                }
                .video-item {
                    position: relative;
                }
                .video-checkbox {
                    position: absolute;
                    top: 10px;
                    left: 10px;
                    z-index: 10;
                    background-color: rgba(255, 255, 255, 0.8);
                    border-radius: 4px;
                    padding: 3px;
                }
            `;
            document.head.appendChild(style);
        });

        // 免责声明相关功能
        function checkDisclaimerStatus() {
            // 检查本地存储中的免责声明状态
            const disclaimerAccepted = localStorage.getItem('disclaimerAccepted');
            const doNotShowAgain = localStorage.getItem('disclaimerDoNotShow') === 'true';
            
            // 如果未接受或未设置"不再显示"，则显示免责声明
            if (!disclaimerAccepted || (!doNotShowAgain && disclaimerAccepted !== getCurrentDay())) {
                showDisclaimerModal();
            }
        }
        
        // 显示免责声明模态框
        function showDisclaimerModal() {
            const disclaimerModal = new bootstrap.Modal(document.getElementById('disclaimerModal'));
            disclaimerModal.show();
        }
        
        // 初始化免责声明处理器
        function initDisclaimerHandlers() {
            // 接受按钮点击处理
            document.getElementById('acceptDisclaimerBtn').addEventListener('click', function() {
                const doNotShowAgain = document.getElementById('doNotShowAgain').checked;
                
                // 保存状态到本地存储
                localStorage.setItem('disclaimerAccepted', getCurrentDay());
                if (doNotShowAgain) {
                    localStorage.setItem('disclaimerDoNotShow', 'true');
                }
                
                // 关闭模态框
                const disclaimerModal = bootstrap.Modal.getInstance(document.getElementById('disclaimerModal'));
                disclaimerModal.hide();
            });
            
            // 拒绝按钮点击处理
            document.getElementById('rejectDisclaimerBtn').addEventListener('click', function() {
                // 重定向到根页面或其他页面
                window.location.href = '/';
            });
        }
        
        // 获取当前日期的字符串表示（用于判断每日提醒）
        function getCurrentDay() {
            const now = new Date();
            return `${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()}`;
        }

        // 实时录屏状态变量
        let isRecording = false;
        let recordingStatusChecker = null;
        
        // 切换实时录屏状态
        function toggleRealtimeRecording() {
            const realtimeBtn = document.getElementById('realtime-record-btn');
            
            if (isRecording) {
                // 当前正在录屏，需要停止
                stopRealtimeRecording();
            } else {
                // 当前没有录屏，开始录制
                startRealtimeRecording();
            }
        }
        
        // 开始实时录屏
        function startRealtimeRecording() {
            const fps = document.getElementById('realtime_fps').value || 10;
            
            fetch('/api/realtime_record/{{ client_id }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ fps: parseInt(fps) })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast('实时录屏已开始', 'success');
                    // 立即检查状态更新UI
                    checkRecordingStatus();
                } else {
                    showToast(data.message || '开始录屏失败', 'error');
                }
            })
            .catch(error => {
                showToast('请求错误: ' + error.message, 'error');
            });
        }
        
        // 检查录屏状态
        function checkRecordingStatus() {
            fetch('/api/recording_status/{{ client_id }}')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    updateRecordingUI(data.recording, data.recording_status);
                } else {
                    console.error('获取录屏状态失败:', data.message);
                }
            })
            .catch(error => {
                console.error('检查录屏状态出错:', error);
            });
        }
        
        // 更新录屏UI
        function updateRecordingUI(isRecordingNow, statusData) {
            isRecording = isRecordingNow;
            const realtimeBtn = document.getElementById('realtime-record-btn');
            const statusInfo = document.getElementById('recording-status-info');
            
            // 更新按钮状态和文本
            if (isRecordingNow) {
                realtimeBtn.classList.remove('btn-primary');
                realtimeBtn.classList.add('btn-danger');
                realtimeBtn.innerHTML = '<i class="bi bi-stop-circle"></i> 停止实时录屏';
                
                // 更新状态信息
                let recordingType = statusData.type || '未知';
                let startTimeStr = '未知时间';
                
                if (statusData.start_time) {
                    try {
                        const startTime = new Date(statusData.start_time);
                        startTimeStr = startTime.toLocaleString();
                    } catch (e) {
                        console.error('解析开始时间出错:', e);
                    }
                }
                
                // 处理录屏时长信息
                let durationInfo = '';
                if (statusData.recording_duration !== undefined) {
                    // 实时录屏模式特殊处理
                    if (recordingType === 'realtime') {
                        // 优先使用格式化的时间
                        if (statusData.recording_duration_formatted) {
                            durationInfo = `，已录制 ${statusData.recording_duration_formatted}`;
                            if (statusData.recording_total_duration_formatted === "无限制") {
                                durationInfo += " <span class='badge bg-info'>无限制</span>";
                            }
                        } else {
                            durationInfo = `，已录制 ${statusData.recording_duration}秒`;
                        }
                    }
                    // 定时录屏模式
                    else if (recordingType === 'timed' && statusData.total_duration !== undefined) {
                        // 显示已录制时长/总时长
                        if (statusData.recording_duration_formatted && statusData.recording_total_duration_formatted) {
                            durationInfo = `，已录制 ${statusData.recording_duration_formatted} / 共 ${statusData.recording_total_duration_formatted}`;
                        } else {
                            durationInfo = `，已录制 ${statusData.recording_duration}秒 / 共 ${statusData.total_duration}秒`;
                        }
                    }
                    // 其他模式（向后兼容）
                    else {
                        // 实时模式或其他模式只显示已录制时长
                        if (statusData.recording_duration_formatted) {
                            durationInfo = `，已录制 ${statusData.recording_duration_formatted}`;
                        } else {
                            durationInfo = `，已录制 ${statusData.recording_duration}秒`;
                        }
                    }
                } else if (statusData.current_duration !== undefined) {
                    // 兼容旧版本的数据格式
                    if (recordingType === 'realtime') {
                        durationInfo = `，已录制 ${statusData.current_duration}秒`;
                    } else if (recordingType === 'timed' && statusData.total_duration !== undefined) {
                        durationInfo = `，已录制 ${statusData.current_duration}秒 / 共 ${statusData.total_duration}秒`;
                    } else {
                        durationInfo = `，已录制 ${statusData.current_duration}秒`;
                    }
                }
                
                statusInfo.className = 'alert alert-danger';
                statusInfo.innerHTML = `<i class="bi bi-record-circle"></i> <strong>录屏进行中</strong> - 类型: ${recordingType}, 开始时间: ${startTimeStr}${durationInfo}，已录制 ${statusData.current_duration}秒`;
            } else {
                realtimeBtn.classList.remove('btn-danger');
                realtimeBtn.classList.add('btn-primary');
                realtimeBtn.innerHTML = '<i class="bi bi-record-circle"></i> 开始实时录屏';
                
                statusInfo.className = 'alert alert-info';
                statusInfo.innerHTML = '当前未录屏';
            }
        }
        
        // 在页面加载时检查录屏状态
        document.addEventListener('DOMContentLoaded', function() {
            // 初始检查录屏状态
            checkRecordingStatus();
            
            // 设置定时检查
            if (recordingStatusChecker) {
                clearInterval(recordingStatusChecker);
            }
            
            recordingStatusChecker = setInterval(checkRecordingStatus, 5000);  // 每5秒检查一次
            
            // 当标签页被激活时检查状态
            document.getElementById('videos-tab').addEventListener('shown.bs.tab', function() {
                checkRecordingStatus();
            });
        });
        
        // 显示消息提示
        function showToast(message, type = 'info') {
            // 检查是否已有toast容器
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.className = 'position-fixed bottom-0 end-0 p-3';
                toastContainer.style.zIndex = '5000';
                document.body.appendChild(toastContainer);
            }
            
            // 创建toast元素
            const toastId = 'toast-' + Date.now();
            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            
            toast.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            // 添加到容器
            toastContainer.appendChild(toast);
            
            // 创建Bootstrap Toast实例并显示
            const toastInstance = new bootstrap.Toast(toast, {
                animation: true,
                autohide: true,
                delay: 3000
            });
            
            toastInstance.show();
            
            // 监听隐藏事件，移除DOM元素
            toast.addEventListener('hidden.bs.toast', function() {
                toast.remove();
            });
        }

        // 立即执行，不等待DOMContentLoaded
        (function() {
            setTimeout(function() {
                try {
                    // 手动实现标签页切换功能
                    var tabs = document.querySelectorAll('#clientTabs .nav-link');
                    var tabContents = document.querySelectorAll('.tab-content .tab-pane');
                    
                    // 隐藏所有标签内容
                    tabContents.forEach(function(content) {
                        content.style.display = 'none';
                        content.classList.remove('active', 'show');
                    });
                    
                    // 取消所有标签按钮的激活状态
                    tabs.forEach(function(tab) {
                        tab.classList.remove('active');
                        tab.setAttribute('aria-selected', 'false');
                    });
                    
                    // 激活第一个标签
                    var firstTab = document.getElementById('screenshots-tab');
                    var firstContent = document.getElementById('screenshots');
                    if(firstTab && firstContent) {
                        firstTab.classList.add('active');
                        firstTab.setAttribute('aria-selected', 'true');
                        firstContent.classList.add('active', 'show');
                        firstContent.style.display = 'block';
                    }
                    
                    // 为每个标签页添加点击事件
                    tabs.forEach(function(tab) {
                        tab.addEventListener('click', function(e) {
                            e.preventDefault();
                            
                            // 获取目标内容ID
                            var targetId = this.getAttribute('data-bs-target').substring(1);
                            
                            // 隐藏所有内容
                            tabContents.forEach(function(content) {
                                content.style.display = 'none';
                                content.classList.remove('active', 'show');
                            });
                            
                            // 取消所有标签激活状态
                            tabs.forEach(function(t) {
                                t.classList.remove('active');
                                t.setAttribute('aria-selected', 'false');
                            });
                            
                            // 激活当前标签和内容
                            this.classList.add('active');
                            this.setAttribute('aria-selected', 'true');
                            
                            var content = document.getElementById(targetId);
                            if(content) {
                                content.classList.add('active', 'show');
                                content.style.display = 'block';
                                
                                // 触发特定功能
                                if(this.id === 'config-tab') {
                                    loadClientConfig();
                                } else if(this.id === 'sysinfo-tab') {
                                    getSystemInfo();
                                } else if(this.id === 'files-tab') {
                                    browseRootDirectories();
                                }
                            }
                        });
                    });
                    
                    console.log('Manual tab initialization completed');

                    // 添加监听实时更新切换代码
                    const realtimeToggle = document.getElementById('realtimeToggle');
                    if (realtimeToggle) {
                        realtimeToggle.addEventListener('change', function() {
                            if (this.checked) {
                                switchToLogPolling();
                            } else {
                                if (logPollingInterval) {
                                    clearInterval(logPollingInterval);
                                    // 移除轮询指示器
                                    const indicator = document.getElementById('pollingIndicator');
                                    if (indicator) {
                                        indicator.remove();
                                    }
                                }
                            }
                        });
                    }
                    
                    const keylogRealtimeToggle = document.getElementById('keylogRealtimeToggle');
                    if (keylogRealtimeToggle) {
                        keylogRealtimeToggle.addEventListener('change', function() {
                            if (this.checked) {
                                switchToKeylogPolling();
                            } else {
                                if (keylogPollingInterval) {
                                    clearInterval(keylogPollingInterval);
                                    // 移除轮询指示器
                                    const indicator = document.getElementById('keylogPollingIndicator');
                                    if (indicator) {
                                        indicator.remove();
                                    }
                                }
                            }
                        });
                    }
                } catch (e) {
                    console.error('Tab initialization error:', e);
                }
            }, 100); // 减少延迟到100ms
        })();

        // 显示下载文件弹窗
        function showDownloadedFilesModal() {
            // 创建Modal对象
            const modal = new bootstrap.Modal(document.getElementById('downloadedFilesModal'));
            // 显示Modal
            modal.show();
            // 加载文件列表
            loadDownloadedFiles();
            // 加载有效期设置
            loadExpirySettings();
        }
        
        // 加载下载的文件列表
        function loadDownloadedFiles() {
            const loadingIndicator = document.getElementById('filesLoadingIndicator');
            const errorMsg = document.getElementById('filesErrorMsg');
            const filesList = document.getElementById('filesList');
            const noFilesMsg = document.getElementById('noFilesMsg');
            const filesTableBody = document.getElementById('downloadedFilesTableBody');
            
            // 显示加载指示器
            loadingIndicator.classList.remove('d-none');
            errorMsg.classList.add('d-none');
            filesList.classList.add('d-none');
            noFilesMsg.classList.add('d-none');
            
            // 同时获取文件列表和有效期设置
            Promise.all([
                fetch('/api/download_folder_files/{{ client_id }}').then(r => r.json()),
                fetch('/api/download_expiry/{{ client_id }}').then(r => r.json())
            ])
            .then(([fileData, expiryData]) => {
                    // 隐藏加载指示器
                    loadingIndicator.classList.add('d-none');
                    
                // 处理错误
                if (fileData.status === 'error') {
                    errorMsg.textContent = fileData.message || '获取文件列表失败';
                        errorMsg.classList.remove('d-none');
                    return;
                }
                
                // 获取有效期设置
                const expiryValue = expiryData.status === 'success' ? expiryData.expiry_value : 5;
                const expiryUnit = expiryData.status === 'success' ? expiryData.expiry_unit : 'minutes';
                const currentDate = new Date();
                
                // 显示文件
                if (fileData.files && fileData.files.length > 0) {
                        // 显示文件列表
                        filesTableBody.innerHTML = '';
                        
                    fileData.files.forEach(file => {
                            const row = document.createElement('tr');
                            
                        // 文件名
                            const nameCell = document.createElement('td');
                            nameCell.innerHTML = `<i class="bi bi-file-earmark me-2"></i>${file.name}`;
                            row.appendChild(nameCell);
                            
                        // 文件大小
                            const sizeCell = document.createElement('td');
                            sizeCell.textContent = formatBytes(file.size);
                            row.appendChild(sizeCell);
                            
                        // 修改时间
                            const timeCell = document.createElement('td');
                            timeCell.textContent = formatDateTime(file.modified);
                            row.appendChild(timeCell);
                            
                        // 剩余有效期
                        const expiryCell = document.createElement('td');
                        if (expiryValue === 0) {
                            expiryCell.innerHTML = '<span class="badge bg-success">永不过期</span>';
                        } else {
                            // 根据单位计算剩余时间
                            const modifiedDate = new Date(file.modified);
                            let expiryDate = new Date(modifiedDate);
                            const unitMilliseconds = {
                                'minutes': 60 * 1000,
                                'hours': 60 * 60 * 1000,
                                'days': 24 * 60 * 60 * 1000
                            }[expiryUnit];
                            
                            expiryDate.setTime(expiryDate.getTime() + (expiryValue * unitMilliseconds));
                            
                            // 计算剩余时间（毫秒）
                            const timeLeft = expiryDate - currentDate;
                            
                            if (timeLeft <= 0) {
                                expiryCell.innerHTML = '<span class="badge bg-danger">已过期</span>';
                            } else {
                                // 根据不同单位显示剩余时间
                                let timeLeftText = '';
                                if (expiryUnit === 'minutes') {
                                    const minutesLeft = Math.ceil(timeLeft / (60 * 1000));
                                    timeLeftText = `${minutesLeft}分钟`;
                                } else if (expiryUnit === 'hours') {
                                    const hoursLeft = Math.ceil(timeLeft / (60 * 60 * 1000));
                                    timeLeftText = `${hoursLeft}小时`;
                                } else {
                                    const daysLeft = Math.ceil(timeLeft / (24 * 60 * 60 * 1000));
                                    timeLeftText = `${daysLeft}天`;
                                }
                                
                                // 根据剩余时间显示不同颜色
                                const warningThreshold = unitMilliseconds * 0.2; // 剩余20%时间为黄色警告
                                if (timeLeft < warningThreshold) {
                                    expiryCell.innerHTML = `<span class="badge bg-warning">剩余 ${timeLeftText}</span>`;
                                } else {
                                    expiryCell.innerHTML = `<span class="badge bg-info">剩余 ${timeLeftText}</span>`;
                                }
                            }
                        }
                        row.appendChild(expiryCell);
                        
                        // 操作按钮
                            const actionCell = document.createElement('td');
                        actionCell.innerHTML = `
                            <a href="${file.download_url}" class="btn btn-sm btn-outline-primary" target="_blank" download="${file.name}">
                                <i class="bi bi-download"></i> 下载
                            </a>
                        `;
                            row.appendChild(actionCell);
                            
                            filesTableBody.appendChild(row);
                        });
                        
                        filesList.classList.remove('d-none');
                    } else {
                        // 显示无文件消息
                        noFilesMsg.classList.remove('d-none');
                    }
                })
                .catch(error => {
                    loadingIndicator.classList.add('d-none');
                    errorMsg.textContent = `加载文件列表失败: ${error.message}`;
                    errorMsg.classList.remove('d-none');
                });
        }

        // 加载有效期设置
        function loadExpirySettings() {
            fetch(`/api/download_expiry/{{ client_id }}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // 显示当前有效期
                        const expiryValueInput = document.getElementById('expiryValueInput');
                        const expiryUnitSelect = document.getElementById('expiryUnitSelect');
                        const currentExpirySetting = document.getElementById('currentExpirySetting');
                        
                        expiryValueInput.value = data.expiry_value;
                        expiryUnitSelect.value = data.expiry_unit;
                        
                        if (data.expiry_value === 0) {
                            currentExpirySetting.innerHTML = '<span class="badge bg-success">当前设置: 永不过期</span>';
                        } else {
                            const unitText = {
                                'minutes': '分钟', 
                                'hours': '小时', 
                                'days': '天'
                            }[data.expiry_unit] || '分钟';
                            
                            currentExpirySetting.innerHTML = `<span class="badge bg-info">当前设置: ${data.expiry_value} ${unitText}</span>`;
                        }
                    } else {
                        console.error('加载有效期设置失败:', data.message);
                    }
                })
                .catch(error => {
                    console.error('请求有效期设置出错:', error);
                });
        }

        // 保存有效期设置
        function saveExpirySettings() {
            const expiryValueInput = document.getElementById('expiryValueInput');
            const expiryUnitSelect = document.getElementById('expiryUnitSelect');
            const expiryValue = parseInt(expiryValueInput.value) || 0;
            const expiryUnit = expiryUnitSelect.value;
            const resultDiv = document.getElementById('expirySettingResult');
            
            // 显示加载状态
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div> 正在保存...';
            resultDiv.className = 'mt-2 alert alert-info';
            resultDiv.classList.remove('d-none');
            
            // 发送请求
            fetch(`/api/download_expiry/{{ client_id }}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    expiry_value: expiryValue,
                    expiry_unit: expiryUnit 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // 更新显示
                    resultDiv.innerHTML = `<i class="bi bi-check-circle"></i> ${data.message}`;
                    resultDiv.className = 'mt-2 alert alert-success';
                    
                    // 更新当前设置显示
                    const currentExpirySetting = document.getElementById('currentExpirySetting');
                    if (expiryValue === 0) {
                        currentExpirySetting.innerHTML = '<span class="badge bg-success">当前设置: 永不过期</span>';
                    } else {
                        const unitText = {
                            'minutes': '分钟', 
                            'hours': '小时', 
                            'days': '天'
                        }[expiryUnit] || '分钟';
                        
                        currentExpirySetting.innerHTML = `<span class="badge bg-info">当前设置: ${expiryValue} ${unitText}</span>`;
                    }
                    
                    // 重新加载文件列表
                    loadDownloadedFiles();
                    
                    // 3秒后隐藏结果
                    setTimeout(() => {
                        resultDiv.classList.add('d-none');
                    }, 3000);
                } else {
                    resultDiv.innerHTML = `<i class="bi bi-x-circle"></i> 保存失败: ${data.message}`;
                    resultDiv.className = 'mt-2 alert alert-danger';
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `<i class="bi bi-x-circle"></i> 请求错误: ${error.message}`;
                resultDiv.className = 'mt-2 alert alert-danger';
            });
        }

        // 初始化有效期设置按钮
        document.addEventListener('DOMContentLoaded', function() {
            const saveExpiryBtn = document.getElementById('saveExpiryBtn');
            if (saveExpiryBtn) {
                saveExpiryBtn.addEventListener('click', saveExpirySettings);
            }
        });

        // 截屏暂停/恢复控制 - 修改为点击保存按钮时才发送请求
        $('#saveScreenshotSettingBtn').click(function() {
            const isEnabled = $('#pauseScreenshotSwitch').prop('checked');
            const isPaused = !isEnabled; // 开关打开表示启用，反之为暂停
            
            // 显示状态更新
            $('#screenshotStatus').text(isEnabled ? '正在保存...' : '正在保存...');
            
            $.ajax({
                url: '/api/pause_screenshot/{{ client_id }}',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ 
                    paused: isPaused,
                    save_persistent: true // 添加标记表示需要持久化保存
                }),
                success: function(response) {
                    // 更新状态文本
                    $('#screenshotStatus').text(isPaused ? '已禁用' : '已启用');
                    
                    // 显示保存成功信息
                    $('#screenshotSettingSaved').show();
                    setTimeout(() => {
                        $('#screenshotSettingSaved').fadeOut();
                    }, 3000);
                    
                    showAlert('屏幕截图设置已' + (isEnabled ? '启用' : '禁用') + '并保存', 'success');
                },
                error: function(xhr) {
                    showAlert('保存设置失败: ' + (xhr.responseJSON?.message || '未知错误'), 'danger');
                    // 恢复显示为原始状态
                    $('#screenshotStatus').text(isPaused ? '已启用' : '已禁用');
                }
            });
        });

        // 实时键盘记录控制和历史键盘记录控制 - 修改为点击保存按钮时一起发送请求
        $('#saveKeylogSettingBtn').click(function() {
            const enableRealtime = $('#realtimeKeylogSwitch').prop('checked');
            const enableHistorical = $('#historicalKeylogSwitch').prop('checked');
            
            $.ajax({
                url: '/api/keylog_settings/{{ client_id }}',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ 
                    enable_realtime_keylog: enableRealtime,
                    enable_historical_keylog: enableHistorical,
                    save_persistent: true // 添加标记表示需要持久化保存
                }),
                success: function(response) {
                    // 显示保存成功信息
                    $('#keylogSettingSaved').show();
                    setTimeout(() => {
                        $('#keylogSettingSaved').fadeOut();
                    }, 3000);
                    
                    showAlert('键盘记录设置已保存', 'success');
                },
                error: function(xhr) {
                    showAlert('保存设置失败: ' + (xhr.responseJSON?.message || '未知错误'), 'danger');
                }
            });
        });

        // 显示提示消息
        function showAlert(message, type) {
            const alertContainer = document.createElement('div');
            alertContainer.id = 'alertContainer';
            alertContainer.style.position = 'fixed';
            alertContainer.style.top = '20px';
            alertContainer.style.right = '20px';
            alertContainer.style.zIndex = '9999';
            document.body.appendChild(alertContainer);
            
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            $('#alertContainer').html(alertHtml);
            // 自动关闭
            setTimeout(() => {
                $('.alert').alert('close');
                if (document.getElementById('alertContainer')) {
                    document.getElementById('alertContainer').remove();
                }
            }, 3000);
        }
        
        // 删除客户端
        function deleteClient() {
            // 显示确认对话框
            if (!confirm("确定要删除此客户端吗？此操作将删除所有相关数据且不可恢复！")) {
                return;
            }
            
            // 再次确认
            if (!confirm("警告：删除操作不可撤销！所有截图、录屏、键盘记录等数据将永久丢失。确定继续吗？")) {
                return;
            }
            
            // 发送删除请求
            fetch(`/api/client/delete/{{ client_id }}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('客户端已成功删除，即将返回首页...', 'success');
                    // 3秒后跳转到首页
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 3000);
                } else {
                    showAlert(`删除失败: ${data.message}`, 'danger');
                }
            })
            .catch(error => {
                showAlert(`删除请求错误: ${error.message}`, 'danger');
            });
        }
        
        // 恢复客户端原始设置
        function resetClientSettings() {
            // 显示确认对话框
            if (!confirm("确定要将此客户端恢复到原始设置吗？这将重置所有配置（服务器IP地址除外）。")) {
                return;
            }
            
            // 发送重置请求
            fetch(`/api/client/reset/{{ client_id }}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('客户端设置已成功重置，客户端将在下次连接时应用新设置', 'success');
                } else {
                    showAlert(`重置失败: ${data.message}`, 'danger');
                }
            })
            .catch(error => {
                showAlert(`重置请求错误: ${error.message}`, 'danger');
            });
        }

        // 开机自启动管理函数
        function checkAutoStartup() {
            // 禁用按钮防止重复点击
            const btn = document.getElementById('check-startup-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> 检查中...';
            
            // 显示状态显示区域
            const statusDisplay = document.getElementById('startup-status-display');
            statusDisplay.style.display = 'block';
            
            fetch(`/api/auto_startup/{{ client_id }}/status`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // 轮询命令状态
                        pollAutoStartupStatus(data.command_id, function(result) {
                            btn.disabled = false;
                            btn.innerHTML = '<i class="bi bi-search"></i> 检查自启动';
                            
                            if (result.success && result.startup_info) {
                                const info = result.startup_info;
                                const statusText = info.status_text || result.message;
                                
                                // 更新详细状态显示
                                updateStartupStatusDisplay(info);
                                
                                // 根据状态更新按钮样式
                                updateStartupButtons(info.overall);
                                
                                showAlert('开机自启动状态检查完成', 'success');
                            } else {
                                hideStartupStatusDisplay();
                                showAlert(result.message || '检查自启动状态失败', 'error');
                            }
                        });
                    } else {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="bi bi-search"></i> 检查自启动';
                        hideStartupStatusDisplay();
                        showAlert(data.message || '发送检查命令失败', 'error');
                    }
                })
                .catch(error => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-search"></i> 检查自启动';
                    hideStartupStatusDisplay();
                    showAlert('请求错误: ' + error.message, 'error');
                });
        }

        function enableAutoStartup() {
            if (!confirm('确定要开启客户端的开机自启动吗？')) return;
            
            const btn = document.getElementById('enable-startup-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> 启用中...';
            
            // 显示状态显示区域
            const statusDisplay = document.getElementById('startup-status-display');
            statusDisplay.style.display = 'block';
            
            fetch(`/api/auto_startup/{{ client_id }}/enable`, {
                method: 'POST'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        pollAutoStartupStatus(data.command_id, function(result) {
                            btn.disabled = false;
                            btn.innerHTML = '<i class="bi bi-power"></i> 开启自启动';
                            
                            if (result.success) {
                                if (result.startup_info) {
                                    updateStartupStatusDisplay(result.startup_info);
                                    updateStartupButtons(result.startup_info.overall);
                                } else {
                                    updateStartupButtons(true);
                                }
                                showAlert(result.message || '开机自启动已成功开启', 'success');
                            } else {
                                hideStartupStatusDisplay();
                                showAlert(result.message || '开启开机自启动失败', 'error');
                            }
                        });
                    } else {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="bi bi-power"></i> 开启自启动';
                        hideStartupStatusDisplay();
                        showAlert(data.message || '发送开启命令失败', 'error');
                    }
                })
                .catch(error => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-power"></i> 开启自启动';
                    hideStartupStatusDisplay();
                    showAlert('请求错误: ' + error.message, 'error');
                });
        }

        function disableAutoStartup() {
            if (!confirm('确定要关闭客户端的开机自启动吗？')) return;
            
            const btn = document.getElementById('disable-startup-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> 关闭中...';
            
            // 显示状态显示区域
            const statusDisplay = document.getElementById('startup-status-display');
            statusDisplay.style.display = 'block';
            
            fetch(`/api/auto_startup/{{ client_id }}/disable`, {
                method: 'POST'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        pollAutoStartupStatus(data.command_id, function(result) {
                            btn.disabled = false;
                            btn.innerHTML = '<i class="bi bi-stop-circle"></i> 关闭自启动';
                            
                            if (result.success) {
                                if (result.startup_info) {
                                    updateStartupStatusDisplay(result.startup_info);
                                    updateStartupButtons(result.startup_info.overall);
                                } else {
                                    updateStartupButtons(false);
                                }
                                showAlert(result.message || '开机自启动已成功关闭', 'success');
                            } else {
                                hideStartupStatusDisplay();
                                showAlert(result.message || '关闭开机自启动失败', 'error');
                            }
                        });
                    } else {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="bi bi-stop-circle"></i> 关闭自启动';
                        hideStartupStatusDisplay();
                        showAlert(data.message || '发送关闭命令失败', 'error');
                    }
                })
                .catch(error => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-stop-circle"></i> 关闭自启动';
                    hideStartupStatusDisplay();
                    showAlert('请求错误: ' + error.message, 'error');
                });
        }

        // 轮询开机自启动命令状态
        function pollAutoStartupStatus(commandId, callback) {
            let attempts = 0;
            const maxAttempts = 15;
            
            function poll() {
                attempts++;
                fetch(`/api/auto_startup/command/${commandId}/status`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            if (data.command_status === 'completed') {
                                callback(data);
                            } else if (data.command_status === 'pending') {
                                if (attempts < maxAttempts) {
                                    setTimeout(poll, 2000);
                                } else {
                                    callback({
                                        success: false,
                                        message: '操作超时，请重试'
                                    });
                                }
                            } else {
                                callback({
                                    success: false,
                                    message: data.message || '命令执行失败'
                                });
                            }
                        } else {
                            callback({
                                success: false,
                                message: data.message || '获取命令状态失败'
                            });
                        }
                    })
                    .catch(error => {
                        if (attempts < maxAttempts) {
                            setTimeout(poll, 2000);
                        } else {
                            callback({
                                success: false,
                                message: '网络错误: ' + error.message
                            });
                        }
                    });
            }
            
            poll();
        }

        // 更新开机自启动按钮状态
        function updateStartupButtons(isEnabled) {
            const enableBtn = document.getElementById('enable-startup-btn');
            const disableBtn = document.getElementById('disable-startup-btn');
            
            if (isEnabled) {
                enableBtn.classList.remove('btn-outline-success');
                enableBtn.classList.add('btn-success');
                enableBtn.innerHTML = '<i class="bi bi-check-circle"></i> 已启用';
                
                disableBtn.classList.remove('btn-warning');
                disableBtn.classList.add('btn-outline-warning');
            } else {
                enableBtn.classList.remove('btn-success');
                enableBtn.classList.add('btn-outline-success');
                enableBtn.innerHTML = '<i class="bi bi-power"></i> 开启自启动';
                
                disableBtn.classList.remove('btn-outline-warning');
                disableBtn.classList.add('btn-warning');
                disableBtn.innerHTML = '<i class="bi bi-check-circle"></i> 已关闭';
            }
        }

        // 更新开机自启动状态显示
        function updateStartupStatusDisplay(startupInfo) {
            // 更新整体状态
            const overallStatus = document.getElementById('startup-overall-status');
            overallStatus.className = 'badge fs-6 ' + (startupInfo.overall ? 'bg-success' : 'bg-danger');
            overallStatus.textContent = startupInfo.overall ? '已启用' : '已禁用';
            
            // 更新启动文件夹状态
            const folderStatus = document.getElementById('startup-folder-status');
            folderStatus.className = 'badge fs-6 ' + (startupInfo.startup_folder ? 'bg-success' : 'bg-secondary');
            folderStatus.textContent = startupInfo.startup_folder ? '✓' : '✗';
            
            // 更新注册表状态
            const registryStatus = document.getElementById('startup-registry-status');
            registryStatus.className = 'badge fs-6 ' + (startupInfo.registry ? 'bg-success' : 'bg-secondary');
            registryStatus.textContent = startupInfo.registry ? '✓' : '✗';
            
            // 更新状态文本
            const statusText = document.getElementById('startup-status-text');
            statusText.className = 'alert mb-0 ' + (startupInfo.overall ? 'alert-success' : 'alert-warning');
            statusText.textContent = startupInfo.status_text || '状态检查完成';
        }

        // 隐藏开机自启动状态显示
        function hideStartupStatusDisplay() {
            const statusDisplay = document.getElementById('startup-status-display');
            statusDisplay.style.display = 'none';
        }

        // 添加验证相关JavaScript函数
        var verificationInterval = null;  // 使用var替代let确保提升

        // 检查客户端验证状态
        function checkVerificationStatus() {
            console.log("[DEBUG] 开始执行checkVerificationStatus函数");
            const clientId = '{{ client_id }}';
            console.log(`[DEBUG] 客户端ID: ${clientId}`);
            
            fetch(`/api/verification/status/${clientId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                cache: 'no-store' // 确保每次都获取最新数据
            })
            .then(response => {
                console.log(`[DEBUG] 验证状态API响应状态码: ${response.status}`);
                return response.json();
            })
            .then(data => {
                console.log("[DEBUG] 验证状态API响应数据:", data);
                if (data.status === 'success') {
                    const status = data.verification_status;
                    console.log("[DEBUG] 验证状态:", status);
                    console.log("[DEBUG] 机器码字段:", status.machine_code);
                    console.log("[DEBUG] 永久激活状态:", status.is_permanent_activated);
                    
                    // 更新机器码显示
                    const machineCodeDisplay = document.getElementById('machine-code-display');
                    console.log("[DEBUG] 查找机器码显示元素:", machineCodeDisplay);
                    if (machineCodeDisplay) {
                        if (status.machine_code && status.machine_code.trim() !== '') {
                            console.log("[DEBUG] 准备更新机器码显示，原文本:", machineCodeDisplay.textContent, "新文本:", status.machine_code);
                            machineCodeDisplay.textContent = status.machine_code;
                            console.log("[DEBUG] 机器码更新完成，当前显示:", machineCodeDisplay.textContent);
                        } else {
                            machineCodeDisplay.textContent = '获取中...';
                            console.log("[DEBUG] 机器码为空，显示获取中，当前值:", status.machine_code);
                        }
                    } else {
                        console.error("[DEBUG] 未找到机器码显示元素 #machine-code-display");
                    }
                    
                    // 检查是否为永久激活状态
                    if (status.is_permanent_activated) {
                        console.log("[DEBUG] 系统已永久激活");
                        
                        // 隐藏验证横幅
                        document.getElementById('verification-banner').style.display = 'none';
                        if (document.getElementById('verification-modal').style.display === 'flex') {
                            closeVerificationModal();
                        }
                        
                        // 显示永久激活状态
                        document.getElementById('permanent-activation-status').style.display = 'block';
                        
                        // 添加全页面永久激活样式
                        document.body.classList.add('permanent-activated');
                        
                        // 更新验证状态指示器
                        updateVerificationStatusDisplay('永久授权激活', 'success');
                        
                        // 停止倒计时
                        if (verificationInterval) {
                            clearInterval(verificationInterval);
                            verificationInterval = null;
                        }
                        
                        // 禁用验证按钮并添加专业样式
                        const triggerBtn = document.getElementById('trigger-verification-btn');
                        triggerBtn.disabled = true;
                        triggerBtn.innerHTML = '<i class="bi bi-shield-check"></i> 已永久授权';
                        triggerBtn.classList.remove('btn-info');
                        triggerBtn.classList.add('btn-success', 'btn-permanent-luxury');
                        
                        // 无需禁用覆盖层
                        updateDisabledOverlays(false);
                        
                        return;
                    }
                    
                    // 正常验证逻辑
                    // 更新验证状态
                    if (status.is_verification_needed) {
                        console.log("[DEBUG] 需要验证");
                        // 显示验证横幅
                        document.getElementById('verification-banner').style.display = 'flex';
                        
                        // 设置尝试次数
                        document.getElementById('attempts-count').innerText = status.attempts_left;
                        
                        // 设置倒计时
                        startVerificationCountdown(status.remaining_time);
                        
                        // 更新验证状态指示器
                        updateVerificationStatusDisplay('需要验证', 'warning');
                        
                        // 如果剩余尝试次数少于2次，显示为紧急横幅
                        if (status.attempts_left < 2) {
                            document.getElementById('verification-banner').classList.add('urgent');
                            document.getElementById('verification-banner-text').innerText = 
                                `警告: 验证尝试次数剩余${status.attempts_left}次，验证失败将限制功能!`;
                            
                            // 更新验证状态指示器为危险
                            updateVerificationStatusDisplay('验证危急', 'danger');
                        }
                    } else {
                        console.log("[DEBUG] 无需验证");
                        // 隐藏验证横幅和模态框
                        document.getElementById('verification-banner').style.display = 'none';
                        if (document.getElementById('verification-modal').style.display === 'flex') {
                        closeVerificationModal();
                        }
                        
                        // 停止倒计时
                        if (verificationInterval) {
                            clearInterval(verificationInterval);
                            verificationInterval = null;
                        }
                        
                        // 更新验证状态指示器
                        if (status.is_verified) {
                            updateVerificationStatusDisplay('已验证', 'success');
                        } else {
                            updateVerificationStatusDisplay('无需验证', 'secondary');
                        }
                    }
                    
                    // 更新禁用覆盖层
                    updateDisabledOverlays(status.is_verification_needed);
                } else {
                    console.error('[DEBUG] 获取验证状态失败:', data.message);
                    updateVerificationStatusDisplay('状态检查错误', 'danger');
                }
            })
            .catch(error => {
                console.error('[DEBUG] 获取验证状态网络错误:', error);
                updateVerificationStatusDisplay('网络连接错误', 'danger');
            });
        }

        // 更新验证状态显示
        function updateVerificationStatusDisplay(message, statusType) {
            const statusDisplay = document.getElementById('verification-status-display');
            statusDisplay.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="status-dot bg-${statusType} me-2"></div>
                    <span>${message}</span>
                </div>
            `;
            
            // 修改按钮文本，但不禁用它
            const triggerBtn = document.getElementById('trigger-verification-btn');
            triggerBtn.disabled = false; // 始终允许检查状态
            triggerBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> 检查验证状态';
            
            // 如果正在验证中，更新按钮样式
            if (statusType === 'warning' || statusType === 'danger') {
                triggerBtn.classList.remove('btn-info');
                triggerBtn.classList.add('btn-warning');
            } else {
                triggerBtn.classList.remove('btn-warning');
                triggerBtn.classList.add('btn-info');
            }
        }

        // 显示验证模态框
        function showVerificationModal() {
            document.getElementById('verification-modal').style.display = 'flex';
            document.getElementById('verification-result').style.display = 'none';
            document.getElementById('verification-key').focus();
            
            // 显示弹窗时刷新验证状态以获取最新的机器码
            console.log("[DEBUG] 显示验证弹窗，刷新状态获取机器码");
            checkVerificationStatus();
        }

        // 关闭验证模态框
        function closeVerificationModal() {
            document.getElementById('verification-modal').style.display = 'none';
        }

        // 此函数已被移除，使用5349行定义的verifyKey函数

        // 显示验证结果
        function showVerificationResult(message, type) {
            const resultElement = document.getElementById('verification-result');
            resultElement.innerText = message;
            resultElement.style.display = 'block';
            
            // 清除所有类
            resultElement.className = 'verification-result';
            
            // 添加结果类型
            if (type) {
                resultElement.classList.add(type);
            }
        }

        // 开始验证倒计时
        function startVerificationCountdown(seconds) {
            // 停止现有倒计时
            if (verificationInterval) {
                clearInterval(verificationInterval);
            }
            
            // 设置初始倒计时
            updateCountdownDisplay(seconds);
            
            // 启动倒计时
            verificationInterval = setInterval(() => {
                seconds--;
                
                if (seconds <= 0) {
                    clearInterval(verificationInterval);
                    verificationInterval = null;
                    updateCountdownDisplay(0);
                    
                    // 倒计时结束后重新检查状态
                    checkVerificationStatus();
                } else {
                    updateCountdownDisplay(seconds);
                }
            }, 1000);
        }

        // 更新倒计时显示
        function updateCountdownDisplay(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            const timeString = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            
            document.getElementById('timeout-value').innerText = timeString;
        }

        // 触发验证（管理员功能）
        function triggerVerificationAdmin() {
            const clientId = '{{ client_id }}';
            
            // 修改为仅检查验证状态，而不是触发新的验证
            fetch(`/api/verification/status/${clientId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const status = data.verification_status;
                    let statusText = "未知";
                    let statusClass = "secondary";
                    
                    if (status.is_verification_needed) {
                        statusText = "需要验证";
                        statusClass = status.attempts_left < 2 ? "danger" : "warning";
                    } else if (status.is_verified) {
                        statusText = "已验证";
                        statusClass = "success";
                    } else {
                        statusText = "无需验证";
                        statusClass = "secondary";
                    }
                    
                    // 更新验证状态显示
                    updateVerificationStatusDisplay(statusText, statusClass);
                    
                    alert(`已刷新验证状态: ${statusText}`);
                } else {
                    alert(`获取验证状态失败: ${data.message || "未知错误"}`);
                }
            })
            .catch(error => {
                console.error('检查验证状态失败:', error);
                alert('检查验证状态请求失败，请重试');
            });
        }

        // 在客户端控制按钮区添加触发验证按钮（在DOM加载完成后）
        document.addEventListener('DOMContentLoaded', function() {
            console.log("[DEBUG] DOM加载完成，准备初始化验证组件");
            
            // 在操作按钮组中添加验证按钮
            const controlPanel = document.querySelector('.client-controls .card-body .btn-group');
            if (controlPanel) {
                const verifyBtn = document.createElement('button');
                verifyBtn.className = 'btn btn-warning';
                verifyBtn.innerHTML = '<i class="bi bi-shield-lock"></i> 触发验证';
                verifyBtn.onclick = triggerVerificationAdmin;
                controlPanel.appendChild(verifyBtn);
                console.log("[DEBUG] 已添加验证按钮到控制面板");
            } else {
                console.log("[DEBUG] 未找到控制面板，无法添加验证按钮");
            }
            
            // 添加验证输入框的键盘事件监听
            const verificationKeyInput = document.getElementById('verification-key');
            if (verificationKeyInput) {
                verificationKeyInput.addEventListener('keydown', function(event) {
                    // 如果按下回车键，阻止默认行为并触发验证
                    if (event.key === 'Enter') {
                        console.log("[验证] 检测到回车键，阻止默认行为，手动触发验证");
                        event.preventDefault();
                        verifyKey();
                    }
                });
                console.log("[DEBUG] 已添加验证输入框的键盘事件监听");
            }
            
            // 同样处理Bootstrap模态框中的验证输入框
            const bootstrapVerificationKeyInput = document.getElementById('verificationKey');
            if (bootstrapVerificationKeyInput) {
                bootstrapVerificationKeyInput.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        console.log("[验证] Bootstrap模态框检测到回车键，阻止默认行为");
                        event.preventDefault();
                        document.getElementById('verifyBtn').click();
                    }
                });
                console.log("[DEBUG] 已添加Bootstrap验证输入框的键盘事件监听");
            }
            
            // 初始检查验证状态
            console.log("[DEBUG] 开始初始检查验证状态");
            checkVerificationStatus();
        });

        // 手动触发验证状态检查
        function triggerVerification() {
            // 更新按钮状态，表示正在刷新
            const triggerBtn = document.getElementById('trigger-verification-btn');
            triggerBtn.disabled = true;
            triggerBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 正在刷新...';
            
            // 显示正在检查状态
            updateVerificationStatusDisplay("正在请求客户端刷新状态...", "warning");
            
            // 发送命令到服务器，要求客户端刷新验证状态
            fetch('/api/send_command/{{ client_id }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    type: 'refresh_verification_status'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    // 命令发送成功，等待客户端响应
                    const commandId = data.command_id;
                    updateVerificationStatusDisplay("已发送刷新请求，等待客户端响应...", "info");
                    
                    // 轮询检查命令执行结果
                    checkCommandResult(commandId);
                } else {
                    // 命令发送失败
                    updateVerificationStatusDisplay("刷新请求发送失败: " + data.message, "danger");
                    triggerBtn.disabled = false;
                    triggerBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> 重试刷新';
                }
            })
            .catch(error => {
                console.error("发送刷新命令错误:", error);
                updateVerificationStatusDisplay("发送刷新命令出错，请重试", "danger");
                triggerBtn.disabled = false;
                triggerBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> 重试刷新';
            });
        }
        
        // 检查命令执行结果
        function checkCommandResult(commandId) {
            let attempts = 0;
            const maxAttempts = 10; // 最多尝试10次
            
            function poll() {
                attempts++;
                fetch(`/api/command_status/{{ client_id }}/${commandId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === "complete") {
                            // 命令执行完成，检查结果
                            if (data.result && data.result.success) {
                                // 命令执行成功，获取最新状态
                                updateVerificationStatusDisplay("状态已刷新，获取最新数据...", "success");
                                // 延迟一下再获取状态，确保客户端已经同步到服务器
                                setTimeout(checkVerificationStatus, 1000);
                            } else {
                                // 命令执行失败
                                updateVerificationStatusDisplay("刷新失败: " + (data.result ? data.result.message : "未知错误"), "danger");
                                resetButton();
                            }
                        } else if (data.status === "pending") {
                            // 命令仍在执行中，继续轮询
                            if (attempts < maxAttempts) {
                                setTimeout(poll, 1000);
                            } else {
                                // 超过最大尝试次数
                                updateVerificationStatusDisplay("刷新超时，请重试", "warning");
                                resetButton();
                            }
                        } else {
                            // 其他状态（如错误）
                            updateVerificationStatusDisplay("刷新状态出错: " + data.message, "danger");
                            resetButton();
                        }
                    })
                    .catch(error => {
                        console.error("检查命令状态错误:", error);
                        updateVerificationStatusDisplay("检查刷新状态出错", "danger");
                        resetButton();
                    });
            }
            
            // 开始轮询
            poll();
            
            // 重置按钮状态
            function resetButton() {
                const triggerBtn = document.getElementById('trigger-verification-btn');
                triggerBtn.disabled = false;
                triggerBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> 检查验证状态';
            }
        }

        // 更新验证状态UI
        function updateVerificationStatusUI(status) {
            console.log("[DEBUG] 更新验证状态UI:", status);
            
            const statusDisplay = document.getElementById('verification-status-display');
            if (!statusDisplay) {
                console.error("[DEBUG] 错误: 未找到verification-status-display元素");
                return;
            }
            
            const banner = document.getElementById('verification-banner');
            if (!banner) {
                console.error("[DEBUG] 错误: 未找到verification-banner元素");
            }
            
            // 检查是否为永久激活状态
            if (status.is_permanent_activated) {
                console.log("[DEBUG] UI更新: 检测到永久激活状态");
                
                // 隐藏验证横幅
                if (banner) {
                    banner.style.display = 'none';
                }
                
                // 显示永久激活状态
                const permStatus = document.getElementById('permanent-activation-status');
                if (permStatus) {
                    permStatus.style.display = 'block';
                }
                
                // 添加全页面永久激活样式
                document.body.classList.add('permanent-activated');
                
                // 更新验证状态指示器
                statusDisplay.innerHTML = `
                    <div class="d-flex align-items-center">
                        <div class="status-dot bg-success me-2"></div>
                        <span>永久授权激活</span>
                    </div>
                `;
                
                // 更新验证按钮并添加专业样式
                const triggerBtn = document.getElementById('trigger-verification-btn');
                if (triggerBtn) {
                    triggerBtn.disabled = true;
                    triggerBtn.innerHTML = '<i class="bi bi-shield-check"></i> 已永久授权';
                    triggerBtn.classList.remove('btn-info');
                    triggerBtn.classList.add('btn-success', 'btn-permanent-luxury');
                }
                
                return;
            }
            
            let statusDot, statusText;
            
            // 首先清空当前状态
            statusDisplay.innerHTML = '';
            
            if (status.is_verification_needed) {
                console.log("[DEBUG] UI更新: 需要验证, 已验证状态:", status.is_verified);
                // 需要验证
                if (status.is_verified) {
                    // 已通过验证
                    statusDot = '<div class="status-dot bg-success me-2"></div>';
                    statusText = '<span>已通过验证</span>';
                } else {
                    // 需要验证但未通过
                    statusDot = '<div class="status-dot bg-danger me-2"></div>';
                    statusText = '<span>需要验证</span>';
                    
                    // 显示验证横幅
                    if (banner) {
                        banner.style.display = 'flex';
                        
                        // 更新倒计时信息
                        const hours = Math.floor(status.remaining_time / 3600);
                        const minutes = Math.floor((status.remaining_time % 3600) / 60);
                        const seconds = Math.floor(status.remaining_time % 60);
                        const timeFormatted = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                        
                        const bannerText = document.getElementById('verification-banner-text');
                        if (bannerText) {
                            bannerText.innerHTML = `此客户端需要验证。剩余尝试次数: ${status.attempts_left}，验证倒计时: ${timeFormatted}`;
                        } else {
                            console.error("[DEBUG] 错误: 未找到verification-banner-text元素");
                        }
                        
                        // 尝试打开验证弹窗
                        if (!document.cookie.includes('verification_modal_shown')) {
                            console.log("[DEBUG] 尝试自动打开验证弹窗");
                            setTimeout(function() {
                                showVerificationModal();
                                document.cookie = "verification_modal_shown=true; max-age=60"; // 1分钟内不再自动弹出
                            }, 1000);
                        }
                    }
                }
            } else {
                console.log("[DEBUG] UI更新: 无需验证");
                // 无需验证
                statusDot = '<div class="status-dot bg-secondary me-2"></div>';
                statusText = '<span>无需验证</span>';
                
                // 隐藏验证横幅
                if (banner) {
                    banner.style.display = 'none';
                }
            }
            
            // 创建状态显示
            const statusContainer = document.createElement('div');
            statusContainer.className = 'd-flex align-items-center';
            statusContainer.innerHTML = statusDot + statusText;
            
            // 添加验证详情(如果需要验证)
            if (status.is_verification_needed) {
                const detailsContainer = document.createElement('div');
                detailsContainer.className = 'mt-2 small';
                
                // 格式化时间
                const endTime = new Date(status.end_time * 1000).toLocaleString();
                
                detailsContainer.innerHTML = `
                    <div>剩余尝试: ${status.attempts_left}次</div>
                    <div>截止时间: ${endTime}</div>
                `;
                
                statusDisplay.appendChild(statusContainer);
                statusDisplay.appendChild(detailsContainer);
            } else {
                statusDisplay.appendChild(statusContainer);
            }
            
            console.log("[DEBUG] 验证状态UI更新完成");
        }
        
        // 显示验证弹窗
        function showVerificationModal() {
            const modal = document.getElementById('verification-modal');
            if (modal) {
                modal.style.display = 'flex';
                
                // 先调用检查验证状态来更新机器码等信息
                console.log("[MODAL] 显示验证弹窗，刷新验证状态");
                checkVerificationStatus();
                
                // 更新验证弹窗信息
                fetch(`/api/verification/status/{{ client_id }}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === "success") {
                            const status = data.verification_status;
                            document.getElementById('attempts-count').textContent = status.attempts_left;
                            
                            // 格式化倒计时
                            const hours = Math.floor(status.remaining_time / 3600);
                            const minutes = Math.floor((status.remaining_time % 3600) / 60);
                            const seconds = status.remaining_time % 60;
                            
                            document.getElementById('timeout-value').textContent = 
                                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                        }
                    });
            }
        }
        
        // 关闭验证弹窗
        function closeVerificationModal() {
            document.getElementById('verification-modal').style.display = 'none';
            document.getElementById('verification-result').style.display = 'none';
        }
        
        // 复制机器码
        function copyMachineCode() {
            const machineCodeElement = document.getElementById('machine-code-display');
            const copyBtn = document.getElementById('copy-machine-code-btn');
            
            if (machineCodeElement && machineCodeElement.textContent !== '获取中...') {
                const machineCode = machineCodeElement.textContent;
                
                // 尝试使用现代API复制
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(machineCode).then(function() {
                        // 复制成功，更新按钮显示
                        const originalIcon = copyBtn.innerHTML;
                        copyBtn.innerHTML = '<i class="bi bi-check"></i>';
                        copyBtn.className = 'btn btn-sm btn-success';
                        
                        setTimeout(function() {
                            copyBtn.innerHTML = originalIcon;
                            copyBtn.className = 'btn btn-sm btn-outline-primary';
                        }, 2000);
                        
                        console.log('[COPY] 机器码复制成功:', machineCode);
                    }, function(err) {
                        console.error('[COPY] 复制失败:', err);
                        fallbackCopyMachineCode(machineCode);
                    });
                } else {
                    // 使用兼容性方法
                    fallbackCopyMachineCode(machineCode);
                }
            } else {
                console.warn('[COPY] 机器码还未获取，无法复制');
            }
        }
        
        // 兼容性复制方法
        function fallbackCopyMachineCode(text) {
            const copyBtn = document.getElementById('copy-machine-code-btn');
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    // 复制成功，更新按钮显示
                    const originalIcon = copyBtn.innerHTML;
                    copyBtn.innerHTML = '<i class="bi bi-check"></i>';
                    copyBtn.className = 'btn btn-sm btn-success';
                    
                    setTimeout(function() {
                        copyBtn.innerHTML = originalIcon;
                        copyBtn.className = 'btn btn-sm btn-outline-primary';
                    }, 2000);
                    
                    console.log('[COPY] 机器码复制成功（兼容模式）:', text);
                } else {
                    console.error('[COPY] 兼容模式复制失败');
                }
            } catch (err) {
                console.error('[COPY] 兼容模式复制异常:', err);
            }
            
            document.body.removeChild(textArea);
        }
        
        // 验证密钥
        function verifyKey() {
            const key = document.getElementById('verification-key').value.trim();
            if (!key) {
                document.getElementById('verification-result').textContent = "请输入密钥";
                document.getElementById('verification-result').className = "verification-result error";
                document.getElementById('verification-result').style.display = 'block';
                return;
            }
            
            // 禁用提交按钮并保存原始onclick事件
            const submitBtn = document.querySelector('#verification-modal .btn-primary');
            const originalOnClick = submitBtn.onclick; // 保存原始的onclick事件处理函数
            submitBtn.originalOnClick = originalOnClick; // 存储原始事件供后续恢复
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 验证中...';
            
            // 显示验证中的状态
            const resultEl = document.getElementById('verification-result');
            resultEl.textContent = "正在验证，请稍候...";
            resultEl.className = "verification-result";
            resultEl.style.display = 'block';
            
            // 发送验证请求
            fetch(`/api/verification/verify/{{ client_id }}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ key: key })
            })
            .then(response => response.json())
            .then(data => {
                console.log("验证请求结果:", data);
                
                if (data.status === "success" && data.command_id) {
                    // 验证请求已发送，但需要等待客户端验证结果
                    resultEl.textContent = "验证请求已发送，正在等待结果...";
                    
                    // 获取命令ID并轮询检查结果
                    const commandId = data.command_id;
                    pollVerificationResult(commandId, submitBtn);
                } else {
                    // 请求发送失败
                    resultEl.textContent = data.message || "发送验证请求失败";
                    resultEl.className = "verification-result error";
                    
                    // 恢复按钮状态
                    submitBtn.disabled = false;
                    submitBtn.textContent = "验证";
                    // 恢复原始的onclick事件
                    if (submitBtn.originalOnClick) {
                        submitBtn.onclick = submitBtn.originalOnClick;
                    }
                    
                    // 刷新验证状态
                    checkVerificationStatus();
                }
            })
            .catch(error => {
                console.error("验证请求错误:", error);
                resultEl.textContent = "请求错误: " + error.message;
                resultEl.className = "verification-result error";
                resultEl.style.display = 'block';
                
                submitBtn.disabled = false;
                submitBtn.textContent = "验证";
                // 恢复原始的onclick事件
                if (submitBtn.originalOnClick) {
                    submitBtn.onclick = submitBtn.originalOnClick;
                }
            });
        }

        // 轮询检查验证命令的执行结果
        function pollVerificationResult(commandId, submitBtn) {
            let attempts = 0;
            const maxAttempts = 120; // 增加到120次，每次1秒，总共2分钟
            const resultEl = document.getElementById('verification-result');
            let waitingForResponse = true; // 跟踪是否还在等待响应
            
            console.log(`[验证轮询] 开始轮询验证结果, 命令ID: ${commandId}`);
            
            function checkResult() {
                if (!waitingForResponse) {
                    console.log(`[验证轮询] 轮询已取消，结束轮询`);
                    return;
                }
                
                attempts++;
                console.log(`[验证轮询] 第${attempts}/${maxAttempts}次查询, 命令ID: ${commandId}`);
                
                // 检查命令执行结果
                fetch(`/api/verification/command/${commandId}`, {
                    cache: 'no-store', // 禁用缓存，确保每次都获取最新数据
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache' // 额外的缓存控制
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP错误: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log(`[验证轮询] 第${attempts}次查询结果:`, data);
                        
                        if (data.status === "success") {
                            // 检查命令状态
                            if (data.command_status === "completed") {
                                // 命令已完成，检查验证结果
                                console.log("[验证轮询] 验证命令已完成，结果:", data);
                                waitingForResponse = false; // 已收到最终结果，不需要继续轮询
                                
                                const isSuccess = data.success === true;
                                
                                if (isSuccess) {
                                    // 验证成功
                                    resultEl.textContent = "验证成功！系统功能已恢复。";
                                    resultEl.className = "verification-result success";
                                    
                                    console.log("[验证轮询] 验证成功，完整响应数据:", data);
                                    
                                    // 恢复按钮状态
                                    submitBtn.disabled = false;
                                    submitBtn.textContent = "确定";
                                    
                                    // 更改按钮功能为关闭模态框而不是刷新页面
                                    submitBtn.onclick = function() {
                                        closeVerificationModal();
                                        
                                        // 刷新验证状态
                                        checkVerificationStatus();
                                    };
                                } else {
                                    // 验证失败
                                    let errorMessage = data.message || "验证失败";
                                    
                                    // 检查频率限制消息
                                    if (errorMessage.includes("过于频繁") || errorMessage.includes("请等待")) {
                                        errorMessage = `${errorMessage}。系统将在几秒后自动重试...`;
                                        resultEl.className = "verification-result warning";
                                        
                                        // 稍后自动重试
                                        setTimeout(() => {
                                            console.log("[验证轮询] 检测到频率限制，10秒后自动重试");
                                            // 清空输入框
                                            document.getElementById('verification-key').value = '';
                                            // 恢复按钮状态
                                            submitBtn.disabled = false;
                                            submitBtn.textContent = "验证";
                                            if (submitBtn.originalOnClick) {
                                                submitBtn.onclick = submitBtn.originalOnClick;
                                            }
                                            // 更新结果显示
                                            resultEl.textContent = "已准备好重新验证";
                                            resultEl.className = "verification-result";
                                        }, 10000);
                                    } else {
                                        resultEl.className = "verification-result error";
                                        
                                        // 恢复按钮状态
                                        submitBtn.disabled = false;
                                        submitBtn.textContent = "重新验证";
                                        // 恢复原始的onclick事件
                                        if (submitBtn.originalOnClick) {
                                            submitBtn.onclick = submitBtn.originalOnClick;
                                        }
                                        
                                        // 清空输入框
                                        document.getElementById('verification-key').value = '';
                                    }
                                    
                                    resultEl.textContent = errorMessage;
                                    console.log("[验证轮询] 验证失败，完整响应数据:", data);
                                    
                                    // 检查并显示尝试次数
                                    if (data.attempts_left !== undefined) {
                                        const attemptsEl = document.getElementById('attempts-count');
                                        if (attemptsEl) {
                                            attemptsEl.textContent = data.attempts_left;
                                            console.log("[验证轮询] 更新尝试次数为:", data.attempts_left);
                                            // 如果消息中没有包含尝试次数，则添加
                                            if (!resultEl.textContent.includes("尝试次数") && !resultEl.textContent.includes("频繁")) {
                                                resultEl.textContent += `，剩余尝试次数: ${data.attempts_left}`;
                                            }
                                        }
                                    }
                                }
                                
                                // 在数据处理完毕后刷新验证状态
                                setTimeout(checkVerificationStatus, 1000);
                            } else {
                                // 命令还在执行中或等待执行
                                if (data.message && data.message.includes("等待")) {
                                    resultEl.textContent = "正在等待客户端处理验证请求...（1分钟内）";
                                }
                                
                                // 无论尝试多少次，只要命令未完成，就继续轮询
                                if (attempts < maxAttempts) {
                                    // 每次轮询间隔1秒
                                    setTimeout(checkResult, 1000);
                                } else {
                                    // 超时处理
                                    waitingForResponse = false;
                                    resultEl.textContent = "验证请求超时，请重试";
                                    resultEl.className = "verification-result error";
                                    
                                    console.error("[验证轮询] 验证请求超时，已达到最大尝试次数:", maxAttempts);
                                    
                                    // 强制刷新状态
                                    fetch(`/api/send_command/{{ client_id }}`, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({ type: 'refresh_verification_status' })
                                    })
                                    .then(response => response.json())
                                    .then(data => {
                                        console.log("[验证轮询] 已发送刷新验证状态命令:", data);
                                        
                                        // 恢复按钮状态
                                        submitBtn.disabled = false;
                                        submitBtn.textContent = "验证";
                                        
                                        // 恢复原始的onclick事件
                                        if (submitBtn.originalOnClick) {
                                            submitBtn.onclick = submitBtn.originalOnClick;
                                        }
                                        
                                        // 一段时间后刷新验证状态
                                        setTimeout(checkVerificationStatus, 3000);
                                    });
                                }
                            }
                        } else {
                            console.error("[验证轮询] 验证命令状态API返回错误:", data.message);
                            
                            // 继续轮询如果次数未超限
                            if (attempts < maxAttempts) {
                                setTimeout(checkResult, 1000);
                            } else {
                                waitingForResponse = false;
                                resultEl.textContent = "验证状态查询失败:" + (data.message || "未知错误");
                                resultEl.className = "verification-result error";
                                
                                // 恢复按钮状态
                                submitBtn.disabled = false;
                                submitBtn.textContent = "验证";
                                // 恢复原始的onclick事件
                                if (submitBtn.originalOnClick) {
                                    submitBtn.onclick = submitBtn.originalOnClick;
                                }
                            }
                        }
                    })
                    .catch(error => {
                        console.error("[验证轮询] 验证命令状态查询出错:", error);
                        
                        // 继续轮询如果次数未超限
                        if (attempts < maxAttempts) {
                            setTimeout(checkResult, 1000);
                        } else {
                            waitingForResponse = false;
                            resultEl.textContent = "验证请求处理错误: " + error.message;
                            resultEl.className = "verification-result error";
                            
                            // 恢复按钮状态
                            submitBtn.disabled = false;
                            submitBtn.textContent = "验证";
                            // 恢复原始的onclick事件
                            if (submitBtn.originalOnClick) {
                                submitBtn.onclick = submitBtn.originalOnClick;
                            }
                        }
                    });
            }
            
            // 开始第一次检查
            checkResult();
            
            // 返回取消函数
            return function cancelPolling() {
                waitingForResponse = false;
                console.log(`[验证轮询] 轮询已手动取消`);
            };
        }

        // 添加一个检查函数，判断命令是否在验证期间允许使用
        function isCommandAllowedDuringVerification(commandType) {
            // 这些命令在验证期间始终允许
            const allowedCommands = [
                'browse_files', 
                'read_file', 
                'download_file', 
                'list_directory',
                'refresh_verification_status',
                'verify'
            ];
            
            return allowedCommands.includes(commandType);
        }

        // 确保验证期间允许的功能按钮可用
        function ensureAllowedButtonsEnabled() {
            // 检查验证状态
            fetch(`/api/verification/status/{{ client_id }}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const status = data.verification_status;
                        
                        // 如果需要验证且未验证成功
                        if (status.is_verification_needed && !status.is_verified) {
                            console.log("验证模式：启用文件浏览和验证状态刷新按钮");
                            
                            // 确保文件浏览相关按钮可用
                            document.querySelectorAll('[data-cmd="browse_files"], [onclick*="browseRootDirectories"], [onclick*="browseDirectory"]').forEach(btn => {
                                btn.disabled = false;
                            });
                            
                            // 确保验证状态刷新按钮可用
                            document.querySelectorAll('[data-cmd="refresh_verification_status"], #trigger-verification-btn').forEach(btn => {
                                btn.disabled = false;
                            });
                            
                            // 对其他按钮进行检查，如果不在允许列表中，则禁用
                            document.querySelectorAll('button[data-cmd]:not([data-cmd="browse_files"]):not([data-cmd="read_file"]):not([data-cmd="download_file"]):not([data-cmd="list_directory"]):not([data-cmd="refresh_verification_status"]):not([data-cmd="verify"])').forEach(btn => {
                                btn.disabled = true;
                                btn.setAttribute('title', '需要验证后才能使用此功能');
                            });
                        }
                    }
                })
                .catch(error => {
                    console.error('检查验证状态失败:', error);
                });
        }

        // 页面加载完成后调用
        document.addEventListener('DOMContentLoaded', function() {
            // 检查并确保验证期间允许的按钮可用
            ensureAllowedButtonsEnabled();
            
            // 每30秒检查一次
            setInterval(ensureAllowedButtonsEnabled, 30000);
        });

        // 全局变量，存储验证状态刷新定时器
        let verificationStatusTimer = null;

        // 页面加载完成后立即检查验证状态并设置定时刷新
        document.addEventListener('DOMContentLoaded', function() {
            console.log("页面加载完成，初始化验证状态检查");
            
            // 立即执行一次验证状态检查
            checkVerificationStatus();
            
            // 清除可能已存在的定时器
            if (verificationStatusTimer) {
                clearInterval(verificationStatusTimer);
            }
            
            // 设置新的定时器，每20秒检查一次
            verificationStatusTimer = setInterval(function() {
                console.log("定时执行验证状态检查");
                checkVerificationStatus();
            }, 20000);
        });

        // 修改验证状态检查函数，添加机器码获取逻辑
        function checkVerificationStatus() {
            console.log("正在检查客户端验证状态...");
            const clientId = '{{ client_id }}';
            
            fetch(`/api/verification/status/${clientId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                cache: 'no-store' // 禁用缓存，确保每次都获取最新数据
            })
            .then(response => response.json())
            .then(data => {
                console.log("验证状态检查结果:", data);
                if (data.status === 'success') {
                    const status = data.verification_status;
                    
                    // 更新机器码显示
                    console.log("[MACHINE_CODE] 机器码信息:", status.machine_code || "未找到机器码");
                    const machineCodeElement = document.getElementById('machine-code-display');
                    if (machineCodeElement) {
                        if (status.machine_code) {
                            machineCodeElement.textContent = status.machine_code;
                            console.log("[MACHINE_CODE] 已更新机器码显示:", status.machine_code);
                        } else {
                            machineCodeElement.textContent = "获取中...";
                            console.log("[MACHINE_CODE] 机器码为空，显示获取中");
                        }
                    } else {
                        console.error("[MACHINE_CODE] 未找到机器码元素: machine-code-display");
                    }

                    
                    // 更新UI显示
                    updateVerificationStatusUI(status);
                    
                    // 更新验证状态
                    if (status.is_verification_needed) {
                        // 显示验证横幅
                        document.getElementById('verification-banner').style.display = 'flex';
                        
                        // 设置尝试次数
                        document.getElementById('attempts-count').innerText = status.attempts_left;
                        
                        // 设置倒计时
                        startVerificationCountdown(status.remaining_time);
                        
                        // 更新验证状态指示器
                        updateVerificationStatusDisplay('需要验证', 'warning');
                        
                        // 如果剩余尝试次数少于2次，显示为紧急横幅
                        if (status.attempts_left < 2) {
                            document.getElementById('verification-banner').classList.add('urgent');
                            document.getElementById('verification-banner-text').innerText = 
                                `警告: 验证尝试次数剩余${status.attempts_left}次，验证失败将限制功能!`;
                            
                            // 更新验证状态指示器为危急
                            updateVerificationStatusDisplay('验证危急', 'danger');
                        }
                    } else {
                        // 隐藏验证横幅和模态框
                        document.getElementById('verification-banner').style.display = 'none';
                        if (document.getElementById('verification-modal').style.display === 'flex') {
                            closeVerificationModal();
                        }
                        
                        // 停止倒计时
                        if (verificationInterval) {
                            clearInterval(verificationInterval);
                            verificationInterval = null;
                        }
                        
                        // 更新验证状态指示器
                        if (status.is_verified) {
                            updateVerificationStatusDisplay('已验证', 'success');
                        } else {
                            updateVerificationStatusDisplay('无需验证', 'secondary');
                        }
                    }
                    
                    // 更新禁用覆盖层
                    updateDisabledOverlays(status.is_verification_needed);
                } else {
                    console.error('获取验证状态失败:', data.message);
                    updateVerificationStatusDisplay('状态检查错误', 'danger');
                }
            })
            .catch(error => {
                console.error('获取验证状态网络错误:', error);
                updateVerificationStatusDisplay('网络连接错误', 'danger');
            });
        }
    </script>

    <!-- 下载文件弹窗 -->
    <div class="modal fade" id="downloadedFilesModal" tabindex="-1" aria-labelledby="downloadedFilesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="downloadedFilesModalLabel">已下载文件列表</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">有效期设置</h6>
                            </div>
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <div class="input-group">
                                            <input type="number" id="expiryValueInput" class="form-control" min="0" value="5" placeholder="数值">
                                            <select id="expiryUnitSelect" class="form-select" style="max-width: 100px;">
                                                <option value="minutes" selected>分钟</option>
                                                <option value="hours">小时</option>
                                                <option value="days">天</option>
                                            </select>
                                        </div>
                                        <small class="form-text text-muted">0表示永不过期</small>
                                    </div>
                                    <div class="col-md-4">
                                        <button id="saveExpiryBtn" class="btn btn-primary">
                                            <i class="bi bi-save"></i> 保存设置
                                        </button>
                                    </div>
                                </div>
                                <div class="mt-2" id="currentExpirySetting"></div>
                                <div id="expirySettingResult" class="mt-2 d-none"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="filesLoadingIndicator" class="text-center py-3 d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">正在加载...</span>
                        </div>
                        <p class="mt-2">正在获取文件列表，请稍候...</p>
                    </div>
                    <div id="filesErrorMsg" class="alert alert-danger d-none"></div>
                    <div id="filesList" class="d-none">
                        <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>文件名</th>
                                        <th>大小</th>
                                        <th>修改时间</th>
                                    <th>剩余有效期</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="downloadedFilesTableBody">
                                    <!-- 文件列表将在此动态加载 -->
                                </tbody>
                            </table>
                    </div>
                    <div id="noFilesMsg" class="alert alert-info d-none">
                        暂无下载的文件
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" onclick="loadDownloadedFiles()">
                        <i class="bi bi-arrow-clockwise"></i> 刷新
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加验证CSS样式 -->
    <style>
    /* 验证横幅样式 */
    .verification-banner {
        display: flex;
        background-color: #f8d7da;
        color: #721c24;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 8px;
        border-left: 5px solid #f5c6cb;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        position: relative;
        z-index: 1000;
    }

    .verification-banner .banner-content {
        display: flex;
        align-items: center;
        width: 100%;
        gap: 15px;
    }

    .verification-banner i {
        font-size: 24px;
        flex-shrink: 0;
    }

    .verification-banner span {
        flex-grow: 1;
        font-size: 15px;
    }

    .verification-banner button {
        flex-shrink: 0;
        white-space: nowrap;
        padding: 8px 15px;
        font-weight: 500;
    }

    .verification-banner.urgent {
        background-color: #dc3545;
        color: #fff;
        border-left: 5px solid #a71d2a;
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }

    /* 验证弹窗样式 */
    .verification-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 2000;
        justify-content: center;
        align-items: center;
    }

    .verification-modal-content {
        background-color: #fff;
        padding: 30px;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        position: relative;
    }

    .verification-modal-close {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 24px;
        cursor: pointer;
        color: #aaa;
    }

    .verification-modal-close:hover,
    .verification-modal-close:focus {
        color: #333;
        text-decoration: none;
    }

    .verification-input {
        width: 100%;
        padding: 12px 15px;
        margin: 15px 0;
        border: 2px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
        box-sizing: border-box;
    }

    .verification-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        font-size: 14px;
        color: #666;
    }

    .verification-result {
        padding: 10px 15px;
        margin: 15px 0;
        border-radius: 4px;
        background-color: #f8f9fa;
        color: #333;
    }

    .verification-result.success {
        background-color: #d4edda;
        color: #155724;
        border-left: 4px solid #28a745;
    }

    .verification-result.error {
        background-color: #f8d7da;
        color: #721c24;
        border-left: 4px solid #dc3545;
    }
    </style>

    <!-- 添加验证弹窗模态框 -->
    <div class="modal fade" id="verificationModal" tabindex="-1" aria-labelledby="verificationModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="verificationModalLabel">客户端验证</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-info">
              <i class="bi bi-info-circle-fill"></i>
              该客户端需要进行验证。请在客户端电脑上查找 verification_key_xxxxxx.txt 文件，获取验证密钥。
            </div>
            <div id="verificationStatus" class="alert" style="display: none;"></div>
            <form id="verificationForm" onsubmit="event.preventDefault(); $('#verifyBtn').click(); return false;">
              <div class="mb-3">
                <label for="verificationKey" class="form-label">验证密钥</label>
                <input type="text" class="form-control" id="verificationKey" placeholder="请输入验证密钥" required>
                <div class="form-text">密钥区分大小写，请确保输入准确</div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <span class="me-auto text-muted" id="verificationAttempts"></span>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            <button type="button" class="btn btn-primary" id="verifyBtn">验证</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 添加验证成功提示模态框 -->
    <div class="modal fade" id="verificationSuccessModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">验证成功</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-success">
              <i class="bi bi-check-circle-fill"></i>
              验证成功！客户端所有功能已恢复。
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">确定</button>
          </div>
        </div>
      </div>
    </div>

    <script>
    // ... existing code ...

    // 添加验证相关JavaScript代码
    $(document).ready(function() {
      // 检查验证状态
      function checkVerificationStatus() {
        fetch(`/api/verification/status/{{ client_id }}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    const status = data.verification_status;
                    console.log("[DEBUG] 验证状态API响应数据:", status);
                    console.log("[DEBUG] 永久激活状态:", status.is_permanent_activated);
                    
                    // 检查是否为永久激活状态
                    if (status.is_permanent_activated) {
                        console.log("[DEBUG] 系统已永久激活，更新UI");
                        
                        // 隐藏验证横幅
                        const banner = document.getElementById('verification-banner');
                        if (banner) {
                            banner.style.display = 'none';
                        }
                        
                        // 显示永久激活状态
                        const permStatus = document.getElementById('permanent-activation-status');
                        if (permStatus) {
                            permStatus.style.display = 'block';
                        }
                        
                        // 添加全页面永久激活样式
                        document.body.classList.add('permanent-activated');
                        
                        // 更新验证状态指示器
                        const statusDisplay = document.getElementById('verification-status-display');
                        if (statusDisplay) {
                            statusDisplay.innerHTML = `
                                <div class="d-flex align-items-center">
                                    <div class="status-dot bg-success me-2"></div>
                                    <span>永久授权激活</span>
                                </div>
                            `;
                        }
                        
                        // 更新验证按钮并添加专业样式
                        const triggerBtn = document.getElementById('trigger-verification-btn');
                        if (triggerBtn) {
                            triggerBtn.disabled = true;
                            triggerBtn.innerHTML = '<i class="bi bi-shield-check"></i> 已永久授权';
                            triggerBtn.classList.remove('btn-info');
                            triggerBtn.classList.add('btn-success', 'btn-permanent-luxury');
                        }
                        
                        return;
                    }
                    
                    // 正常验证状态处理
                    updateVerificationStatusUI(status);
                } else {
                    console.error("获取验证状态失败:", data.message);
                }
            })
            .catch(error => {
                console.error("请求验证状态错误:", error);
            });
      }
      
      // 首次加载页面时检查验证状态
      checkVerificationStatus();
      
      // 设置定期检查验证状态（每30秒）
      setInterval(checkVerificationStatus, 30000);
      
      // 确保triggerVerification函数可在全局范围内访问
      window.checkVerificationStatus = checkVerificationStatus;
      
      // 验证按钮点击事件
      $("#verifyBtn").on("click", function() {
        const key = $("#verificationKey").val().trim();
        if (!key) {
          showVerificationAlert("请输入验证密钥", "danger");
          return;
        }
        
        // 禁用按钮，显示加载状态
        const $verifyBtn = $("#verifyBtn");
        $verifyBtn.prop("disabled", true);
        $verifyBtn.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 验证中...');
        
        // 显示正在处理的消息
        showVerificationAlert("正在提交验证请求...", "info");
        
        // 发送验证请求
        $.ajax({
          url: "/api/verification/verify/{{ client_id }}",
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify({ key: key }),
          success: function(response) {
            // 验证请求已发送到客户端
            if (response.status === "success") {
              // 获取命令ID
              const commandId = response.command_id;
              showVerificationAlert("验证请求已发送，正在等待客户端验证结果...", "info");
            
              // 轮询验证结果
              pollBootstrapVerificationResult(commandId, $verifyBtn);
            } else {
              // 验证请求发送失败
              showVerificationAlert("验证请求发送失败: " + (response.message || "未知错误"), "danger");
              $verifyBtn.prop("disabled", false);
              $verifyBtn.text("验证");
            }
          },
          error: function(xhr) {
            let errorMessage = "验证请求失败";
            try {
              const response = JSON.parse(xhr.responseText);
              errorMessage = response.message || errorMessage;
            } catch(e) {}
            
            showVerificationAlert(errorMessage, "danger");
            $verifyBtn.prop("disabled", false);
            $verifyBtn.text("验证");
          }
        });
      });
      
      // 轮询验证命令结果
      function pollBootstrapVerificationResult(commandId, $button) {
        let attempts = 0;
        const maxAttempts = 15; // 最多尝试15次，每次1秒
        
        function checkResult() {
          attempts++;
          
          // 发送请求获取命令执行结果
          $.ajax({
            url: `/api/verification/command/${commandId}`,
            method: "GET",
            success: function(data) {
              if (data.status === "success") {
                // 检查命令状态
                if (data.command_status === "completed") {
                  // 命令已完成，检查验证结果
                  if (data.verification_status === "success") {
                    // 验证成功
                    showVerificationAlert("验证成功！系统功能已恢复", "success");
                    $("#verificationModal").modal("hide");
                    $("#verificationSuccessModal").modal("show");
                    
                    // 不刷新页面，只更新状态
                    checkVerificationStatus();
                    console.log("[重要] 验证成功，更新状态，不刷新页面");
                    
                    // 成功后3秒自动关闭成功提示
                    setTimeout(function() {
                      $("#verificationSuccessModal").modal("hide");
                      console.log("[重要] 关闭成功提示模态框");
                    }, 3000);
                  } else {
                    // 验证失败
                    showVerificationAlert(data.message || "验证失败", "danger");
            
            // 更新尝试次数
                    if (data.attempts_left !== undefined) {
                      $("#verificationAttempts").text(`剩余尝试次数: ${data.attempts_left}`);
                    }
                    
                    // 恢复按钮状态
                    $button.prop("disabled", false);
                    $button.text("验证");
                  }
                } else {
                  // 命令仍在执行，继续轮询
                  if (attempts < maxAttempts) {
                    setTimeout(checkResult, 1000);
                  } else {
                    // 超时
                    showVerificationAlert("验证请求超时，请重试", "warning");
                    $button.prop("disabled", false);
                    $button.text("验证");
                  }
                }
              } else {
                // API错误
                showVerificationAlert(data.message || "检查验证结果失败", "danger");
                $button.prop("disabled", false);
                $button.text("验证");
            }
            },
            error: function(xhr) {
              showVerificationAlert("检查验证结果失败: " + (xhr.responseText || "网络错误"), "danger");
              $button.prop("disabled", false);
              $button.text("验证");
          }
        });
        }
        
        // 开始轮询
        setTimeout(checkResult, 1000);
      }
      
      // 显示验证提示
      function showVerificationAlert(message, type) {
        const alertDiv = $("#verificationStatus");
        alertDiv.removeClass("alert-success alert-danger alert-warning")
               .addClass(`alert-${type}`)
               .text(message)
               .show();
      }
      
      // 初始检查
      checkVerificationStatus();
      
      // 每20秒检查一次验证状态
      setInterval(checkVerificationStatus, 20000);
      
      // Enter键提交表单
      $("#verificationKey").on("keypress", function(e) {
        if (e.which === 13) {
          e.preventDefault();
          $("#verifyBtn").click();
        }
      });
    });

    // ... existing code ...
    </script>

    <!-- 添加在验证状态显示区下方 -->
    <div class="card mb-3" id="debug-panel" style="display: none;">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">调试面板</h5>
        </div>
        <div class="card-body">
            <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-primary" onclick="debugCheckVerification()">强制检查验证状态</button>
                <button class="btn btn-warning" onclick="debugToggleLogging()">切换详细日志</button>
                <button class="btn btn-danger" onclick="debugResetPage()">重置页面状态</button>
            </div>
            <div class="mt-3">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="debugShowPanel" onchange="toggleDebugPanel()">
                    <label class="form-check-label" for="debugShowPanel">显示调试面板</label>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加调试工具的JavaScript代码 -->
    <script>
        // 强制检查验证状态
        function debugCheckVerification() {
            console.log("[调试工具] 手动强制检查验证状态");
            try {
                if (typeof checkVerificationStatus === 'function') {
                    checkVerificationStatus();
                    alert("验证状态检查已执行，请查看控制台输出");
                } else {
                    console.error("[调试工具] 错误: checkVerificationStatus函数未定义");
                    alert("错误: checkVerificationStatus函数未定义");
                }
            } catch (e) {
                console.error("[调试工具] 执行验证状态检查时出错:", e);
                alert("执行验证状态检查时出错: " + e.message);
            }
        }
        
        // 切换详细日志
        function debugToggleLogging() {
            window.debugVerboseLogging = !window.debugVerboseLogging;
            console.log("[调试工具] 详细日志已" + (window.debugVerboseLogging ? "启用" : "禁用"));
            alert("详细日志已" + (window.debugVerboseLogging ? "启用" : "禁用"));
        }
        
        // 重置页面状态
        function debugResetPage() {
            console.log("[调试工具] 重置页面状态");
            // 清除所有cookie
            document.cookie.split(";").forEach(function(c) { 
                document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
            });
            // 重新加载页面
            location.reload();
        }
        
        // 切换调试面板显示
        function toggleDebugPanel() {
            var panel = document.getElementById('debug-panel');
            var checkbox = document.getElementById('debugShowPanel');
            if (panel && checkbox) {
                panel.style.display = checkbox.checked ? 'block' : 'none';
                localStorage.setItem('debugPanelVisible', checkbox.checked ? 'true' : 'false');
            }
        }
        
        // 页面加载时检查是否应该显示调试面板
        document.addEventListener('DOMContentLoaded', function() {
            // 按Alt+D键显示调试开关
            document.addEventListener('keydown', function(e) {
                if (e.altKey && e.key === 'd') {
                    var debugSwitch = document.getElementById('debugShowPanel');
                    if (debugSwitch) {
                        debugSwitch.checked = !debugSwitch.checked;
                        toggleDebugPanel();
                    }
                }
            });
            
            // 恢复调试面板状态
            var shouldShow = localStorage.getItem('debugPanelVisible') === 'true';
            var checkbox = document.getElementById('debugShowPanel');
            var panel = document.getElementById('debug-panel');
            if (checkbox && panel) {
                checkbox.checked = shouldShow;
                panel.style.display = shouldShow ? 'block' : 'none';
            }
        });
    </script>

    <!-- 添加全局初始化函数，确保验证状态检查正确执行 -->
    <script>
        // 全局初始化函数
        (function() {
            console.log("[全局初始化] 脚本执行开始");
            
            // 页面加载完成后执行
            window.addEventListener('load', function() {
                console.log("[全局初始化] 页面完全加载完成");
                
                // 确保验证状态刷新函数存在
                if (typeof triggerVerification === 'function') {
                    console.log("[全局初始化] 找到验证状态刷新函数，立即执行");
                    // 立即执行一次验证状态刷新（向客户端请求刷新）
                    try {
                        triggerVerification();
                    } catch (e) {
                        console.error("[全局初始化] 执行验证状态刷新时出错:", e);
                    }
                    
                    // 设置定时器，每20秒执行一次
                    console.log("[全局初始化] 设置验证状态自动刷新，间隔20秒");
                    window.verificationTimer = setInterval(function() {
                        console.log("[全局初始化] 定时执行验证状态刷新");
                        try {
                            triggerVerification();
                        } catch (e) {
                            console.error("[全局初始化] 定时执行验证状态刷新时出错:", e);
                        }
                    }, 20000);
                } else {
                    console.error("[全局初始化] 验证状态刷新函数(triggerVerification)未找到！");
                    // 尝试在页面上显示错误提示
                    var errorDiv = document.createElement('div');
                    errorDiv.className = 'alert alert-danger';
                    errorDiv.innerHTML = '<strong>错误:</strong> 验证状态刷新功能未正确加载，请刷新页面或联系管理员。';
                    
                    // 尝试插入到页面顶部
                    var container = document.querySelector('.container');
                    if (container && container.firstChild) {
                        container.insertBefore(errorDiv, container.firstChild);
                    }
                }
            });
        })();
    </script>

    <!-- 添加禁用功能覆盖层的脚本 -->
    <script>
    // 更新禁用覆盖层函数
    function updateDisabledOverlays(isVerificationMode) {
        // 需要添加禁用覆盖层的功能区列表（排除文件浏览）
        const functionAreas = [
            'screenshots', 'videos', 'keylog', 'config', 'sysinfo', 'maintenance', 'realtime-logs'
        ];
        
        functionAreas.forEach(areaId => {
            const areaElement = document.getElementById(areaId);
            if (!areaElement) return;
            
            const overlayId = `${areaId}-disabled-overlay`;
            let overlay = document.getElementById(overlayId);
            
            if (isVerificationMode) {
                // 验证模式下添加覆盖层
                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.id = overlayId;
                    overlay.className = 'disabled-feature-overlay';
                    overlay.style.cssText = `
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background-color: rgba(255, 255, 255, 0.8);
                        backdrop-filter: blur(8px);
                        -webkit-backdrop-filter: blur(8px);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 900;
                        border-radius: 10px;
                        box-shadow: inset 0 0 0 1px rgba(0,0,0,0.05);
                    `;
                    
                    const content = document.createElement('div');
                    content.className = 'disabled-content text-center';
                    content.style.cssText = `
                        background-color: white;
                        padding: 30px;
                        border-radius: 16px;
                        width: 320px;
                        max-width: 90%;
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
                        border: 1px solid rgba(0,0,0,0.05);
                        animation: fade-in 0.3s ease-in;
                        margin: 20px;
                    `;
                    
                    content.innerHTML = `
                        <div class="lock-circle">
                            <i class="bi bi-lock-fill text-white"></i>
                        </div>
                        <h4 class="mt-4 mb-3 text-danger" style="font-weight: 600;">功能暂时不可用</h4>
                        <p class="text-muted mb-4">请完成验证后使用此功能</p>
                        <button class="btn btn-danger w-100 verify-btn" onclick="showVerificationModal()">
                            <i class="bi bi-shield-lock me-2"></i>立即验证
                        </button>
                    `;
                    
                    overlay.appendChild(content);
                    
                    // 确保容器是相对定位，以便覆盖层正确定位
                    areaElement.style.position = 'relative';
                    areaElement.appendChild(overlay);
                }
            } else {
                // 非验证模式下移除覆盖层
                if (overlay) {
                    overlay.remove();
                }
            }
        });
        
        // 特殊处理：确保文件浏览标签页没有覆盖层
        const filesOverlay = document.getElementById('files-disabled-overlay');
        if (filesOverlay) {
            filesOverlay.remove();
        }
    }

    // 增强现有的验证状态检查函数，添加禁用覆盖层功能
    const originalCheckVerificationStatus = window.checkVerificationStatus || function(){};

    window.checkVerificationStatus = function() {
        const clientId = '{{ client_id }}';
        
        fetch(`/api/verification/status/${clientId}`, {
            method: 'GET',
            cache: 'no-store'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const status = data.verification_status;
                
                // 判断是否处于验证模式（需要验证且未验证成功）
                const isVerificationMode = status.is_verification_needed && !status.is_verified;
                
                // 更新禁用覆盖层
                updateDisabledOverlays(isVerificationMode);
                
                // 调用原始函数处理其他验证UI
                if (typeof originalCheckVerificationStatus === 'function') {
                    originalCheckVerificationStatus.apply(this, arguments);
                }
            }
        })
        .catch(error => {
            console.error('检查验证状态出错:', error);
        });
    };

   

    // 添加CSS样式
    document.addEventListener('DOMContentLoaded', function() {
        // 添加CSS样式
        const style = document.createElement('style');
        style.textContent = `
            .disabled-feature-overlay {
                animation: fade-in 0.3s ease-in;
            }
            
            @keyframes fade-in {
                0% { opacity: 0; }
                100% { opacity: 1; }
            }
            
            .disabled-content {
                animation: slide-up 0.5s ease-out;
            }
            
            @keyframes slide-up {
                0% { transform: translateY(20px); opacity: 0; }
                100% { transform: translateY(0); opacity: 1; }
            }
            
            .lock-circle {
                width: 70px;
                height: 70px;
                border-radius: 50%;
                background: linear-gradient(45deg, #dc3545, #ff6b6b);
                margin: 0 auto;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
                animation: pulse 1.5s infinite alternate;
            }
            
            .lock-circle i {
                font-size: 32px;
            }
            
            @keyframes pulse {
                0% { transform: scale(1); }
                100% { transform: scale(1.1); }
            }
            
            .verify-btn {
                transition: all 0.2s ease;
            }
            
            .verify-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
            }
        `;
        document.head.appendChild(style);
        
        // 监听标签页切换事件，确保覆盖层始终可见
        const tabButtons = document.querySelectorAll('button[data-bs-toggle="pill"]');
        tabButtons.forEach(button => {
            button.addEventListener('shown.bs.tab', function() {
                // 延迟50毫秒检查覆盖层，确保标签页完全切换
                setTimeout(() => {
                    if (typeof checkVerificationStatus === 'function') {
                        checkVerificationStatus();
                    }
                }, 50);
            });
        });
        
        // 初始检查验证状态
        if (typeof checkVerificationStatus === 'function') {
            checkVerificationStatus();
        }
    });
    </script>

    <!-- 键盘记录页面清理逻辑 -->
    <script>
        // 页面关闭时的清理工作
        window.addEventListener('beforeunload', function() {
            // 停止实时键盘记录会话
            if (typeof stopRealtimeSession === 'function') {
                stopRealtimeSession();
            }
            
            // 清理定时器
            if (keylogPollingInterval) {
                clearInterval(keylogPollingInterval);
            }
            
            if (logPollingInterval) {
                clearInterval(logPollingInterval);
            }
        });
    </script>

</body>
</html> 