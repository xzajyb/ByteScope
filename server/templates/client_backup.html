<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ByteScope瀛楄妭绐ユ帰 - {{ client_info.get('hostname', '鏈煡涓绘満') }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #2c3e50;
        }
        h1 {
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .client-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .client-info p {
            margin: 5px 0;
        }
        .btn {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 14px;
            margin-right: 10px;
        }
        .btn:hover {
            background: #2980b9;
        }
        .btn-back {
            background: #95a5a6;
        }
        .btn-back:hover {
            background: #7f8c8d;
        }
        .nav-links {
            margin-bottom: 20px;
        }
        .screenshots, .keylogs {
            margin-bottom: 30px;
        }
        .screenshot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        .screenshot-item {
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            transition: transform 0.3s;
        }
        .screenshot-item:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .screenshot-item img {
            width: 100%;
            height: auto;
            display: block;
        }
        .screenshot-info {
            padding: 10px;
            background: #f8f9fa;
            font-size: 14px;
        }
        .keylog-list {
            list-style: none;
            padding: 0;
        }
        .keylog-item {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            background: white;
            transition: background 0.2s;
        }
        .keylog-item:hover {
            background: #f8f9fa;
        }
        .keylog-time {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 4px 4px 0 0;
        }
        .tab.active {
            background: #fff;
            border-color: #ddd;
            color: #3498db;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .empty-message {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
            font-style: italic;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .lightbox img {
            max-width: 90%;
            max-height: 90%;
        }
        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 30px;
            cursor: pointer;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .refresh {
            background: #2ecc71;
        }
        .refresh:hover {
            background: #27ae60;
        }
        .screenshot-container {
            position: relative;
            margin-bottom: 20px;
        }
        .screenshot-container img {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .screenshot-timestamp {
            position: absolute;
            bottom: 0;
            right: 0;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 4px 0 0 0;
        }
        .video-container {
            margin-bottom: 20px;
        }
        .video-container video {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .command-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .pending {
            background-color: #fff3cd;
            color: #856404;
        }
        .nav-pills .nav-link.active {
            background-color: #0d6efd;
        }
        .tab-content {
            padding: 20px 0;
        }
        .timestamp {
            font-size: 12px;
            color: #6c757d;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .success-message {
            display: none;
            margin-top: 15px;
        }
        .error-message {
            display: none;
            margin-top: 15px;
        }
        
        /* 寮哄埗鏄剧ず鏍囩椤靛唴瀹?*/
        .tab-pane.active {
            display: block !important;
        }
        .tab-pane {
            opacity: 1 !important;
        }
        
        /* 纭繚棣栦釜鏍囩椤垫樉绀?*/
        #screenshots.active {
            display: block !important;
        }
        
        /* 鏀硅繘鏍囩椤垫寜閽牱寮?*/
        .nav-pills .nav-link {
            margin-right: 5px;
            border-radius: 4px;
            padding: 8px 15px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .nav-pills .nav-link:hover {
            background-color: rgba(13, 110, 253, 0.1);
        }
        
        .nav-pills .nav-link.active {
            background-color: #0d6efd;
            color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        /* 娣诲姞闂磋窛 */
        .tab-content {
            margin-top: 20px;
        }
        
        /* 缇庡寲鍗＄墖鏍峰紡 */
        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: 1px solid rgba(0, 0, 0, 0.125);
            transition: box-shadow 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        
        .card-header {
            background-color: rgba(0, 0, 0, 0.03);
            border-bottom: 1px solid rgba(0, 0, 0, 0.125);
            font-weight: 500;
        }
        
        /* 缇庡寲鎸夐挳 */
        .btn-outline-primary {
            border-color: #0d6efd;
            color: #0d6efd;
        }
        
        .btn-outline-primary:hover {
            background-color: #0d6efd;
            color: white;
        }
        
        /* 缇庡寲琛ㄦ牸 */
        .table th {
            background-color: rgba(0, 0, 0, 0.03);
        }
        
        /* 澧炲己闃村奖鏁堟灉 */
        .screenshot-container {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            transition: transform 0.3s, box-shadow 0.3s;
            margin-bottom: 25px;
        }
        
        .screenshot-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        
        /* 寮哄埗鏄剧ず绗竴涓爣绛鹃〉鍐呭 - 鏈€楂樹紭鍏堢骇 */
        #screenshots {
            display: block;
        }
        
        /* 纭繚鏍囩椤靛唴瀹瑰尯鍩熷彲瑙?*/
        .tab-content, .tab-pane {
            transition: none !important;
        }
        
        /* 濡傛灉鏍囩椤典粛鐒朵笉鏄剧ず锛屽皾璇曞唴鑱旀牱寮?*/
        #clientTabsContent {
            display: block !important;
        }

        /* 鎴浘瀹瑰櫒鏍峰紡浼樺寲 */
        .screenshots-container {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .screenshot-container {
            margin-bottom: 20px;
            border-radius: 5px;
            overflow: hidden;
        }

        /* 缇庡寲鎵€鏈夋爣绛鹃〉鍐呭 */
        .tab-pane {
            padding: 15px 0;
        }

        /* 纭繚Bootstrap鏍囩椤垫纭伐浣?*/
        .tab-content > .tab-pane {
            display: none;
        }
        
        .tab-content > .active {
            display: block;
        }

        /* 鎴浘缃戞牸甯冨眬 */
        .screenshots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 15px;
        }

        .screenshot-card {
            border: 1px solid #dee2e6;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .screenshot-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        .screenshot-card .card-img-top {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .screenshot-card .card-footer {
            padding: 8px 12px;
            background: rgba(0,0,0,0.03);
            font-size: 12px;
        }
        
        /* Logo鏍峰紡 */
        .logo-container {
            display: flex;
            align-items: center;
        }
        
        .logo {
            height: 40px;
            margin-right: 15px;
        }
        
        .logo-text {
            font-size: 24px;
            font-weight: bold;
            color: #0d6efd;
            margin: 0;
        }
        
        .logo-text span {
            color: #212529;
            font-weight: normal;
        }

        /* 楠岃瘉妯箙鏍峰紡 */
        .verification-banner {
            position: sticky;
            top: 0;
            z-index: 1000;
            width: 100%;
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px 0;
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .verification-banner .banner-content {
            display: flex;
            align-items: center;
            max-width: 1200px;
            padding: 0 15px;
        }

        .verification-banner i {
            font-size: 24px;
            margin-right: 10px;
        }

        .verification-banner.urgent {
            background-color: #dc3545;
            color: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.8;
            }
            100% {
                opacity: 1;
            }
        }

        /* 楠岃瘉寮圭獥鏍峰紡 */
        .verification-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
        }

        .verification-modal-content {
            background-color: #fefefe;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .verification-modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #aaa;
        }

        .verification-modal-close:hover,
        .verification-modal-close:focus {
            color: #333;
        }

        .verification-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .verification-info {
            margin-bottom: 20px;
            color: #555;
            line-height: 1.5;
        }

        .verification-result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            background-color: #f8f9fa;
        }

        .verification-result.success {
            background-color: #d4edda;
            color: #155724;
        }

        .verification-result.error {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* 楠岃瘉鐘舵€佹寚绀哄櫒鏍峰紡 */
        .verification-status-indicator {
            background-color: #f8f9fa;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-dot.bg-success {
            background-color: #28a745;
        }

        .status-dot.bg-danger {
            background-color: #dc3545;
        }

        .status-dot.bg-warning {
            background-color: #ffc107;
        }

        .status-dot.bg-secondary {
            background-color: #6c757d;
        }
    </style>
</head>
<body>
    <!-- 鍏嶈矗澹版槑妯℃€佹 -->
    <div class="modal fade" id="disclaimerModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="disclaimerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title" id="disclaimerModalLabel"><i class="bi bi-exclamation-triangle"></i> 鍏嶈矗澹版槑</h5>
                </div>
                <div class="modal-body">
                    <div class="disclaimer-content" style="max-height: 400px; overflow-y: auto;">
                        <h4 class="text-center">绯荤粺鐢ㄩ€斿０鏄庝笌娉曞緥璀﹀憡</h4>
                        <hr>
                        <div class="alert alert-danger">
                            <strong>閲嶈娉曞緥璀﹀憡锛?/strong> 浠讳綍鏈粡鎺堟潈鎴栫敤浜庨潪娉曠洰鐨勭殑浣跨敤灏嗚杩界┒娉曞緥璐ｄ换銆備竴鏃﹀彂鐜拌繚娉曡涓猴紝鎴戜滑灏嗙珛鍗冲悜鏈夊叧閮ㄩ棬鎶ヨ锛?                        </div>
                        <p><strong>璇蜂粩缁嗛槄璇讳互涓嬪唴瀹癸細</strong></p>
                        <p>鏈郴缁燂紙ByteScope瀛楄妭绐ユ帰锛変粎渚涚粍缁囧唴閮ㄧ殑鍚堟硶鐩戞帶涓庣鐞嗕娇鐢紝浣跨敤鏈郴缁熷墠锛岃纭繚锛?/p>
                        <ol>
                            <li>鎮ㄥ凡鑾峰緱鐩稿叧璁惧鍜岀綉缁滅殑鍚堟硶绠＄悊鏉冮檺</li>
                            <li>鎮ㄥ凡鍛婄煡骞惰幏寰楄鐩戞帶缁堢鐢ㄦ埛鐨勬槑纭煡鎯呭悓鎰?/li>
                            <li>鎮ㄧ殑浣跨敤绗﹀悎褰撳湴娉曞緥娉曡鐨勮瀹氾紙鍖呮嫭浣嗕笉闄愪簬闅愮娉曘€佺綉缁滃畨鍏ㄦ硶銆佸姵鍔ㄦ硶绛夛級</li>
                            <li>鎮ㄤ笉浼氬皢姝ょ郴缁熺敤浜庝换浣曚镜鐘釜浜洪殣绉佹垨渚靛浠栦汉鍚堟硶鏉冪泭鐨勬椿鍔?/li>
                            <li>鎮ㄤ簡瑙ｅ苟鎺ュ彈鎵€鏈夋硶寰嬮闄╁拰璐ｄ换</li>
            </ol>
                        
                        <p><strong>鍔熻兘璇存槑锛?/strong></p>
                        <p>鏈郴缁熷叿鏈変互涓嬪姛鑳斤細</p>
                        <ul>
                            <li>灞忓箷鎴浘涓庡綍灞?/li>
                            <li>閿洏杈撳叆璁板綍</li>
                            <li>绯荤粺淇℃伅閲囬泦</li>
                            <li>杩滅▼鏂囦欢璁块棶</li>
                        </ul>
                        
                        <p><strong>鍏嶈矗澹版槑锛?/strong></p>
                        <p>鏈郴缁熷紑鍙戣€呬笌鎻愪緵鑰呬笉瀵瑰洜浣跨敤鏈郴缁熷鑷寸殑浠讳綍鐩存帴鎴栭棿鎺ラ棶棰樿礋璐ｏ紝鍖呮嫭浣嗕笉闄愪簬锛?/p>
                        <ul>
                            <li>鍥犳湭缁忔巿鏉冧娇鐢ㄦ湰绯荤粺瀵艰嚧鐨勬硶寰嬭矗浠?/li>
                            <li>鍥犵郴缁焍ug瀵艰嚧鐨勬暟鎹涪澶辨垨娉勯湶</li>
                            <li>鍥犵綉缁滈棶棰樺鑷寸殑鐩戞帶鍋忓樊鎴栫郴缁熸晠闅?/li>
                        </ul>
                        
                        <p><strong>鎺堟潈涓庤鍙細</strong></p>
                        <p>浣跨敤鏈郴缁熶唬琛ㄦ偍鍚屾剰锛?/p>
                        <ul>
                            <li>浠呭皢绯荤粺鐢ㄤ簬鍚堟硶鎺堟潈鐨勭洃鎺?/li>
                            <li>瀵圭郴缁熼噰闆嗙殑鏁忔劅鏁版嵁璐熸湁淇濇姢涔夊姟</li>
                            <li>涓嶄細灏嗙郴缁熺敤浜庝换浣曚镜鐘粬浜洪殣绉佹潈鎴栧叾浠栨潈鍒╃殑鐩殑</li>
                            <li>鍦ㄥ彂鐜颁换浣曡繚娉曚娇鐢ㄦ椂锛屾偍鏈変箟鍔＄珛鍗冲仠姝㈠苟鎶ュ憡</li>
                        </ul>
                        
                        <div class="alert alert-warning">
                            <strong>娉ㄦ剰锛?/strong> 浣跨敤鏈郴缁熻褰曠殑鎵€鏈夋搷浣滃拰璁块棶璁板綍鍧囦細琚郴缁熸棩蹇椾繚瀛橈紝鍙兘浼氳鐢ㄤ綔鎵ф硶閮ㄩ棬璋冩煡鐨勮瘉鎹€傚鏋滄偍浣跨敤鏈郴缁熻繘琛屼换浣曡繚娉曟椿鍔紝鎴戜滑灏嗛厤鍚堟墽娉曟満鏋勬彁渚涚浉鍏宠瘉鎹€?                        </div>
                        
                        <p>濡傛湁鐤戦棶锛岃鑱旂郴绯荤粺绠＄悊鍛樸€?/p>
                    </div>
                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="doNotShowAgain">
                        <label class="form-check-label" for="doNotShowAgain">涓嶅啀鏄剧ず姝ゆ彁绀?/label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="rejectDisclaimerBtn">鎷掔粷骞堕€€鍑?/button>
                    <button type="button" class="btn btn-success" id="acceptDisclaimerBtn">鎴戝凡闃呰骞跺悓鎰?/button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 璀﹀憡妯箙 -->
    <div class="alert alert-danger text-center mb-4" style="font-size: 16px; font-weight: bold;">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        璀﹀憡锛氭湰绯荤粺浠呬緵鍚堟硶缁勭粐鍐呴儴鐩戞帶浣跨敤銆備换浣曟湭缁忔巿鏉冩垨闈炴硶浣跨敤灏嗚杩界┒娉曞緥璐ｄ换銆備竴鏃﹀彂鐜拌繚娉曡涓猴紝鎴戜滑灏嗙珛鍗冲悜鏈夊叧閮ㄩ棬鎶ヨ銆?    </div>
    
    <div class="container mt-4">
        <!-- 娣诲姞楠岃瘉妯箙 -->
        <div id="verification-banner" class="verification-banner" style="display: none;">
            <div class="banner-content">
                <i class="bi bi-shield-exclamation"></i>
                <span id="verification-banner-text">姝ゅ鎴风闇€瑕侀獙璇併€傝杈撳叆楠岃瘉瀵嗛挜浠ョ户缁搷浣溿€?/span>
                <button id="verification-banner-button" onclick="showVerificationModal()" class="btn btn-primary btn-sm">绔嬪嵆楠岃瘉</button>
            </div>
        </div>
        
        <!-- 楠岃瘉妯℃€佹 -->
        <div id="verification-modal" class="verification-modal" style="display: none;">
            <div class="verification-modal-content">
                <span class="verification-modal-close" onclick="closeVerificationModal()">&times;</span>
                <h2><i class="bi bi-shield-lock"></i> 瀹㈡埛绔畨鍏ㄩ獙璇?/h2>
                <p class="verification-info">
                    姝ゅ鎴风闇€瑕佸畨鍏ㄩ獙璇佹墠鑳界户缁娇鐢ㄣ€?br>
                    楠岃瘉瀵嗛挜宸蹭繚瀛樺湪瀹㈡埛绔數鑴戜笂锛岃鑱旂郴绠＄悊鍛樿幏鍙栧瘑閽ャ€?br>
                    <strong>鍓╀綑灏濊瘯娆℃暟: <span id="attempts-count">0</span></strong><br>
                    <strong>鍊掕鏃? <span id="timeout-value">00:00:00</span></strong>
                </p>
                <input type="text" id="verification-key" class="verification-input" placeholder="璇疯緭鍏ラ獙璇佸瘑閽? />
                <button onclick="verifyKey()" class="btn btn-primary">楠岃瘉</button>
                <div id="verification-result" class="verification-result" style="display: none;"></div>
            </div>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="logo-container">
                <img src="/static/images/bytescope_logo.png" alt="ByteScope Logo" class="logo">
                <h1 class="logo-text">Byte<span>Scope</span> <small class="text-muted">瀛楄妭绐ユ帰</small></h1>
            </div>
            <a href="/" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> 杩斿洖鍒楄〃
            </a>
        </div>

        <div class="row">
            <div class="col-md-3 mb-4">
                <div class="card">
            <div class="card-header">
                        瀹㈡埛绔俊鎭?            </div>
            <div class="card-body">
                        <p><strong>鐢ㄦ埛鍚?</strong> {{ client_info.get('username', '鏈煡') }}</p>
                        <p><strong>IP鍦板潃:</strong> {{ client_info.get('ip', '鏈煡') }}</p>
                        <p><strong>鏈€鍚庢椿鍔?</strong> {{ client_info.get('last_seen', '鏈煡') }}</p>
                        <p><strong>瀹㈡埛绔疘D:</strong> <span class="text-truncate d-inline-block" style="max-width: 100%;">{{ client_id }}</span></p>
                        
                        <!-- 楠岃瘉鐘舵€佹寚绀哄櫒 -->
                        <div class="verification-status-indicator mt-3 p-2 border rounded">
                            <h6 class="mb-2"><i class="bi bi-shield-check"></i> 楠岃瘉鐘舵€?/h6>
                            <div id="verification-status-display">
                                <div class="d-flex align-items-center">
                                    <div class="status-dot bg-secondary me-2"></div>
                                    <span>姝ｅ湪妫€鏌?..</span>
                                </div>
                            </div>
                            <button id="trigger-verification-btn" class="btn btn-sm btn-info mt-2 w-100" onclick="triggerVerification()">
                                <i class="bi bi-arrow-clockwise"></i> 妫€鏌ラ獙璇佺姸鎬?                            </button>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="takeScreenshot()">
                                <i class="bi bi-camera"></i> 绔嬪嵆鎴浘
                            </button>
                            <button class="btn btn-success" onclick="startRecording()">
                                <i class="bi bi-record-circle"></i> 寮€濮嬪綍灞?                            </button>
                            <button class="btn btn-danger" onclick="stopRecording()">
                                <i class="bi bi-stop-circle"></i> 鍋滄褰曞睆
                            </button>
                            <!-- 娣诲姞鎭㈠鍘熷璁剧疆鍜屽垹闄ゅ鎴风鎸夐挳 -->
                            <button class="btn btn-warning" onclick="resetClientSettings()">
                                <i class="bi bi-arrow-counterclockwise"></i> 鎭㈠鍘熷璁剧疆
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteClient()">
                                <i class="bi bi-trash"></i> 鍒犻櫎瀹㈡埛绔?                            </button>
                        </div>
                    </div>
            </div>
        </div>
        
            <div class="col-md-9">
                <ul class="nav nav-pills mb-3" id="clientTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="screenshots-tab" data-bs-toggle="pill" data-bs-target="#screenshots" type="button" role="tab" aria-controls="screenshots" aria-selected="true">鎴浘</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="videos-tab" data-bs-toggle="pill" data-bs-target="#videos" type="button" role="tab" aria-controls="videos" aria-selected="false">褰曞睆</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="keylog-tab" data-bs-toggle="pill" data-bs-target="#keylog" type="button" role="tab" aria-controls="keylog" aria-selected="false">閿洏璁板綍</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="config-tab" data-bs-toggle="pill" data-bs-target="#config" type="button" role="tab" aria-controls="config" aria-selected="false">閰嶇疆绠＄悊</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="sysinfo-tab" data-bs-toggle="pill" data-bs-target="#sysinfo" type="button" role="tab" aria-controls="sysinfo" aria-selected="false">绯荤粺淇℃伅</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="files-tab" data-bs-toggle="pill" data-bs-target="#files" type="button" role="tab" aria-controls="files" aria-selected="false">鏂囦欢娴忚</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="realtime-logs-tab" data-bs-toggle="pill" data-bs-target="#realtime-logs" type="button" role="tab" aria-controls="realtime-logs" aria-selected="false">瀹炴椂鏃ュ織</button>
                    </li>
                </ul>

                <div class="tab-content" id="clientTabsContent">
                    <!-- 鎴浘鏍囩椤?-->
                    <div class="tab-pane fade show active" id="screenshots" role="tabpanel" aria-labelledby="screenshots-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3>鎴浘鍒楄〃</h3>
                            <div>
                                <button class="btn btn-sm btn-outline-danger me-2" id="screenshots-batch-delete-btn" style="display:none">
                                    <i class="bi bi-trash"></i> 鎵归噺鍒犻櫎 (<span id="screenshots-selected-count">0</span>)
                                </button>
                                <button class="btn btn-sm btn-outline-secondary me-2" id="screenshots-batch-mode-btn">
                                    <i class="bi bi-check-square"></i> 鎵归噺閫夋嫨
                                </button>

                                <button class="btn btn-sm btn-outline-primary" onclick="location.reload()">
                                    <i class="bi bi-arrow-clockwise"></i> 鍒锋柊
                                </button>
                            </div>
                        </div>

                        <div class="screenshots-container">
                            {% if screenshots %}
                                <div class="screenshots-grid">
                                    {% for screenshot in screenshots %}
                                    <div class="screenshot-card position-relative" data-filename="{{ screenshot }}">
                                        <div class="screenshot-checkbox" style="display:none; position: absolute; top: 8px; left: 8px; z-index: 100; background-color: rgba(255,255,255,0.8); padding: 5px; border-radius: 3px;">
                                            <input class="form-check-input screenshot-checkbox-input" type="checkbox" value="{{ screenshot }}" id="sc_{{ loop.index }}">
                                            <label class="form-check-label" for="sc_{{ loop.index }}">閫夋嫨</label>
                                        </div>
                                        <a href="/uploads/{{ client_id }}/{{ screenshot }}" target="_blank">
                                            <img src="/uploads/{{ client_id }}/{{ screenshot }}" alt="鎴浘" class="card-img-top">
                                        </a>
                                        <div class="card-footer">
                                            {{ screenshot.replace('screen_', '').replace('.jpg', '').replace('.png', '').replace('_', ' ') }}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                <div class="text-center mt-3">
                                    <p>鍏辨樉绀?{{ screenshots|length }} 寮犳埅鍥?/p>
                                </div>
                            {% else %}
                                <div class="alert alert-info">
                                    鏆傛棤鎴浘鏁版嵁
                                </div>
                            {% endif %}
                        </div>
                        </div>
                        
                    <!-- 褰曞睆鏍囩椤?-->
                    <div class="tab-pane fade" id="videos" role="tabpanel" aria-labelledby="videos-tab">
                        <!-- 娣诲姞褰曞睆鎺у埗闈㈡澘 -->
                        <div class="card mb-3">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">褰曞睆鎺у埗</h5>
            </div>
            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>瀹氭椂褰曞睆</h6>
                                        <div class="input-group mb-3">
                                            <span class="input-group-text">鏃堕暱</span>
                                            <input type="number" class="form-control" id="recording_duration" name="recording_duration" value="60" min="10" max="3600">
                                            <span class="input-group-text">绉?/span>
            </div>
                                        <div class="input-group mb-3">
                                            <span class="input-group-text">甯х巼</span>
                                            <input type="number" class="form-control" id="recording_fps" name="recording_fps" value="10" min="1" max="30">
                                            <span class="input-group-text">FPS</span>
                        </div>
                                        <button class="btn btn-success" onclick="startRecording()">
                                            <i class="bi bi-record-circle"></i> 寮€濮嬪畾鏃跺綍灞?                                        </button>
                                        <button class="btn btn-danger" onclick="stopRecording()">
                                            <i class="bi bi-stop-circle"></i> 鍋滄褰曞睆
                                        </button>
                    </div>
                                    <div class="col-md-6">
                                        <h6>瀹炴椂褰曞睆</h6>
                                        <div class="input-group mb-3">
                                            <span class="input-group-text">甯х巼</span>
                                            <input type="number" class="form-control" id="realtime_fps" name="realtime_fps" value="10" min="1" max="30">
                                            <span class="input-group-text">FPS</span>
                                        </div>
                                        <div id="recording-status-container" class="mb-3">
                                            <div class="alert alert-info" id="recording-status-info">
                                                褰撳墠鏈綍灞?                                            </div>
                                        </div>
                                        <button class="btn btn-primary" id="realtime-record-btn" onclick="toggleRealtimeRecording()">
                                            <i class="bi bi-record-circle"></i> 寮€濮嬪疄鏃跺綍灞?                                        </button>
                                        <button class="btn btn-danger" onclick="forceStopAllRecordings()">
                                            <i class="bi bi-exclamation-triangle"></i> 寮哄埗缁堟鎵€鏈夊綍灞?                                        </button>
                                    </div>
                                </div>
                        </div>
                    </div>

                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3>褰曞睆鍒楄〃</h3>
                            <div>
                                <button class="btn btn-sm btn-outline-danger me-2" id="videos-batch-delete-btn" style="display:none">
                                    <i class="bi bi-trash"></i> 鎵归噺鍒犻櫎 (<span id="videos-selected-count">0</span>)
                                </button>
                                <button class="btn btn-sm btn-outline-secondary me-2" id="videos-batch-mode-btn">
                                    <i class="bi bi-check-square"></i> 鎵归噺閫夋嫨
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="location.reload()">鍒锋柊</button>
                            </div>
                        </div>
        
                        {% if videos %}
                            <div class="list-group">
                                {% for video in videos %}
                                <div class="video-item position-relative">
                                    <div class="video-checkbox" style="display:none; position: absolute; top: 8px; left: 8px; z-index: 100; background-color: rgba(255,255,255,0.8); padding: 5px; border-radius: 3px;">
                                        <input class="form-check-input video-checkbox-input" type="checkbox" value="{{ video }}" id="vc_{{ loop.index }}">
                                        <label class="form-check-label" for="vc_{{ loop.index }}">閫夋嫨</label>
                                    </div>
                                    <a href="/uploads/{{ client_id }}/{{ video }}" class="list-group-item list-group-item-action" target="_blank" data-filename="{{ video }}">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h5 class="mb-1">{{ video }}</h5>
                                            <small class="timestamp">{{ video.replace('record_', '').replace('.avi', '').replace('.mp4', '').replace('_', ' ') }}</small>
                                        </div>
                                        <p class="mb-1">鐐瑰嚮涓嬭浇鎴栨挱鏀捐棰?/p>
                                    </a>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="alert alert-info">
                                鏆傛棤褰曞睆鏁版嵁
                            </div>
                        {% endif %}
                    </div>

                    <!-- 绯荤粺缁存姢鏍囩椤?-->
                    <div class="tab-pane fade" id="maintenance" role="tabpanel" aria-labelledby="maintenance-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3>绯荤粺缁存姢</h3>
                        </div>
                        
                        <div class="row">
                    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                                        <h5 class="mb-0">鑷姩娓呯悊璁剧疆</h5>
            </div>
                            <div class="card-body">
                                        <form id="auto-cleanup-form">
                                            <div class="mb-3 form-check">
                                                <input type="checkbox" class="form-check-input" id="cleanup-enabled">
                                                <label class="form-check-label" for="cleanup-enabled">鍚敤鑷姩娓呯悊</label>
                                            </div>
                                    <div class="mb-3">
                                                <label for="cleanup-days" class="form-label">淇濈暀鏁版嵁澶╂暟</label>
                                                <input type="number" class="form-control" id="cleanup-days" min="1" value="30">
                                                <div class="form-text">鎸囧畾淇濈暀鏈€杩戝灏戝ぉ鐨勬暟鎹紝瓒呰繃姝ゅぉ鏁扮殑鏁版嵁灏嗚鑷姩娓呯悊</div>
                                    </div>
                                    <div class="mb-3">
                                                <label for="cleanup-interval" class="form-label">娓呯悊闂撮殧锛堝皬鏃讹級</label>
                                                <input type="number" class="form-control" id="cleanup-interval" min="1" value="24">
                                                <div class="form-text">姣忛殧澶氬皯灏忔椂鎵ц涓€娆¤嚜鍔ㄦ竻鐞?/div>
                                    </div>
                                            <button type="submit" class="btn btn-primary">淇濆瓨璁剧疆</button>
                                </form>
                                        <div id="cleanup-config-result" class="mt-3" style="display:none"></div>
                            </div>
                        </div>
                    </div>
        
                            <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                                        <h5 class="mb-0">鎵嬪姩娓呯悊</h5>
                </div>
            <div class="card-body">
                                        <form id="manual-cleanup-form">
                                            <div class="mb-3">
                                                <label for="manual-cleanup-days" class="form-label">淇濈暀鏁版嵁澶╂暟</label>
                                                <input type="number" class="form-control" id="manual-cleanup-days" min="0" value="30">
                                                <div class="form-text">鎸囧畾淇濈暀鏈€杩戝灏戝ぉ鐨勬暟鎹紝杈撳叆0琛ㄧず娓呯悊鎵€鏈夋暟鎹?/div>
                                            </div>
                                            <button type="submit" class="btn btn-danger">
                                                <i class="bi bi-trash"></i> 绔嬪嵆娓呯悊
                                            </button>
                                        </form>
                                        <div id="manual-cleanup-result" class="mt-3" style="display:none"></div>
                                    </div>
                                </div>
            </div>
        </div>
        
                        <div class="card">
            <div class="card-header">
                                <h5 class="mb-0">娓呯悊甯姪</h5>
            </div>
            <div class="card-body">
                                <p>鑷姩娓呯悊鍔熻兘鍙互甯姪鎮ㄧ鐞嗙郴缁熺敓鎴愮殑澶ч噺鏂囦欢锛岄伩鍏嶆湇鍔″櫒瀛樺偍绌洪棿琚崰婊°€?/p>
                                <ul>
                                    <li><strong>鑷姩娓呯悊</strong> - 绯荤粺灏嗘寜鐓ц瀹氱殑鏃堕棿闂撮殧锛岃嚜鍔ㄥ垹闄よ秴杩囦繚鐣欐湡闄愮殑鏂囦欢</li>
                                    <li><strong>鎵嬪姩娓呯悊</strong> - 鎮ㄥ彲浠ラ殢鏃舵墜鍔ㄨЕ鍙戞竻鐞嗘搷浣滐紝绔嬪嵆鍒犻櫎瓒呰繃鎸囧畾澶╂暟鐨勬枃浠?/li>
                                </ul>
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle"></i> 璀﹀憡锛氭竻鐞嗘搷浣滀細姘镐箙鍒犻櫎鏂囦欢锛屾棤娉曟仮澶嶏紝璇疯皑鎱庢搷浣滐紒
                                </div>
                            </div>
                        </div>
                        
                        <!-- 鍚庡彴鎹曡幏璁剧疆 -->
                       
                        <div class="card">
                            <div class="card-header bg-warning">
                                <h5 class="mb-0">闅愮璀﹀憡</h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle"></i> <strong>璀﹀憡锛氬悗鍙版崟鑾峰姛鑳藉皢鎸佺画鏀堕泦缁堢鏁版嵁锛屽嵆浣垮湪鐢ㄦ埛涓嶆搷浣滅殑鎯呭喌涓嬩篃浼氳繘琛屻€?/strong>
                                </div>
                                <p>鍚敤鍚庡彴鎹曡幏鍔熻兘鎰忓懗鐫€锛?/p>
                                <ul>
                                    <li>绯荤粺灏嗘寜鐓ц瀹氱殑鏃堕棿闂撮殧鑷姩鎹曡幏灞忓箷鍜屽綍灞?/li>
                                    <li>鍗充娇绠＄悊鍛樻湭鎵撳紑缃戦〉鐣岄潰锛屾崟鑾蜂篃灏嗗湪鍚庡彴缁х画</li>
                                    <li>杩欏彲鑳戒細浜х敓澶ч噺鏁版嵁锛屾秷鑰楁湇鍔″櫒瀛樺偍绌洪棿</li>
                                </ul>
                                <p>璇风‘淇濓細</p>
                                <ul>
                                    <li>鎮ㄥ凡鑾峰緱琚洃鎺х粓绔敤鎴风殑鏄庣‘鎺堟潈</li>
                                    <li>鎮ㄥ凡璁剧疆鍚堢悊鐨勮嚜鍔ㄦ竻鐞嗙瓥鐣ワ紝閬垮厤鏁版嵁杩囧害绱Н</li>
                                    <li>閬靛畧鐩稿叧鐨勯殣绉佹硶瑙勫拰缁勭粐鏀跨瓥</li>
                                </ul>
                            </div>
                        </div>
                    </div>
        </p>
    
                    <!-- 娣诲姞绯荤粺缁存姢鏍囩鍒板鑸爮 -->
                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            const tabsUl = document.getElementById('clientTabs');
                            if (tabsUl) {
                                const maintenanceTab = document.createElement('li');
                                maintenanceTab.className = 'nav-item';
                                maintenanceTab.role = 'presentation';
                                maintenanceTab.innerHTML = `
                                    <button class="nav-link" id="maintenance-tab" data-bs-toggle="pill"
                                            data-bs-target="#maintenance" type="button" role="tab"
                                            aria-controls="maintenance" aria-selected="false">
                                        <i class="bi bi-tools"></i> 绯荤粺缁存姢
                                    </button>
                                `;
                                tabsUl.appendChild(maintenanceTab);
                                
                                document.getElementById('maintenance-tab').addEventListener('click', function() {
                                    loadCleanupConfig();
                                });
                            }
                        });
                    </script>

                    <!-- 閿洏璁板綍鏍囩椤?-->
                    <div class="tab-pane fade" id="keylog" role="tabpanel" aria-labelledby="keylog-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3>閿洏璁板綍</h3>
                            <div>
                                <button class="btn btn-sm btn-outline-primary me-2" onclick="loadKeylogHistory()">
                                    <i class="bi bi-arrow-clockwise"></i> 鍒锋柊璁板綍
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="clearKeylogDisplay()">
                                    <i class="bi bi-trash"></i> 娓呯┖鏄剧ず
                                </button>
                                <a href="/keylog/{{ client_id }}" class="btn btn-sm btn-outline-info ms-2" target="_blank">
                                    <i class="bi bi-list"></i> 鏌ョ湅鍘嗗彶璁板綍
                                </a>
                </div>
            </div>
                        
                        <!-- HTTP杞妯″紡鎻愮ず妗?-->
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle"></i> 
                            褰撳墠浣跨敤<strong>HTTP杞妯″紡</strong>鎺ユ敹閿洏璁板綍鏁版嵁锛堟瘡1绉掑埛鏂颁竴娆★級锛屾彁渚涙洿楂樼伒鏁忓害鐨勯敭鐩樿褰曘€?                            <button class="btn btn-sm btn-outline-primary ms-2" onclick="loadKeylogHistory()">
                                <i class="bi bi-arrow-clockwise"></i> 绔嬪嵆鍒锋柊
                            </button>
        </div>
        
                        <div class="card mb-3">
            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">瀹炴椂閿洏璁板綍</h5>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="keylogRealtimeToggle" checked>
                                        <label class="form-check-label" for="keylogRealtimeToggle">瀹炴椂鏇存柊</label>
                                    </div>
                                </div>
            </div>
            <div class="card-body">
                                <div class="keylog-container" id="keylogContainer" style="height: 400px; overflow-y: auto; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px; font-family: monospace; white-space: pre-wrap;"></div>
                            </div>
                        </div>
                        
                        <!-- 閿洏璁板綍鎺у埗閮ㄥ垎宸插垹闄?-->
                    </div>

                    <!-- 閰嶇疆绠＄悊鏍囩椤?-->
                    <div class="tab-pane fade" id="config" role="tabpanel" aria-labelledby="config-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3>閰嶇疆绠＄悊</h3>
                            <button class="btn btn-sm btn-outline-primary" onclick="loadClientConfig()">鍔犺浇褰撳墠閰嶇疆</button>
                        </div>
                        
                        <div class="card">
                            <div class="card-body">
                                <form id="client-config-form">
                <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="screenshot_interval">鎴浘闂撮殧 (绉?</label>
                                                <input type="number" class="form-control" id="screenshot_interval" name="screenshot_interval" value="15" min="1" max="3600">
                            </div>
                                            
                                            <div class="form-group">
                                                <label for="keylogger_interval">閿洏璁板綍闂撮殧 (绉?</label>
                                                <input type="number" class="form-control" id="keylogger_interval" name="keylogger_interval" value="1" min="0.1" max="60" step="0.1">
                                            </div>
                                            
                                            <div class="form-group">
                                                <label for="keylogger_interval_recording">褰曞睆鏃堕敭鐩樿褰曢棿闅?(绉?</label>
                                                <input type="number" class="form-control" id="keylogger_interval_recording" name="keylogger_interval_recording" value="0.5" min="0.1" max="60" step="0.1">
                                            </div>
                                            
                                            <div class="form-group">
                                                <label for="upload_interval">涓婁紶闂撮殧 (绉?</label>
                                                <input type="number" class="form-control" id="upload_interval" name="upload_interval" value="60" min="5" max="3600">
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="check_command_interval">妫€鏌ュ懡浠ら棿闅?(绉?</label>
                                                <input type="number" class="form-control" id="check_command_interval" name="check_command_interval" value="30" min="1" max="3600">
                                            </div>
                                            
                                            <div class="form-group">
                                                <label for="recording_duration">褰曞睆鎸佺画鏃堕棿 (绉?</label>
                                                <input type="number" class="form-control" id="recording_duration" name="recording_duration" value="60" min="10" max="3600">
                                            </div>
                                            
                                            <div class="form-group">
                                                <label for="recording_fps">褰曞睆甯х巼 (FPS)</label>
                                                <input type="number" class="form-control" id="recording_fps" name="recording_fps" value="10" min="1" max="30">
                                            </div>
                                            
                                            <div class="form-group">
                                                <label for="config_sync_interval">閰嶇疆鍚屾闂撮殧 (绉?</label>
                                                <input type="number" class="form-control" id="config_sync_interval" name="config_sync_interval" value="30" min="10" max="3600">
                                                <small class="form-text text-muted">瀹㈡埛绔笌鏈嶅姟鍣ㄥ悓姝ラ厤缃殑鏃堕棿闂撮殧</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="enable_screenshot" name="enable_screenshot" checked>
                                            <label class="form-check-label" for="enable_screenshot">鍚敤灞忓箷鎴浘</label>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="enable_keylogger" name="enable_keylogger" checked>
                                            <label class="form-check-label" for="enable_keylogger">鍚敤閿洏璁板綍</label>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="enable_upload" name="enable_upload" checked>
                                            <label class="form-check-label" for="enable_upload">鍚敤鏁版嵁涓婁紶</label>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="enable_realtime_keylog" name="enable_realtime_keylog" checked>
                                            <label class="form-check-label" for="enable_realtime_keylog">鍚敤瀹炴椂閿洏璁板綍</label>
                                        </div>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-primary mt-3">搴旂敤閰嶇疆</button>
                                </form>
                                
                                <div id="success-message" class="alert alert-success success-message"></div>
                                <div id="error-message" class="alert alert-danger error-message"></div>
                            </div>
                        </div>
                    </div>

                    <!-- 绯荤粺淇℃伅鏍囩椤?-->
                    <div class="tab-pane fade" id="sysinfo" role="tabpanel" aria-labelledby="sysinfo-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3>绯荤粺淇℃伅</h3>
                            <button class="btn btn-sm btn-outline-primary" onclick="getSystemInfo()">鑾峰彇鏈€鏂扮郴缁熶俊鎭?/button>
                        </div>
                        
                        <div id="sysinfo-loading" class="text-center py-4 d-none">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">鍔犺浇涓?..</span>
                            </div>
                            <p class="mt-2">姝ｅ湪鑾峰彇绯荤粺淇℃伅锛岃绋嶅€?..</p>
                        </div>
                        
                        <div id="sysinfo-error" class="alert alert-danger d-none"></div>
                        
                        <div id="sysinfo-container" class="row">
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header">鍩烘湰淇℃伅</div>
            <div class="card-body">
                                        <table class="table table-sm">
                                            <tr>
                                                <th>涓绘満鍚?/th>
                                                <td id="sysinfo-hostname"></td>
                    </tr>
                    <tr>
                        <th>鐢ㄦ埛鍚?/th>
                                                <td id="sysinfo-username"></td>
                    </tr>
                    <tr>
                                                <th>绯荤粺</th>
                                                <td id="sysinfo-system"></td>
                    </tr>
                    <tr>
                                                <th>鐗堟湰</th>
                                                <td id="sysinfo-version"></td>
                    </tr>
                    <tr>
                                                <th>澶勭悊鍣?/th>
                                                <td id="sysinfo-processor"></td>
                                            </tr>
                                            <tr>
                                                <th>鏃堕棿</th>
                                                <td id="sysinfo-timestamp"></td>
                    </tr>
                </table>
                                </div>
                            </div>
                        </div>
        
                    <div class="col-md-6">
                        <div class="card mb-3">
                                    <div class="card-header">鎬ц兘淇℃伅</div>
            <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">CPU浣跨敤鐜?/label>
                                            <div class="progress">
                                                <div id="sysinfo-cpu" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                                        
                                    <div class="mb-3">
                                            <label class="form-label">鍐呭瓨浣跨敤鐜?/label>
                                            <div class="progress">
                                                <div id="sysinfo-memory" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
            </div>
        </div>
                                        
                                        <table class="table table-sm">
                                            <tr>
                                                <th>CPU鏍稿績鏁?/th>
                                                <td id="sysinfo-cpu-count"></td>
                                            </tr>
                                            <tr>
                                                <th>鎬诲唴瀛?/th>
                                                <td id="sysinfo-memory-total"></td>
                                            </tr>
                                            <tr>
                                                <th>鍙敤鍐呭瓨</th>
                                                <td id="sysinfo-memory-available"></td>
                                            </tr>
                                            <tr>
                                                <th>缃戠粶鍙戦€?/th>
                                                <td id="sysinfo-network-sent"></td>
                                            </tr>
                                            <tr>
                                                <th>缃戠粶鎺ユ敹</th>
                                                <td id="sysinfo-network-recv"></td>
                                            </tr>
                                        </table>
            </div>
            </div>
        </div>
        
                            <div class="col-12">
                        <div class="card">
                                    <div class="card-header">纾佺洏淇℃伅</div>
            <div class="card-body">
                                        <div id="sysinfo-disks" class="row"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
                    <!-- 鏂囦欢娴忚鏍囩椤?-->
                    <div class="tab-pane fade" id="files" role="tabpanel" aria-labelledby="files-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3>鏂囦欢娴忚</h3>
                            <div>
                                <button class="btn btn-sm btn-outline-success me-2" onclick="showDownloadedFilesModal()">
                                    <i class="bi bi-folder-check"></i> 鏌ョ湅宸蹭笅杞芥枃浠?                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="browseRootDirectories()">
                                    <i class="bi bi-arrow-clockwise"></i> 鍒锋柊
                                </button>
                            </div>
            </div>
                        
                        <div id="file-path-nav" class="mb-3">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb" id="file-breadcrumb">
                                    <li class="breadcrumb-item"><a href="#" onclick="browseRootDirectories(); return false;">鏍圭洰褰?/a></li>
                                </ol>
                            </nav>
                            </div>
                        
                        <div id="file-browser-loading" class="text-center py-4 d-none">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">鍔犺浇涓?..</span>
                                </div>
                            <p class="mt-2">姝ｅ湪鑾峰彇鏂囦欢鍒楄〃锛岃绋嶅€?..</p>
                            </div>
                        
                        <div id="file-browser-error" class="alert alert-danger d-none"></div>
                        
                        <div id="file-browser-container">
                <div class="row">
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header">鐩綍</div>
                                        <div class="list-group list-group-flush" id="directory-list">
                                            <!-- 鐩綍鍒楄〃 -->
                        </div>
                    </div>
                </div>
                                
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header">鏂囦欢</div>
                                        <div class="list-group list-group-flush" id="file-list">
                                            <!-- 鏂囦欢鍒楄〃 -->
            </div>
        </div>
                </div>
            </div>
                            
                            <div class="card mt-3 d-none" id="file-content-container">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span id="file-content-name">鏂囦欢鍐呭</span>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="closeFileContent()">鍏抽棴</button>
                            </div>
                            <div class="card-body">
                                    <pre id="file-content" class="bg-light p-3" style="max-height: 500px; overflow: auto;"></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 瀹炴椂鏃ュ織鏍囩椤?-->
                    <div class="tab-pane fade" id="realtime-logs" role="tabpanel" aria-labelledby="realtime-logs-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3>瀹炴椂鏃ュ織</h3>
                            <div>
                                <button class="btn btn-sm btn-outline-primary me-2" onclick="loadClientLogs()">
                                    <i class="bi bi-arrow-clockwise"></i> 鍒锋柊鏃ュ織
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="clearLogDisplay()">
                                    <i class="bi bi-trash"></i> 娓呯┖鏄剧ず
                                </button>
                </div>
            </div>
                        
                        <!-- HTTP杞妯″紡鎻愮ず妗?-->
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle"></i> 
                            褰撳墠浣跨敤<strong>HTTP杞妯″紡</strong>鎺ユ敹鏃ュ織鏁版嵁锛堟瘡3绉掑埛鏂颁竴娆★級锛岃€岄潪WebSocket瀹炴椂鎺ㄩ€併€?                            <button class="btn btn-sm btn-outline-primary ms-2" onclick="loadClientLogs()">
                                <i class="bi bi-arrow-clockwise"></i> 绔嬪嵆鍒锋柊
                            </button>
            </div>
                        
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="d-flex mb-3">
                                    <div class="form-check form-switch me-3">
                                        <input class="form-check-input" type="checkbox" id="autoScrollToggle" checked>
                                        <label class="form-check-label" for="autoScrollToggle">鑷姩婊氬姩</label>
            </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="realtimeToggle" checked>
                                        <label class="form-check-label" for="realtimeToggle">瀹炴椂鏇存柊</label>
            </div>
        </div>
        
                                <div class="log-container" id="logContainer" style="height: 500px; overflow-y: auto; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px; font-family: monospace; white-space: pre-wrap; word-wrap: break-word;"></div>
                </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
    <script>
        // 椤甸潰鍔犺浇瀹屾垚鍚庡垵濮嬪寲鏍囩椤?        document.addEventListener('DOMContentLoaded', function() {
            // 妫€鏌ュ苟鏄剧ず鍏嶈矗澹版槑
            checkDisclaimerStatus();
            
            // 浣跨敤Bootstrap鍘熺敓Tab API鍒濆鍖栨墍鏈夋爣绛鹃〉
            var tabElList = [].slice.call(document.querySelectorAll('button[data-bs-toggle="pill"]'));
            tabElList.forEach(function(tabEl) {
                new bootstrap.Tab(tabEl);
            });
            
            // 寮哄埗鏄剧ず绗竴涓爣绛?            var firstTabTrigger = document.querySelector('#screenshots-tab');
            if(firstTabTrigger) {
                var bsTab = new bootstrap.Tab(firstTabTrigger);
                bsTab.show();
            }
            
            // 涓烘瘡涓爣绛鹃〉娣诲姞鐐瑰嚮浜嬩欢锛屾墽琛岀壒瀹氭搷浣?            document.getElementById('config-tab').addEventListener('shown.bs.tab', function(e) {
                loadClientConfig();
            });
            
            document.getElementById('sysinfo-tab').addEventListener('shown.bs.tab', function(e) {
                getSystemInfo();
            });
            
            document.getElementById('files-tab').addEventListener('shown.bs.tab', function(e) {
                browseRootDirectories();
            });
            
            document.getElementById('realtime-logs-tab').addEventListener('shown.bs.tab', function(e) {
                initializeRealtimeLogs();
            });
            
            document.getElementById('keylog-tab').addEventListener('shown.bs.tab', function(e) {
                initializeKeylogger();
            });

            // 纭繚绯荤粺缁存姢鏍囩椤垫甯稿伐浣?            if (document.getElementById('maintenance-tab')) {
                document.getElementById('maintenance-tab').addEventListener('shown.bs.tab', function(e) {
                    loadCleanupConfig();
                });
            } else {
                // 濡傛灉鏍囩涓嶅瓨鍦紝鍒欏垱寤哄畠
                const tabsUl = document.getElementById('clientTabs');
                if (tabsUl) {
                    const maintenanceTab = document.createElement('li');
                    maintenanceTab.className = 'nav-item';
                    maintenanceTab.role = 'presentation';
                    maintenanceTab.innerHTML = `
                        <button class="nav-link" id="maintenance-tab" data-bs-toggle="pill"
                                data-bs-target="#maintenance" type="button" role="tab"
                                aria-controls="maintenance" aria-selected="false">
                            <i class="bi bi-tools"></i> 绯荤粺缁存姢
                        </button>
                    `;
                    tabsUl.appendChild(maintenanceTab);
                    
                    document.getElementById('maintenance-tab').addEventListener('click', function() {
                        loadCleanupConfig();
                    });
                }
            }
            
            // 鍒濆鍖栨壒閲忓垹闄ゅ姛鑳?            initBatchDeleteFeatures();
            
            // 鍒濆鍖栧厤璐ｅ０鏄庡鐞?            initDisclaimerHandlers();

            // 鍚屾鎴浘鍔熻兘
            function syncScreenshots() {
                // 鏄剧ず纭瀵硅瘽妗?                if (!confirm('纭畾瑕佸悓姝ユ埅鍥惧悧锛熻繖灏嗕笂浼犳湰鍦版墍鏈夋湭涓婁紶鐨勬埅鍥惧埌鏈嶅姟鍣ㄣ€?)) {
                    return;
                }
                
                // 鏄剧ず杩涜涓彁绀?                showToast('姝ｅ湪鍚姩鎴浘鍚屾...', 'info');
                
                // 鍙戦€佸悓姝ヨ姹傚埌鏈嶅姟鍣?                fetch(`/api/sync_screenshots/{{ client_id }}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showToast('鍚屾璇锋眰宸插彂閫侊紝瀹㈡埛绔紑濮嬫墽琛屽悓姝ユ搷浣?, 'success');
                        
                        // 璁剧疆涓€涓畾鏃跺櫒锛屾瘡2绉掓鏌ヤ竴娆″悓姝ョ姸鎬?                        const syncCheckInterval = setInterval(() => {
                            fetch(`/api/command_status/{{ client_id }}/${data.command_id}`)
                                .then(response => response.json())
                                .then(statusData => {
                                    if (statusData.status === 'complete') {
                                        clearInterval(syncCheckInterval);
                                        
                                        if (statusData.result.success) {
                                            showToast(`鍚屾瀹屾垚: ${statusData.result.message}`, 'success');
                                            setTimeout(() => {
                                                // 2绉掑悗鍒锋柊椤甸潰鏄剧ず鏂版埅鍥?                                                location.reload();
                                            }, 2000);
                                        } else {
                                            showToast(`鍚屾澶辫触: ${statusData.result.message}`, 'error');
                                        }
                                    }
                                })
                                .catch(error => {
                                    console.error('妫€鏌ュ悓姝ョ姸鎬佸け璐?', error);
                                });
                        }, 2000);
                    } else {
                        showToast(`鍙戦€佸悓姝ヨ姹傚け璐? ${data.message}`, 'error');
                    }
                })
                .catch(error => {
                    showToast(`璇锋眰閿欒: ${error.message}`, 'error');
                });
            }
        });

        // 瀹炴椂鏃ュ織鐩稿叧鍔熻兘
        let logSocket = null; // 榛樿涓嶄娇鐢╓ebSocket
        let logReconnectAttempts = 0;
        const maxLogReconnectAttempts = 5;
        let logPollingInterval;
        
        // 鍒濆鍖栧疄鏃舵棩蹇楀姛鑳?        function initializeRealtimeLogs() {
            // 绔嬪嵆鍔犺浇鍘嗗彶鏃ュ織
            loadClientLogs();
            
            // 鐩存帴鍚敤杞妯″紡锛屼笉灏濊瘯WebSocket
            switchToLogPolling();
            
            // 鏄剧ず鍔犺浇鎻愮ず
            appendLogEntry('[绯荤粺] 宸插惎鐢℉TTP杞妯″紡鑾峰彇瀹炴椂鏃ュ織...', false);
        }
        
        // 鍒涘缓WebSocket杩炴帴 - 姝ゅ嚱鏁颁笉鍐嶄富鍔ㄨ皟鐢?        function createLogSocketConnection() {
            try {
                appendLogEntry('[绯荤粺] 姝ｅ湪杩炴帴WebSocket鏈嶅姟鍣?..', false);
                
                // 鍒涘缓Socket.IO杩炴帴
                logSocket = io('/logs', {
                    transports: ['websocket', 'polling'],  // 浼樺厛浣跨敤WebSocket
                    forceNew: logReconnectAttempts > 0,
                    timeout: 5000,
                    reconnection: true,             // 鍚敤鑷姩閲嶈繛
                    reconnectionAttempts: 5,        // 鏈€澶氶噸璇?娆?                    reconnectionDelay: 1000,        // 鍒濆寤惰繜1绉?                    reconnectionDelayMax: 5000,     // 鏈€澶у欢杩?绉?                    randomizationFactor: 0.5        // 闅忔満鍥犲瓙
                });
                
                // 杩炴帴浜嬩欢
                logSocket.on('connect', () => {
                    logReconnectAttempts = 0;
                    appendLogEntry('[绯荤粺] WebSocket杩炴帴宸插缓绔嬶紝寮€濮嬫帴鏀跺疄鏃舵棩蹇?..', false);
                    logSocket.emit('subscribe', { client_id: '{{ client_id }}' });
                    
                    // 鑾峰彇鍘嗗彶鏃ュ織
                    loadClientLogs();
                    
                    // 娓呴櫎杞闂撮殧
                    if (logPollingInterval) {
                        clearInterval(logPollingInterval);
                        logPollingInterval = null;
                    }
                });
                
                // 杩炴帴閿欒澶勭悊
                logSocket.on('connect_error', (error) => {
                    console.error('WebSocket杩炴帴閿欒:', error);
                    appendLogEntry(`[绯荤粺] WebSocket杩炴帴閿欒: ${error.message}`, false);
                });
                
                // 鏂紑杩炴帴澶勭悊
                logSocket.on('disconnect', (reason) => {
                    appendLogEntry(`[绯荤粺] WebSocket杩炴帴宸叉柇寮€ (${reason})`, false);
                });
                
                // 閲嶈繛灏濊瘯
                logSocket.on('reconnect_attempt', (attemptNumber) => {
                    appendLogEntry(`[绯荤粺] 灏濊瘯閲嶆柊杩炴帴 (${attemptNumber}/5)...`, false);
                });
                
                // 閲嶈繛澶辫触
                logSocket.on('reconnect_failed', () => {
                    appendLogEntry('[绯荤粺] WebSocket閲嶈繛澶辫触锛屽垏鎹㈠埌HTTP杞...', false);
                    switchToLogPolling();
                });
                
                // 鎺ユ敹鏃ュ織浜嬩欢
                logSocket.on('log_event', (data) => {
                    if (data.client_id === '{{ client_id }}' && document.getElementById('realtimeToggle').checked) {
                        appendLogEntry(data.log_entry, true);
                    }
                });
                
            } catch (e) {
                console.error('鍒涘缓WebSocket杩炴帴澶辫触:', e);
                appendLogEntry(`[绯荤粺] 鍒涘缓WebSocket杩炴帴澶辫触: ${e.message}锛屽皢浣跨敤HTTP杞`, false);
                switchToLogPolling();
            }
        }
        
        // 鍒囨崲鍒癏TTP杞
        function switchToLogPolling() {
            if (logPollingInterval) {
                clearInterval(logPollingInterval);
            }
            
            if (document.getElementById('realtimeToggle').checked) {
                // 鍔犺浇鏈€鏂版棩蹇?                loadClientLogs();
                
                // 璁剧疆瀹氭湡杞锛屽苟鎻愪緵杞鐘舵€佹寚绀?                const pollingIndicator = document.createElement('span');
                pollingIndicator.id = 'pollingIndicator';
                pollingIndicator.className = 'badge bg-primary ms-2';
                pollingIndicator.innerHTML = '鑷姩杞涓?;
                
                const realtimeToggleLabel = document.querySelector('label[for="realtimeToggle"]');
                if (realtimeToggleLabel && !document.getElementById('pollingIndicator')) {
                    realtimeToggleLabel.appendChild(pollingIndicator);
                }
                
                // 姣?绉掕疆璇竴娆?                logPollingInterval = setInterval(() => {
                    if (document.getElementById('realtimeToggle').checked) {
                        // 姣忔杞鏃舵洿鏂版寚绀哄櫒
                        const indicator = document.getElementById('pollingIndicator');
                        if (indicator) {
                            indicator.innerHTML = '姝ｅ湪杞...';
                            indicator.className = 'badge bg-warning ms-2';
                            
                            // 鎭㈠鐘舵€?                            setTimeout(() => {
                                if (indicator) {
                                    indicator.innerHTML = '鑷姩杞涓?;
                                    indicator.className = 'badge bg-primary ms-2';
                                }
                            }, 1000);
                        }
                        
                        loadClientLogs(true);  // 闈欓粯鍔犺浇锛岄伩鍏嶉噸澶嶆秷鎭?                    }
                }, 3000);
            } else {
                // 绉婚櫎杞鎸囩ず鍣?                const indicator = document.getElementById('pollingIndicator');
                if (indicator) {
                    indicator.remove();
                }
            }
        }
        
        // 鍔犺浇瀹㈡埛绔棩蹇?        function loadClientLogs(silent = false) {
            // 鏄剧ず鍒锋柊鎸囩ず鍣?            if (!silent) {
                const refreshBtn = document.querySelectorAll('[onclick="loadClientLogs()"]');
                refreshBtn.forEach(btn => {
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 鍒锋柊涓?;
                    btn.disabled = true;
                    
                    // 1绉掑悗鎭㈠鎸夐挳鐘舵€?鏃犺鎴愬姛涓庡惁)
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }, 1000);
                });
            }

            fetch(`/api/log_history/{{ client_id }}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP閿欒 ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.logs && data.logs.length > 0) {
                        if (!silent) {
                            clearLogDisplay();
                            data.logs.forEach(log => {
                                appendLogEntry(log, false);
                            });
                            scrollLogToBottom();
                        } else {
                            // 鍙坊鍔犳柊鏃ュ織
                            const logContainer = document.getElementById('logContainer');
                            const currentLogs = new Set(Array.from(logContainer.children).map(el => el.textContent));
                            
                            let newLogsAdded = false;
                            data.logs.forEach(log => {
                                if (!currentLogs.has(log)) {
                                    appendLogEntry(log, true);
                                    newLogsAdded = true;
                                }
                            });
                            
                            if (newLogsAdded) {
                                scrollLogToBottom();
                            }
                        }
                    } else if (!silent && document.getElementById('logContainer').children.length === 0) {
                        appendLogEntry("鏆傛棤鏃ュ織璁板綍", false);
                    }
                })
                .catch(error => {
                    console.error("鍔犺浇鏃ュ織鍘嗗彶澶辫触:", error);
                    if (!silent) {
                        appendLogEntry(`[閿欒] 鍔犺浇鏃ュ織鍘嗗彶澶辫触: ${error.message}锛屽皢鍦ㄤ笅娆¤疆璇㈤噸璇昤, false);
                    }
                });
        }
        
        // 娣诲姞鏃ュ織鏉＄洰
        function appendLogEntry(logEntry, highlight) {
            const logContainer = document.getElementById('logContainer');
            if (!logContainer) return;
            
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.style.margin = '5px 0';
            entry.style.padding = '5px';
            entry.style.borderBottom = '1px solid #eee';
            
            if (highlight) {
                entry.style.backgroundColor = '#ffeaa7';
                entry.style.animation = 'flash 1s linear';
            }
            
            entry.textContent = logEntry;
            logContainer.appendChild(entry);
            
            // 鑷姩婊氬姩
            if (document.getElementById('autoScrollToggle').checked) {
                scrollLogToBottom();
            }
            
            // 闄愬埗鏃ュ織鏉℃暟
            const maxEntries = 1000;
            while (logContainer.children.length > maxEntries) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }
        
        // 婊氬姩鍒板簳閮?        function scrollLogToBottom() {
            const logContainer = document.getElementById('logContainer');
            if (logContainer) {
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        }
        
        // 娓呯┖鏃ュ織鏄剧ず
        function clearLogDisplay() {
            const logContainer = document.getElementById('logContainer');
            if (logContainer) {
                logContainer.innerHTML = '';
            }
        }

        // 鍔犺浇瀹㈡埛绔厤缃?        function loadClientConfig() {
            fetch('/api/config/{{ client_id }}')
                    .then(response => response.json())
                    .then(data => {
                    // 濉厖琛ㄥ崟
                    document.getElementById('screenshot_interval').value = data.screenshot_interval;
                    document.getElementById('keylogger_interval').value = data.keylogger_interval;
                    document.getElementById('keylogger_interval_recording').value = data.keylogger_interval_recording;
                    document.getElementById('upload_interval').value = data.upload_interval;
                    document.getElementById('check_command_interval').value = data.check_command_interval;
                    document.getElementById('recording_duration').value = data.recording_duration;
                    document.getElementById('recording_fps').value = data.recording_fps;
                    document.getElementById('enable_screenshot').checked = data.enable_screenshot;
                    document.getElementById('enable_keylogger').checked = data.enable_keylogger;
                    document.getElementById('enable_upload').checked = data.enable_upload;
                    
                    // 閰嶇疆鍚屾闂撮殧
                    if (document.getElementById('config_sync_interval')) {
                        document.getElementById('config_sync_interval').value = 
                            data.config_sync_interval !== undefined ? data.config_sync_interval : 30;
                    }
                    
                    // 瀹炴椂閿洏璁板綍閫夐」
                    if(document.getElementById('enable_realtime_keylog')) {
                        document.getElementById('enable_realtime_keylog').checked = 
                            data.enable_realtime_keylog !== undefined ? data.enable_realtime_keylog : true;
                    }
                })
                .catch(error => {
                    document.getElementById('error-message').textContent = '鍔犺浇閰嶇疆澶辫触: ' + error.message;
                    document.getElementById('error-message').style.display = 'block';
                });
        }
        
        // 鎻愪氦閰嶇疆琛ㄥ崟
        document.getElementById('client-config-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const successMessage = document.getElementById('success-message');
            const errorMessage = document.getElementById('error-message');
            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';
            
            // 鑾峰彇閰嶇疆
            const config = {
                screenshot_interval: parseInt(document.getElementById('screenshot_interval').value),
                keylogger_interval: parseFloat(document.getElementById('keylogger_interval').value),
                keylogger_interval_recording: parseFloat(document.getElementById('keylogger_interval_recording').value),
                upload_interval: parseInt(document.getElementById('upload_interval').value),
                check_command_interval: parseInt(document.getElementById('check_command_interval').value),
                recording_duration: parseInt(document.getElementById('recording_duration').value),
                recording_fps: parseInt(document.getElementById('recording_fps').value),
                enable_screenshot: document.getElementById('enable_screenshot').checked,
                enable_keylogger: document.getElementById('enable_keylogger').checked,
                enable_upload: document.getElementById('enable_upload').checked,
                enable_realtime_keylog: document.getElementById('enable_realtime_keylog').checked
            };
            
            // 娣诲姞閰嶇疆鍚屾闂撮殧
            if (document.getElementById('config_sync_interval')) {
                config.config_sync_interval = parseInt(document.getElementById('config_sync_interval').value);
                            }
                            
            // 鍙戦€佽姹?            fetch('/api/config/{{ client_id }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            })
                    .then(response => response.json())
                    .then(data => {
                if (data.status === 'success') {
                    successMessage.textContent = data.message;
                    successMessage.style.display = 'block';
                            } else {
                    errorMessage.textContent = data.message || '鏇存柊閰嶇疆澶辫触';
                    errorMessage.style.display = 'block';
                }
            })
            .catch(error => {
                errorMessage.textContent = '璇锋眰閿欒: ' + error.message;
                errorMessage.style.display = 'block';
            });
        });
                            
        // 绔嬪嵆鎴浘
        function takeScreenshot() {
            fetch('/api/screenshot/{{ client_id }}', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                            setTimeout(() => {
                                location.reload();
                            }, 5000);
            })
            .catch(error => {
                alert('璇锋眰閿欒: ' + error.message);
            });
        }
        
        // 寮€濮嬪綍灞?        function startRecording() {
            const duration = document.getElementById('recording_duration').value || 60;
            const fps = document.getElementById('recording_fps').value || 10;
            
            fetch('/api/record/{{ client_id }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `duration=${duration}&fps=${fps}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast('褰曞睆宸插紑濮?, 'success');
                    // 绔嬪嵆妫€鏌ョ姸鎬佹洿鏂癠I
                    checkRecordingStatus();
                } else {
                    showToast(data.message || '寮€濮嬪綍灞忓け璐?, 'error');
                }
            })
            .catch(error => {
                showToast('璇锋眰閿欒: ' + error.message, 'error');
            });
        }
        
        // 鍋滄褰曞睆
        function stopRecording() {
            fetch('/api/stop_record/{{ client_id }}', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast('褰曞睆宸插仠姝?, 'success');
                    // 绔嬪嵆妫€鏌ョ姸鎬佹洿鏂癠I
                    checkRecordingStatus();
                    // 涓嶅啀鑷姩鍒锋柊椤甸潰
                } else {
                    showToast(data.message || '鍋滄褰曞睆澶辫触', 'error');
                }
            })
            .catch(error => {
                showToast('璇锋眰閿欒: ' + error.message, 'error');
            });
        }
        
        // 鍋滄瀹炴椂褰曞睆
        function stopRealtimeRecording() {
            fetch('/api/stop_realtime_record/{{ client_id }}', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast('瀹炴椂褰曞睆宸插仠姝?, 'success');
                    // 绔嬪嵆妫€鏌ョ姸鎬佹洿鏂癠I
                    checkRecordingStatus();
                    // 涓嶅啀鑷姩鍒锋柊椤甸潰
                } else {
                    showToast(data.message || '鍋滄褰曞睆澶辫触', 'error');
                }
            })
            .catch(error => {
                showToast('璇锋眰閿欒: ' + error.message, 'error');
            });
        }
        
        // 寮哄埗缁堟鎵€鏈夊綍灞?        function forceStopAllRecordings() {
            if (!confirm('纭畾瑕佸己鍒剁粓姝㈡墍鏈夊綍灞忎换鍔″悧锛?)) return;
            
            fetch('/api/force_stop_all_recordings/{{ client_id }}', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast('宸插己鍒剁粓姝㈡墍鏈夊綍灞忎换鍔?, 'success');
                    // 绔嬪嵆妫€鏌ョ姸鎬佹洿鏂癠I
                    checkRecordingStatus();
                    // 涓嶅啀鑷姩鍒锋柊椤甸潰
                } else {
                    showToast(data.message || '鎿嶄綔澶辫触', 'error');
                }
            })
            .catch(error => {
                showToast('璇锋眰閿欒: ' + error.message, 'error');
            });
        }
        
        // 鑾峰彇绯荤粺淇℃伅
        function getSystemInfo() {
            // 鏄剧ず鍔犺浇涓?            document.getElementById('sysinfo-loading').classList.remove('d-none');
            document.getElementById('sysinfo-error').classList.add('d-none');
            document.getElementById('sysinfo-container').classList.add('d-none');
            
            // 鍙戦€佽姹?            fetch('/api/sysinfo/{{ client_id }}', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    pollCommandStatus(data.command_id, function(result) {
                        if (result.success) {
                            try {
                                // 妫€鏌ユ槸鍚﹀凡缁忔槸JSON瀵硅薄
                                let sysinfo = typeof result.message === 'object' ? result.message : JSON.parse(result.message);
                                console.log('绯荤粺淇℃伅鏁版嵁:', sysinfo);
                                displaySystemInfo(sysinfo, result.from_cache);
                                document.getElementById('sysinfo-container').classList.remove('d-none');
                            } catch (e) {
                                console.error('瑙ｆ瀽绯荤粺淇℃伅澶辫触:', e, result.message);
                                document.getElementById('sysinfo-error').textContent = '瑙ｆ瀽绯荤粺淇℃伅澶辫触: ' + e.message;
                                document.getElementById('sysinfo-error').classList.remove('d-none');
                            }
                } else {
                            document.getElementById('sysinfo-error').textContent = '鑾峰彇绯荤粺淇℃伅澶辫触: ' + result.message;
                            document.getElementById('sysinfo-error').classList.remove('d-none');
                        }
                        document.getElementById('sysinfo-loading').classList.add('d-none');
                    });
                } else {
                    document.getElementById('sysinfo-error').textContent = data.message || '鍙戦€佽姹傚け璐?;
                    document.getElementById('sysinfo-error').classList.remove('d-none');
                    document.getElementById('sysinfo-loading').classList.add('d-none');
                }
            })
            .catch(error => {
                document.getElementById('sysinfo-error').textContent = '璇锋眰閿欒: ' + error.message;
                document.getElementById('sysinfo-error').classList.remove('d-none');
                document.getElementById('sysinfo-loading').classList.add('d-none');
            });
        }

        // 鏄剧ず绯荤粺淇℃伅
        function displaySystemInfo(info, from_cache) {
            try {
                console.log('寮€濮嬫樉绀虹郴缁熶俊鎭?, info);
                
                // 绉婚櫎涔嬪墠鐨勭紦瀛樻彁绀?                const oldAlert = document.querySelector('#sysinfo-container .alert-warning');
                if (oldAlert) {
                    oldAlert.parentNode.removeChild(oldAlert);
                }
                
                // 妫€鏌ユ椂闂存埑鏄惁杩囨湡锛堣秴杩?0绉掞級
                const showCacheWarning = from_cache || checkTimestampExpired(info.timestamp, 50);
                
                // 娣诲姞缂撳瓨鎻愮ず
                if (showCacheWarning) {
                    const cacheAlert = document.createElement('div');
                    cacheAlert.className = 'alert alert-warning mb-3';
                    cacheAlert.innerHTML = '<i class="bi bi-info-circle"></i> 鏄剧ず鐨勫彲鑳芥槸缂撳瓨鐨勭郴缁熶俊鎭紝鍙兘涓嶆槸鏈€鏂版暟鎹紙鍙互閫氳繃鐐瑰嚮鍒锋柊鍚庢煡鐪嬫暟鎹彉鍖栧垽鏂級';
                    
                    const infoContainer = document.getElementById('sysinfo-container');
                    if (infoContainer.firstChild) {
                        infoContainer.insertBefore(cacheAlert, infoContainer.firstChild);
                    } else {
                        infoContainer.appendChild(cacheAlert);
                    }
                }
        
                // 鍩烘湰淇℃伅
                document.getElementById('sysinfo-hostname').textContent = info.hostname || '鏈煡';
                document.getElementById('sysinfo-username').textContent = info.username || '鏈煡';
                document.getElementById('sysinfo-system').textContent = info.system || info.platform || '鏈煡';
                document.getElementById('sysinfo-version').textContent = info.version || '鏈煡';
                document.getElementById('sysinfo-processor').textContent = info.processor || '鏈煡';
                document.getElementById('sysinfo-timestamp').textContent = formatDateTime(info.timestamp) || '鏈煡';
            
                // 鎬ц兘淇℃伅
                const cpuUsage = info.cpu_usage || 0;
                const memoryPercent = info.memory && info.memory.percent ? info.memory.percent : 0;
                
                document.getElementById('sysinfo-cpu').style.width = cpuUsage + '%';
                document.getElementById('sysinfo-cpu').textContent = cpuUsage + '%';
                document.getElementById('sysinfo-memory').style.width = memoryPercent + '%';
                document.getElementById('sysinfo-memory').textContent = memoryPercent + '%';
                
                document.getElementById('sysinfo-cpu-count').textContent = info.cpu_count || '鏈煡';
                
                if (info.memory) {
                    document.getElementById('sysinfo-memory-total').textContent = formatBytes(info.memory.total) || '鏈煡';
                    document.getElementById('sysinfo-memory-available').textContent = formatBytes(info.memory.available) || '鏈煡';
                }
                
                if (info.network) {
                    document.getElementById('sysinfo-network-sent').textContent = formatBytes(info.network.bytes_sent) || '鏈煡';
                    document.getElementById('sysinfo-network-recv').textContent = formatBytes(info.network.bytes_recv) || '鏈煡';
                }
                
                // 纾佺洏淇℃伅
                const disksContainer = document.getElementById('sysinfo-disks');
                disksContainer.innerHTML = '';
                
                if (info.disk) {
                    console.log('澶勭悊纾佺洏淇℃伅', info.disk);
                    for (const [drive, data] of Object.entries(info.disk)) {
                        const diskCard = document.createElement('div');
                        diskCard.className = 'col-md-4 mb-3';
                        
                        diskCard.innerHTML = `
                            <div class="card">
                                <div class="card-header">${drive}</div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">浣跨敤鐜? ${data.percent}%</label>
                                        <div class="progress">
                                            <div class="progress-bar bg-info" role="progressbar" style="width: ${data.percent}%" 
                                                 aria-valuenow="${data.percent}" aria-valuemin="0" aria-valuemax="100">${data.percent}%</div>
                                        </div>
                                    </div>
                                    <small>鎬诲閲? ${formatBytes(data.total)}</small><br>
                                    <small>宸蹭娇鐢? ${formatBytes(data.used)}</small><br>
                                    <small>鍙敤绌洪棿: ${formatBytes(data.free)}</small>
                                </div>
                            </div>
                        `;
                        
                        disksContainer.appendChild(diskCard);
                    }
                } else {
                    console.warn('鏃犵鐩樹俊鎭?);
                    disksContainer.innerHTML = '<div class="alert alert-warning">鏃犳硶鑾峰彇纾佺洏淇℃伅</div>';
                }
                
                console.log('绯荤粺淇℃伅鏄剧ず瀹屾垚');
            } catch (e) {
                console.error('鏄剧ず绯荤粺淇℃伅鏃跺嚭閿?', e);
                document.getElementById('sysinfo-error').textContent = '鏄剧ず绯荤粺淇℃伅鍑洪敊: ' + e.message;
                document.getElementById('sysinfo-error').classList.remove('d-none');
            }
        }

        // 妫€鏌ユ椂闂存埑鏄惁杩囨湡
        function checkTimestampExpired(timestamp, maxAgeSeconds) {
            if (!timestamp) return true;
            
            try {
                const stampDate = new Date(timestamp);
                const now = new Date();
                const diffSeconds = (now - stampDate) / 1000;
                
                return diffSeconds > maxAgeSeconds;
            } catch (e) {
                console.error('妫€鏌ユ椂闂存埑鍑洪敊:', e);
                return true; // 鍑洪敊鏃堕粯璁ゆ樉绀虹紦瀛樿鍛?            }
        }

        // 鏂囦欢娴忚鍔熻兘
        let currentPath = null;
        let pathHistory = [];

        // 娴忚鏍圭洰褰?        function browseRootDirectories() {
            currentPath = null;
            pathHistory = [];
            updateBreadcrumb();
            browseFiles(null);
        }

        // 娴忚鎸囧畾鐩綍
        function browseDirectory(path) {
            if (currentPath !== path) {
                if (currentPath !== null) {
                    pathHistory.push(currentPath);
                }
                currentPath = path;
                updateBreadcrumb();
            }
            browseFiles(path);
        }

        // 鏇存柊闈㈠寘灞戝鑸?        function updateBreadcrumb() {
            const breadcrumb = document.getElementById('file-breadcrumb');
            breadcrumb.innerHTML = '<li class="breadcrumb-item"><a href="#" onclick="browseRootDirectories(); return false;">鏍圭洰褰?/a></li>';
            
            if (currentPath !== null) {
                const parts = currentPath.split('\\');
                let currentBuildPath = '';
                
                for (let i = 0; i < parts.length; i++) {
                    currentBuildPath += parts[i];
                    
                    if (i === parts.length - 1) {
                        // 鏈€鍚庝竴涓儴鍒嗭紝褰撳墠鐩綍
                        const item = document.createElement('li');
                        item.className = 'breadcrumb-item active';
                        item.textContent = parts[i];
                        breadcrumb.appendChild(item);
                    } else {
                        // 涓婄骇鐩綍锛屽彲鐐瑰嚮
                        const item = document.createElement('li');
                        item.className = 'breadcrumb-item';
                        
                        const link = document.createElement('a');
                        link.href = '#';
                        link.textContent = parts[i];
                        link.onclick = (function(path) {
                            return function() {
                                browseDirectory(path);
                                return false;
                            };
                        })(currentBuildPath);
                        
                        item.appendChild(link);
                        breadcrumb.appendChild(item);
                    }
                    
                    if (i < parts.length - 1) {
                        currentBuildPath += '\\';
                    }
                }
            }
        }

        // 娴忚鏂囦欢
        function browseFiles(path = null) {
            // 鏄剧ず鍔犺浇涓?            document.getElementById('file-browser-loading').classList.remove('d-none');
            document.getElementById('file-browser-error').classList.add('d-none');
            document.getElementById('file-browser-error').textContent = '';
            
            console.log(`娴忚鏂囦欢璺緞: ${path || '鏍圭洰褰?}`);
            
            // 鏇存柊褰撳墠璺緞
            currentPath = path;
            updateBreadcrumb();
            
            // 鍙戦€佽姹?            fetch('/api/browse_files/{{ client_id }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ path: path })
            })
            .then(response => response.json())
            .then(data => {
                console.log('娴忚鏂囦欢璇锋眰鍝嶅簲:', data);
                if (data.status === 'success') {
                    pollCommandStatus(data.command_id, function(result) {
                        console.log('鏂囦欢娴忚缁撴灉:', result);
                        if (result.success) {
                            try {
                                // 灏濊瘯瑙ｆ瀽缁撴灉
                                let fileData;
                                if (typeof result.message === 'string') {
                                    fileData = JSON.parse(result.message);
                                    console.log('瑙ｆ瀽鍚庣殑鏂囦欢鏁版嵁:', fileData);
                                } else if (typeof result.message === 'object') {
                                    fileData = result.message;
                                    console.log('鐩存帴浣跨敤瀵硅薄鏂囦欢鏁版嵁:', fileData);
                                } else {
                                    throw new Error('鏈煡鐨勭粨鏋滄牸寮?);
                                }
                                
                                displayFileList(fileData);
                            } catch (e) {
                                console.error('瑙ｆ瀽鏂囦欢鍒楄〃閿欒:', e, result.message);
                                document.getElementById('file-browser-error').textContent = '瑙ｆ瀽鏂囦欢鍒楄〃澶辫触: ' + e.message;
                                document.getElementById('file-browser-error').classList.remove('d-none');
                            }
                } else {
                            console.error('鑾峰彇鏂囦欢鍒楄〃澶辫触:', result.message);
                            document.getElementById('file-browser-error').textContent = '鑾峰彇鏂囦欢鍒楄〃澶辫触: ' + result.message;
                            document.getElementById('file-browser-error').classList.remove('d-none');
                        }
                        document.getElementById('file-browser-loading').classList.add('d-none');
                    });
                } else {
                    console.error('鍙戦€佹祻瑙堣姹傚け璐?', data.message);
                    document.getElementById('file-browser-error').textContent = data.message || '鍙戦€佽姹傚け璐?;
                    document.getElementById('file-browser-error').classList.remove('d-none');
                    document.getElementById('file-browser-loading').classList.add('d-none');
                }
            })
            .catch(error => {
                console.error('娴忚璇锋眰閿欒:', error);
                document.getElementById('file-browser-error').textContent = '璇锋眰閿欒: ' + error.message;
                document.getElementById('file-browser-error').classList.remove('d-none');
                document.getElementById('file-browser-loading').classList.add('d-none');
            });
        }

        // 鏄剧ず鏂囦欢鍒楄〃
        function displayFileList(data) {
            console.log('寮€濮嬫樉绀烘枃浠跺垪琛?', data);
            const directoryList = document.getElementById('directory-list');
            const fileList = document.getElementById('file-list');
            
            directoryList.innerHTML = '';
            fileList.innerHTML = '';
            
            // 濡傛灉涓嶆槸鏍圭洰褰曪紝娣诲姞杩斿洖涓婄骇鐩綍閫夐」
            if (pathHistory.length > 0 && currentPath !== null) {
                const backItem = document.createElement('a');
                backItem.className = 'list-group-item list-group-item-action';
                backItem.href = '#';
                backItem.innerHTML = '<i class="bi bi-arrow-up"></i> 杩斿洖涓婄骇鐩綍';
                backItem.onclick = function() {
                    currentPath = pathHistory.pop();
                    updateBreadcrumb();
                    browseFiles(currentPath);
                    return false;
                };
                directoryList.appendChild(backItem);
            }
            
            // 鏄剧ず鐩綍
            if (data.directories && data.directories.length > 0) {
                // 妫€鏌ユ槸鍚︽槸鏍圭洰褰曪紙鏄剧ず纾佺洏鍒楄〃锛?                if (currentPath === null && data.drive_labels && data.drive_labels.length > 0) {
                    console.log('鏄剧ず椹卞姩鍣ㄥ垪琛?', data.drive_labels);
                    // 濡傛灉鏈夊甫鏍囩鐨勭鐩樹俊鎭紝浼樺厛浣跨敤瀹?                    data.drive_labels.forEach(drive => {
                        const item = document.createElement('a');
                        item.className = 'list-group-item list-group-item-action';
                        item.href = '#';
                        item.innerHTML = '<i class="bi bi-hdd-fill me-2"></i> ' + drive.name;
                        item.onclick = function() {
                            browseDirectory(drive.path);
                            return false;
                        };
                        directoryList.appendChild(item);
                    });
                } else {
                    console.log('鏄剧ず甯歌鐩綍鍒楄〃:', data.directories);
                    // 鏅€氱洰褰?                    data.directories.forEach(dir => {
                        try {
                            const dirName = dir.split('\\').pop().split('/').pop();
                        const item = document.createElement('a');
                        item.className = 'list-group-item list-group-item-action';
                        item.href = '#';
                        item.innerHTML = '<i class="bi bi-folder-fill me-2"></i> ' + dirName;
                        item.onclick = function() {
                            browseDirectory(dir);
                            return false;
                        };
                        directoryList.appendChild(item);
                        } catch (e) {
                            console.error('澶勭悊鐩綍椤归敊璇?', e, dir);
                        }
                    });
                }
            } else if (directoryList.children.length === 0) {
                console.log('娌℃湁鎵惧埌瀛愮洰褰?);
                const emptyItem = document.createElement('div');
                emptyItem.className = 'list-group-item text-muted';
                emptyItem.textContent = '鏃犲瓙鐩綍';
                directoryList.appendChild(emptyItem);
            }
            
            // 鏄剧ず鏂囦欢
            if (data.files && data.files.length > 0) {
                console.log('鏄剧ず鏂囦欢鍒楄〃:', data.files.length, '涓枃浠?);
                data.files.forEach(file => {
                    try {
                        const item = document.createElement('div'); // 浣跨敤div鍏冪礌
                        item.className = 'list-group-item';
                        
                        // 鏇存柊HTML缁撴瀯锛屼娇鐢╠ownloadFile鍑芥暟
                    item.innerHTML = `
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${file.name}</h6>
                            <small>${formatBytes(file.size)}</small>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">淇敼鏃堕棿: ${formatDateTime(file.modified)}</small>
                            <div>
                                <button class="btn btn-sm btn-outline-success" onclick="downloadFile('${file.path.replace(/\\/g, '\\\\')}', '${file.name}'); event.stopPropagation();">
                                    <i class="bi bi-download"></i> 涓嬭浇
                                </button>
                            </div>
                        </div>
                    `;
                        
                    fileList.appendChild(item);
                    } catch (e) {
                        console.error('澶勭悊鏂囦欢椤归敊璇?', e, file);
                    }
                });
            } else {
                console.log('娌℃湁鎵惧埌鏂囦欢');
                const emptyItem = document.createElement('div');
                emptyItem.className = 'list-group-item text-muted';
                emptyItem.textContent = '鐩綍涓虹┖';
                fileList.appendChild(emptyItem);
            }
            
            // 濡傛灉鏈夋埅鏂俊鎭紝鏄剧ず鎻愮ず
            if (data.truncated && data.truncated_message) {
                console.log('鏄剧ず鎴柇鎻愮ず:', data.truncated_message);
                const truncatedInfo = document.createElement('div');
                truncatedInfo.className = 'alert alert-info mt-2';
                truncatedInfo.textContent = data.truncated_message;
                directoryList.parentNode.insertBefore(truncatedInfo, directoryList.nextSibling);
            }
            
            console.log('鏂囦欢鍒楄〃鏄剧ず瀹屾垚');
        }

        // 鎭㈠API鏂瑰紡涓嬭浇鏂囦欢鍔熻兘
        function downloadFile(filePath, fileName) {
            // 鏄剧ず鍔犺浇涓?            document.getElementById('file-browser-loading').classList.remove('d-none');
            document.getElementById('file-browser-error').classList.add('d-none');
            
            // 鍙戦€佽姹?            fetch('/api/download_file/{{ client_id }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ file_path: filePath })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // 鍒涘缓鐘舵€佹秷鎭厓绱犲苟娣诲姞鍒伴《閮?                    const statusElement = document.createElement('div');
                    statusElement.className = 'alert alert-info mb-3';
                    statusElement.innerHTML = `<i class="bi bi-info-circle"></i> 姝ｅ湪浠庡鎴风涓嬭浇鏂囦欢: ${fileName}锛岃绋嶅€?..`;
                    
                    // 娣诲姞鍒版枃浠舵祻瑙堝尯鍩熺殑椤堕儴
                    const container = document.getElementById('file-browser-container');
                    // 浣跨敤prepend鏂规硶瀹夊叏鍦版彃鍏ュ埌瀹瑰櫒椤堕儴
                    container.prepend(statusElement);
                    
                    // 杞涓嬭浇鐘舵€?                    pollCommandStatus(data.command_id, function(result) {
                        document.getElementById('file-browser-loading').classList.add('d-none');
                        
                        if (result.success) {
                            statusElement.className = 'alert alert-success mb-3';
                            statusElement.innerHTML = `<i class="bi bi-check-circle"></i> 鏂囦欢宸叉垚鍔熶笅杞藉埌鏈嶅姟鍣╜;
                            
                            // 鍒涘缓涓嬭浇閾炬帴骞惰嚜鍔ㄧ偣鍑昏Е鍙戜笅杞?                            setTimeout(() => {
                                const downloadLink = document.createElement('a');
                                // 浣跨敤encodeURIComponent澶勭悊鏂囦欢鍚嶄腑鐨勭壒娈婂瓧绗?                                const encodedFileName = encodeURIComponent(fileName);
                                downloadLink.href = `/downloads/{{ client_id }}/${encodedFileName}`;
                                downloadLink.download = fileName;
                                downloadLink.style.display = 'none';
                                document.body.appendChild(downloadLink);
                                downloadLink.click();
                                document.body.removeChild(downloadLink);
                                
                                // 鏇存柊鐘舵€佹秷鎭?                                statusElement.innerHTML = `<i class="bi bi-check-circle"></i> 鏂囦欢宸叉垚鍔熶笅杞? ${fileName}`;
                            }, 500);
                        } else {
                            statusElement.className = 'alert alert-danger mb-3';
                            statusElement.innerHTML = `<i class="bi bi-x-circle"></i> 鏂囦欢涓嬭浇澶辫触: ${result.message}`;
                        }
                        
                        // 10绉掑悗绉婚櫎鐘舵€佹秷鎭?                        setTimeout(() => {
                            statusElement.remove();
                        }, 10000);
                    });
                } else {
                    document.getElementById('file-browser-error').textContent = data.message || '鍙戦€佽姹傚け璐?;
                    document.getElementById('file-browser-error').classList.remove('d-none');
                    document.getElementById('file-browser-loading').classList.add('d-none');
                }
            })
            .catch(error => {
                document.getElementById('file-browser-error').textContent = '璇锋眰閿欒: ' + error.message;
                document.getElementById('file-browser-error').classList.remove('d-none');
                document.getElementById('file-browser-loading').classList.add('d-none');
            });
        }

        // 璇诲彇鏂囦欢鍐呭
        function readFile(filePath, fileName) {
            // 鏄剧ず鍔犺浇涓?            document.getElementById('file-browser-loading').classList.remove('d-none');
            document.getElementById('file-browser-error').classList.add('d-none');
            
            // 鍙戦€佽姹?            fetch('/api/read_file/{{ client_id }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ file_path: filePath })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    pollCommandStatus(data.command_id, function(result) {
                        if (result.success) {
                            try {
                                const fileData = JSON.parse(result.message);
                                displayFileContent(fileData, fileName);
                            } catch (e) {
                                document.getElementById('file-browser-error').textContent = '瑙ｆ瀽鏂囦欢鍐呭澶辫触: ' + e.message;
                                document.getElementById('file-browser-error').classList.remove('d-none');
                            }
                } else {
                            document.getElementById('file-browser-error').textContent = '璇诲彇鏂囦欢澶辫触: ' + result.message;
                            document.getElementById('file-browser-error').classList.remove('d-none');
                        }
                        document.getElementById('file-browser-loading').classList.add('d-none');
                    });
                } else {
                    document.getElementById('file-browser-error').textContent = data.message || '鍙戦€佽姹傚け璐?;
                    document.getElementById('file-browser-error').classList.remove('d-none');
                    document.getElementById('file-browser-loading').classList.add('d-none');
                }
            })
            .catch(error => {
                document.getElementById('file-browser-error').textContent = '璇锋眰閿欒: ' + error.message;
                document.getElementById('file-browser-error').classList.remove('d-none');
                document.getElementById('file-browser-loading').classList.add('d-none');
            });
        }

        // 鏄剧ず鏂囦欢鍐呭
        function displayFileContent(fileData, fileName) {
            const contentContainer = document.getElementById('file-content-container');
            const contentName = document.getElementById('file-content-name');
            const content = document.getElementById('file-content');
            
            contentName.textContent = fileName + (fileData.is_binary ? ' (浜岃繘鍒舵枃浠?' : '');
            content.textContent = fileData.content;
            
            contentContainer.classList.remove('d-none');
        }

        // 鍏抽棴鏂囦欢鍐呭
        function closeFileContent() {
            document.getElementById('file-content-container').classList.add('d-none');
        }

        // 杈呭姪鍑芥暟 - 鏍煎紡鍖栧瓧鑺傚ぇ灏?        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
            
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        // 杈呭姪鍑芥暟 - 鏍煎紡鍖栨棩鏈熸椂闂?        function formatDateTime(isoString) {
            try {
                const date = new Date(isoString);
                return date.toLocaleString();
            } catch (e) {
                return isoString;
            }
        }

        // 杞鍛戒护鐘舵€?        function pollCommandStatus(commandId, callback) {
            let attempts = 0;
            const maxAttempts = 60; // 澧炲姞鏈€澶у皾璇曟鏁板埌60娆?            const initialInterval = 1000; // 浠?绉掑紑濮?            const maxInterval = 5000; // 鏈€澶ч棿闅?绉?            let currentInterval = initialInterval;
            
            // 鏄剧ず杞鐘舵€?            console.log(`寮€濮嬭疆璇㈠懡浠ょ姸鎬? ${commandId}`);
            
            const interval = setInterval(() => {
                attempts++;
                
                // 璋冩暣杞闂撮殧锛岄€愭笎澧炲姞浠ュ噺灏戞湇鍔″櫒鍘嬪姏
                if (attempts > 10) { // 瓒呰繃10娆″悗寮€濮嬪鍔犻棿闅?                    currentInterval = Math.min(currentInterval * 1.5, maxInterval);
                }
                
                if (attempts > maxAttempts) {
                    clearInterval(interval);
                    console.warn(`鍛戒护${commandId}杞瓒呮椂锛屽凡灏濊瘯${maxAttempts}娆);
                    callback({
                        success: false,
                        message: `鑾峰彇鍛戒护缁撴灉瓒呮椂锛岃妫€鏌ョ綉缁滆繛鎺ユ垨鏈嶅姟鍣ㄧ姸鎬乣
                    });
                    return;
                }
                
                console.log(`绗?{attempts}娆¤疆璇㈠懡浠ょ姸鎬? ${commandId}`);
                
                fetch(`/api/command_status/{{ client_id }}/${commandId}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log(`鍛戒护鐘舵€? ${data.status}`, data);
                        
                        if (data.status === 'complete') {
                            clearInterval(interval);
                            console.log(`鍛戒护${commandId}瀹屾垚锛岀粨鏋?`, data.result);
                            callback(data.result);
                        }
                    })
                    .catch(error => {
                        console.error(`杞鍛戒护鐘舵€佸嚭閿? ${error}`);
                        // 涓嶈绔嬪嵆缁撴潫锛屽彲鑳藉彧鏄复鏃剁綉缁滈棶棰?                    });
            }, currentInterval);
        }

        // 閿洏璁板綍鐩稿叧鍔熻兘
        let keylogSocket = null; // 榛樿涓嶄娇鐢╓ebSocket
        let keylogReconnectAttempts = 0;
        const maxKeylogReconnectAttempts = 5;
        let keylogPollingInterval;
        
        // 鍒濆鍖栭敭鐩樿褰曞櫒
        function initializeKeylogger() {
            // 绔嬪嵆鍔犺浇鍘嗗彶璁板綍
            loadKeylogHistory();
            
            // 鐩存帴浣跨敤HTTP杞锛屼笉灏濊瘯WebSocket
            switchToKeylogPolling();
            
            // 鏄剧ず鎻愮ず
            appendKeylogEntry('[绯荤粺] 宸插惎鐢℉TTP杞妯″紡鑾峰彇閿洏璁板綍...', false);
        }
        
        // 鍒涘缓閿洏璁板綍WebSocket杩炴帴 - 姝ゅ嚱鏁颁笉鍐嶄富鍔ㄨ皟鐢?        function createKeylogSocketConnection() {
            try {
                appendKeylogEntry('[绯荤粺] 姝ｅ湪杩炴帴閿洏璁板綍鏈嶅姟鍣?..', false);
                
                // 鍒涘缓Socket.IO杩炴帴
                keylogSocket = io('/keylog', {
                    transports: ['websocket', 'polling'],  // 浼樺厛浣跨敤WebSocket
                    forceNew: keylogReconnectAttempts > 0,
                    timeout: 5000,
                    reconnection: true,             // 鍚敤鑷姩閲嶈繛
                    reconnectionAttempts: 5,        // 鏈€澶氶噸璇?娆?                    reconnectionDelay: 1000,        // 鍒濆寤惰繜1绉?                    reconnectionDelayMax: 5000,     // 鏈€澶у欢杩?绉?                    randomizationFactor: 0.5        // 闅忔満鍥犲瓙
                });
                
                // 杩炴帴浜嬩欢
                keylogSocket.on('connect', () => {
                    keylogReconnectAttempts = 0;
                    appendKeylogEntry('[绯荤粺] 閿洏璁板綍杩炴帴宸插缓绔?, false);
                    keylogSocket.emit('subscribe', { client_id: '{{ client_id }}' });
                    
                    // 娓呴櫎杞闂撮殧
                    if (keylogPollingInterval) {
                        clearInterval(keylogPollingInterval);
                        keylogPollingInterval = null;
                    }
                });
                
                // 杩炴帴閿欒澶勭悊
                keylogSocket.on('connect_error', (error) => {
                    console.error('閿洏璁板綍杩炴帴閿欒:', error);
                    appendKeylogEntry(`[绯荤粺] 閿洏璁板綍杩炴帴閿欒: ${error.message}`, false);
                });
                
                // 鏂紑杩炴帴澶勭悊
                keylogSocket.on('disconnect', (reason) => {
                    appendKeylogEntry(`[绯荤粺] 閿洏璁板綍杩炴帴宸叉柇寮€ (${reason})`, false);
                });
                
                // 閲嶈繛灏濊瘯
                keylogSocket.on('reconnect_attempt', (attemptNumber) => {
                    appendKeylogEntry(`[绯荤粺] 灏濊瘯閲嶆柊杩炴帴 (${attemptNumber}/5)...`, false);
                });
                
                // 閲嶈繛澶辫触
                keylogSocket.on('reconnect_failed', () => {
                    appendKeylogEntry('[绯荤粺] 閿洏璁板綍閲嶈繛澶辫触锛屽垏鎹㈠埌HTTP杞...', false);
                    switchToKeylogPolling();
                });
                
                // 鎺ユ敹閿洏璁板綍浜嬩欢
                keylogSocket.on('keylog_event', (data) => {
                    if (data.client_id === '{{ client_id }}' && document.getElementById('keylogRealtimeToggle').checked) {
                        appendKeylogEntry(data.key_data, true);
                    }
                });
                
            } catch (e) {
                console.error('鍒涘缓閿洏璁板綍杩炴帴澶辫触:', e);
                appendKeylogEntry(`[绯荤粺] 鍒涘缓閿洏璁板綍杩炴帴澶辫触: ${e.message}锛屽皢浣跨敤HTTP杞`, false);
                switchToKeylogPolling();
            }
        }
        
        // 鍒囨崲鍒伴敭鐩樿褰旽TTP杞
        function switchToKeylogPolling() {
            if (keylogPollingInterval) {
                clearInterval(keylogPollingInterval);
            }
            
            if (document.getElementById('keylogRealtimeToggle').checked) {
                // 鍔犺浇鏈€鏂拌褰?                loadKeylogHistory();
                
                // 璁剧疆瀹氭湡杞锛屽苟鎻愪緵杞鐘舵€佹寚绀?                const pollingIndicator = document.createElement('span');
                pollingIndicator.id = 'keylogPollingIndicator';
                pollingIndicator.className = 'badge bg-primary ms-2';
                pollingIndicator.innerHTML = '鑷姩杞涓?;
                
                const realtimeToggleLabel = document.querySelector('label[for="keylogRealtimeToggle"]');
                if (realtimeToggleLabel && !document.getElementById('keylogPollingIndicator')) {
                    realtimeToggleLabel.appendChild(pollingIndicator);
                }
                
                // 姣?绉掕疆璇竴娆★紝鎻愰珮鐏垫晱搴?                keylogPollingInterval = setInterval(() => {
                    if (document.getElementById('keylogRealtimeToggle').checked) {
                        // 姣忔杞鏃舵洿鏂版寚绀哄櫒
                        const indicator = document.getElementById('keylogPollingIndicator');
                        if (indicator) {
                            indicator.innerHTML = '姝ｅ湪杞...';
                            indicator.className = 'badge bg-warning ms-2';
                            
                            // 鎭㈠鐘舵€?                            setTimeout(() => {
                                if (indicator) {
                                    indicator.innerHTML = '鑷姩杞涓?;
                                    indicator.className = 'badge bg-primary ms-2';
                                }
                            }, 500);
                        }
                        
                        loadKeylogHistory(true);  // 闈欓粯鍔犺浇
                    }
                }, 1000);
            } else {
                // 绉婚櫎杞鎸囩ず鍣?                const indicator = document.getElementById('keylogPollingIndicator');
                if (indicator) {
                    indicator.remove();
                }
            }
        }
        
        // 鍔犺浇閿洏璁板綍鍘嗗彶
        function loadKeylogHistory(silent = false) {
            // 鏄剧ず鍒锋柊鎸囩ず鍣?            if (!silent) {
                const refreshBtn = document.querySelectorAll('[onclick="loadKeylogHistory()"]');
                refreshBtn.forEach(btn => {
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 鍒锋柊涓?;
                    btn.disabled = true;
                    
                    // 1绉掑悗鎭㈠鎸夐挳鐘舵€?鏃犺鎴愬姛涓庡惁)
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }, 1000);
                });
            }

            fetch(`/api/keylog_history/{{ client_id }}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP閿欒 ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.keylog && data.keylog.length > 0) {
                        if (!silent) {
                            clearKeylogDisplay();
                            data.keylog.forEach(log => {
                                appendKeylogEntry(log, false);
                            });
                            scrollKeylogToBottom();
                        } else {
                            // 鍙坊鍔犳柊璁板綍
                            const keylogContainer = document.getElementById('keylogContainer');
                            const currentLogs = new Set(Array.from(keylogContainer.children).map(el => el.textContent));
                            
                            let newLogsAdded = false;
                            data.keylog.forEach(log => {
                                if (!currentLogs.has(log)) {
                                    appendKeylogEntry(log, true);
                                    newLogsAdded = true;
                                }
                            });
                            
                            if (newLogsAdded) {
                                scrollKeylogToBottom();
                            }
                        }
                    } else if (!silent && document.getElementById('keylogContainer').children.length === 0) {
                        appendKeylogEntry("鏆傛棤閿洏璁板綍", false);
                    }
                })
                .catch(error => {
                    console.error("鍔犺浇閿洏璁板綍鍘嗗彶澶辫触:", error);
                    if (!silent) {
                        appendKeylogEntry(`[閿欒] 鍔犺浇閿洏璁板綍鍘嗗彶澶辫触: ${error.message}锛屽皢鍦ㄤ笅娆¤疆璇㈤噸璇昤, false);
                    }
                });
        }
        
        // 娣诲姞閿洏璁板綍鏉＄洰
        function appendKeylogEntry(keyEntry, highlight) {
            const keylogContainer = document.getElementById('keylogContainer');
            if (!keylogContainer) return;
            
            const entry = document.createElement('div');
            entry.className = 'keylog-entry';
            entry.style.margin = '5px 0';
            entry.style.padding = '5px';
            entry.style.borderBottom = '1px solid #eee';
            entry.style.fontFamily = 'monospace';
            
            if (highlight) {
                entry.style.backgroundColor = '#e3f2fd';
                entry.style.animation = 'flash 1s linear';
            }
            
            entry.textContent = keyEntry;
            keylogContainer.appendChild(entry);
            
            // 鑷姩婊氬姩
            scrollKeylogToBottom();
            
            // 闄愬埗璁板綍鏉℃暟
            const maxEntries = 500;
            while (keylogContainer.children.length > maxEntries) {
                keylogContainer.removeChild(keylogContainer.firstChild);
            }
        }
        
        // 婊氬姩閿洏璁板綍鍒板簳閮?        function scrollKeylogToBottom() {
            const keylogContainer = document.getElementById('keylogContainer');
            if (keylogContainer) {
                keylogContainer.scrollTop = keylogContainer.scrollHeight;
            }
        }
        
        // 娓呯┖閿洏璁板綍鏄剧ず
        function clearKeylogDisplay() {
            const keylogContainer = document.getElementById('keylogContainer');
            if (keylogContainer) {
                keylogContainer.innerHTML = '';
            }
        }

        // 鎵归噺鍒犻櫎鍔熻兘鍒濆鍖?        function initBatchDeleteFeatures() {
            // 鎴浘鎵归噺鍒犻櫎
            const screenshotsBatchModeBtn = document.getElementById('screenshots-batch-mode-btn');
            const screenshotsBatchDeleteBtn = document.getElementById('screenshots-batch-delete-btn');
            
            if (screenshotsBatchModeBtn) {
                screenshotsBatchModeBtn.addEventListener('click', function() {
                    const checkboxes = document.querySelectorAll('.screenshot-checkbox');
                    if (checkboxes.length === 0) return;
                    
                    // 鍒囨崲鏄剧ず鐘舵€?                    const isVisible = checkboxes[0].style.display !== 'none';
                    
                    checkboxes.forEach(function(checkbox) {
                        checkbox.style.display = isVisible ? 'none' : 'block';
                    });
                    
                    // 鏇存柊鎸夐挳鐘舵€?                    screenshotsBatchDeleteBtn.style.display = isVisible ? 'none' : 'inline-block';
                    screenshotsBatchModeBtn.innerHTML = isVisible ? 
                        '<i class="bi bi-check-square"></i> 鎵归噺閫夋嫨' : 
                        '<i class="bi bi-x-square"></i> 鍙栨秷閫夋嫨';
                    
                    // 纭繚鍙栨秷鏃舵竻绌洪€夋嫨
                    if (isVisible) {
                        document.querySelectorAll('.screenshot-checkbox-input').forEach(function(input) {
                            input.checked = false;
                        });
                        updateScreenshotSelectedCount();
                    } else {
                        // 杩涘叆鎵归噺妯″紡鏃舵樉绀烘彁绀?                        const container = document.querySelector('.screenshots-container');
                        const notice = document.createElement('div');
                        notice.id = 'batch-mode-notice';
                        notice.className = 'alert alert-info mb-3';
                        notice.innerHTML = '<i class="bi bi-info-circle"></i> 鎵归噺閫夋嫨妯″紡宸插惎鐢紝璇峰嬀閫夎鍒犻櫎鐨勬埅鍥俱€?;
                        
                        // 濡傛灉鎻愮ず涓嶅瓨鍦ㄦ墠娣诲姞
                        if (!document.getElementById('batch-mode-notice')) {
                            container.insertBefore(notice, container.firstChild);
                            
                            // 3绉掑悗鑷姩闅愯棌鎻愮ず
                            setTimeout(function() {
                                if (notice.parentNode) {
                                    notice.parentNode.removeChild(notice);
                                }
                            }, 3000);
                        }
                    }
                });
            }
            
            // 瑙嗛鎵归噺鍒犻櫎
            const videosBatchModeBtn = document.getElementById('videos-batch-mode-btn');
            const videosBatchDeleteBtn = document.getElementById('videos-batch-delete-btn');
            
            if (videosBatchModeBtn) {
                videosBatchModeBtn.addEventListener('click', function() {
                    const checkboxes = document.querySelectorAll('.video-checkbox');
                    if (checkboxes.length === 0) return;
                    
                    // 鍒囨崲鏄剧ず鐘舵€?                    const isVisible = checkboxes[0].style.display !== 'none';
                    
                    checkboxes.forEach(function(checkbox) {
                        checkbox.style.display = isVisible ? 'none' : 'block';
                    });
                    
                    // 鏇存柊鎸夐挳鐘舵€?                    videosBatchDeleteBtn.style.display = isVisible ? 'none' : 'inline-block';
                    videosBatchModeBtn.innerHTML = isVisible ? 
                        '<i class="bi bi-check-square"></i> 鎵归噺閫夋嫨' : 
                        '<i class="bi bi-x-square"></i> 鍙栨秷閫夋嫨';
                    
                    // 纭繚鍙栨秷鏃舵竻绌洪€夋嫨
                    if (isVisible) {
                        document.querySelectorAll('.video-checkbox-input').forEach(function(input) {
                            input.checked = false;
                        });
                        updateVideosSelectedCount();
                    } else {
                        // 杩涘叆鎵归噺妯″紡鏃舵樉绀烘彁绀?                        const container = document.querySelector('#videos');
                        const notice = document.createElement('div');
                        notice.id = 'video-batch-mode-notice';
                        notice.className = 'alert alert-info mb-3';
                        notice.innerHTML = '<i class="bi bi-info-circle"></i> 鎵归噺閫夋嫨妯″紡宸插惎鐢紝璇峰嬀閫夎鍒犻櫎鐨勮棰戙€?;
                        
                        // 濡傛灉鎻愮ず涓嶅瓨鍦ㄦ墠娣诲姞
                        if (!document.getElementById('video-batch-mode-notice')) {
                            container.insertBefore(notice, container.querySelector('.list-group'));
                            
                            // 3绉掑悗鑷姩闅愯棌鎻愮ず
                            setTimeout(function() {
                                if (notice.parentNode) {
                                    notice.parentNode.removeChild(notice);
                                }
                            }, 3000);
                        }
                    }
                });
            }
            
            // 鐩戝惉澶嶉€夋鍙樺寲
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('screenshot-checkbox-input')) {
                    updateScreenshotSelectedCount();
                }
                if (e.target.classList.contains('video-checkbox-input')) {
                    updateVideosSelectedCount();
                }
            });
            
            // 鎴浘鎵归噺鍒犻櫎鎸夐挳鐐瑰嚮
            if (screenshotsBatchDeleteBtn) {
                screenshotsBatchDeleteBtn.addEventListener('click', function() {
                    const selected = Array.from(document.querySelectorAll('.screenshot-checkbox-input:checked'))
                        .map(input => input.value);
                    
                    if (selected.length === 0) {
                        alert('璇烽€夋嫨瑕佸垹闄ょ殑鎴浘');
                        return;
                    }
                    
                    if (confirm(`纭畾瑕佸垹闄ら€変腑鐨?${selected.length} 寮犳埅鍥惧悧锛熸鎿嶄綔涓嶅彲鎭㈠锛乣)) {
                        batchDeleteFiles(selected, 'screenshot');
                    }
                });
            }
            
            // 瑙嗛鎵归噺鍒犻櫎鎸夐挳鐐瑰嚮
            if (videosBatchDeleteBtn) {
                videosBatchDeleteBtn.addEventListener('click', function() {
                    const selected = Array.from(document.querySelectorAll('.video-checkbox-input:checked'))
                        .map(input => input.value);
                    
                    if (selected.length === 0) {
                        alert('璇烽€夋嫨瑕佸垹闄ょ殑褰曞睆');
                        return;
                    }
                    
                    if (confirm(`纭畾瑕佸垹闄ら€変腑鐨?${selected.length} 涓綍灞忓悧锛熸鎿嶄綔涓嶅彲鎭㈠锛乣)) {
                        batchDeleteFiles(selected, 'video');
                    }
                });
            }
            
            // 鑷姩娓呯悊閰嶇疆琛ㄥ崟鎻愪氦
            const autoCleanupForm = document.getElementById('auto-cleanup-form');
            if (autoCleanupForm) {
                autoCleanupForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
                    const config = {
                        enabled: document.getElementById('cleanup-enabled').checked,
                        days: parseInt(document.getElementById('cleanup-days').value),
                        interval: parseInt(document.getElementById('cleanup-interval').value)
                    };
                    
                    fetch('/api/auto_cleanup/config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                            showCleanupResult('cleanup-config-result', 'success', '鑷姩娓呯悊閰嶇疆宸蹭繚瀛?);
                } else {
                            showCleanupResult('cleanup-config-result', 'danger', '淇濆瓨閰嶇疆澶辫触: ' + data.message);
                }
            })
            .catch(error => {
                        showCleanupResult('cleanup-config-result', 'danger', '璇锋眰閿欒: ' + error.message);
            });
        });
            }
            
            // 鎵嬪姩娓呯悊琛ㄥ崟鎻愪氦
            const manualCleanupForm = document.getElementById('manual-cleanup-form');
            if (manualCleanupForm) {
                manualCleanupForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
                    const days = parseInt(document.getElementById('manual-cleanup-days').value);
                    if (!confirm(`纭畾瑕佹竻鐞?${days === 0 ? '鍏ㄩ儴' : days+'澶╀互鍓嶇殑'} 鏁版嵁鍚楋紵姝ゆ搷浣滀笉鍙仮澶嶏紒`)) {
                        return;
                    }
                    
                    showCleanupResult('manual-cleanup-result', 'info', '姝ｅ湪鎵ц娓呯悊锛岃绋嶅€?..');
                    
                    fetch('/api/auto_cleanup/run', {
                method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ days: days })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                            const details = data.details;
                            let resultMsg = `娓呯悊瀹屾垚锛屽叡鍒犻櫎 ${details.total_deleted} 涓枃浠讹細
                                ${details.screenshots_deleted} 寮犳埅鍥俱€?                                ${details.videos_deleted} 涓綍灞忋€?                                ${details.keylogs_deleted} 涓敭鐩樿褰曘€?                                ${details.other_deleted} 涓叾浠栨枃浠躲€俙;
                            showCleanupResult('manual-cleanup-result', 'success', resultMsg);
                } else {
                            showCleanupResult('manual-cleanup-result', 'danger', '娓呯悊鎿嶄綔澶辫触: ' + data.message);
                }
            })
            .catch(error => {
                        showCleanupResult('manual-cleanup-result', 'danger', '璇锋眰閿欒: ' + error.message);
            });
        });
            }
        }
        
        // 鏇存柊閫変腑鎴浘鏁伴噺
        function updateScreenshotSelectedCount() {
            const selectedCount = document.querySelectorAll('.screenshot-checkbox-input:checked').length;
            const countElement = document.getElementById('screenshots-selected-count');
            if (countElement) {
                countElement.textContent = selectedCount;
            }
        }
        
        // 鏇存柊閫変腑瑙嗛鏁伴噺
        function updateVideosSelectedCount() {
            const selectedCount = document.querySelectorAll('.video-checkbox-input:checked').length;
            const countElement = document.getElementById('videos-selected-count');
            if (countElement) {
                countElement.textContent = selectedCount;
            }
        }
        
        // 鎵归噺鍒犻櫎鏂囦欢
        function batchDeleteFiles(files, fileType) {
            // 鏄剧ず鍔犺浇鎸囩ず鍣?            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'text-center py-4';
            loadingDiv.innerHTML = `
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">鍒犻櫎涓?..</span>
                </div>
                <p class="mt-2">姝ｅ湪鍒犻櫎鏂囦欢锛岃绋嶅€?..</p>
            `;
            
            const container = document.querySelector(fileType === 'screenshot' ? '.screenshots-container' : '.list-group');
            container.appendChild(loadingDiv);
            
            // 鍙戦€佸垹闄よ姹?            fetch('/api/batch_delete/{{ client_id }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    files: files,
                    file_type: fileType
                })
            })
            .then(response => response.json())
            .then(data => {
                // 绉婚櫎鍔犺浇鎸囩ず鍣?                container.removeChild(loadingDiv);
                
                if (data.status === 'success') {
                    alert(data.message);
                    // 閲嶆柊鍔犺浇椤甸潰鏄剧ず鏇存柊鍚庣殑鏂囦欢鍒楄〃
                    location.reload();
                } else {
                    alert('鎿嶄綔澶辫触: ' + data.message);
            }
            })
            .catch(error => {
                // 绉婚櫎鍔犺浇鎸囩ず鍣?                container.removeChild(loadingDiv);
                alert('璇锋眰閿欒: ' + error.message);
            });
        }
        
        // 鍔犺浇鑷姩娓呯悊閰嶇疆
        function loadCleanupConfig() {
            fetch('/api/auto_cleanup/config')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const config = data.config;
                        const enabledCheckbox = document.getElementById('cleanup-enabled');
                        const daysInput = document.getElementById('cleanup-days');
                        const intervalInput = document.getElementById('cleanup-interval');
                        const manualDaysInput = document.getElementById('manual-cleanup-days');
                        
                        if (enabledCheckbox) enabledCheckbox.checked = config.enabled;
                        if (daysInput) daysInput.value = config.days;
                        if (intervalInput) intervalInput.value = config.interval;
                        if (manualDaysInput) manualDaysInput.value = config.days;
                    } else {
                        showCleanupResult('cleanup-config-result', 'danger', '鍔犺浇閰嶇疆澶辫触: ' + data.message);
                    }
                })
                .catch(error => {
                    showCleanupResult('cleanup-config-result', 'danger', '璇锋眰閿欒: ' + error.message);
                });
        }
        
        // 鏄剧ず娓呯悊缁撴灉
        function showCleanupResult(elementId, type, message) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            element.className = `alert alert-${type}`;
            element.textContent = message;
            element.style.display = 'block';
            
            // 5绉掑悗鑷姩闅愯棌鎴愬姛娑堟伅
            if (type === 'success') {
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
        }

        // 娣诲姞鏍峰紡
        document.addEventListener('DOMContentLoaded', function() {
            const style = document.createElement('style');
            style.textContent = `
                .screenshot-checkbox {
                    position: absolute;
                    top: 10px;
                    left: 10px;
                    z-index: 10;
                    background-color: rgba(255, 255, 255, 0.8);
                    border-radius: 4px;
                    padding: 3px;
                }
                .video-item {
                    position: relative;
                }
                .video-checkbox {
                    position: absolute;
                    top: 10px;
                    left: 10px;
                    z-index: 10;
                    background-color: rgba(255, 255, 255, 0.8);
                    border-radius: 4px;
                    padding: 3px;
                }
            `;
            document.head.appendChild(style);
        });

        // 鍏嶈矗澹版槑鐩稿叧鍔熻兘
        function checkDisclaimerStatus() {
            // 妫€鏌ユ湰鍦板瓨鍌ㄤ腑鐨勫厤璐ｅ０鏄庣姸鎬?            const disclaimerAccepted = localStorage.getItem('disclaimerAccepted');
            const doNotShowAgain = localStorage.getItem('disclaimerDoNotShow') === 'true';
            
            // 濡傛灉鏈帴鍙楁垨鏈缃?涓嶅啀鏄剧ず"锛屽垯鏄剧ず鍏嶈矗澹版槑
            if (!disclaimerAccepted || (!doNotShowAgain && disclaimerAccepted !== getCurrentDay())) {
                showDisclaimerModal();
            }
        }
        
        // 鏄剧ず鍏嶈矗澹版槑妯℃€佹
        function showDisclaimerModal() {
            const disclaimerModal = new bootstrap.Modal(document.getElementById('disclaimerModal'));
            disclaimerModal.show();
        }
        
        // 鍒濆鍖栧厤璐ｅ０鏄庡鐞嗗櫒
        function initDisclaimerHandlers() {
            // 鎺ュ彈鎸夐挳鐐瑰嚮澶勭悊
            document.getElementById('acceptDisclaimerBtn').addEventListener('click', function() {
                const doNotShowAgain = document.getElementById('doNotShowAgain').checked;
                
                // 淇濆瓨鐘舵€佸埌鏈湴瀛樺偍
                localStorage.setItem('disclaimerAccepted', getCurrentDay());
                if (doNotShowAgain) {
                    localStorage.setItem('disclaimerDoNotShow', 'true');
                }
                
                // 鍏抽棴妯℃€佹
                const disclaimerModal = bootstrap.Modal.getInstance(document.getElementById('disclaimerModal'));
                disclaimerModal.hide();
            });
            
            // 鎷掔粷鎸夐挳鐐瑰嚮澶勭悊
            document.getElementById('rejectDisclaimerBtn').addEventListener('click', function() {
                // 閲嶅畾鍚戝埌鏍归〉闈㈡垨鍏朵粬椤甸潰
                window.location.href = '/';
            });
        }
        
        // 鑾峰彇褰撳墠鏃ユ湡鐨勫瓧绗︿覆琛ㄧず锛堢敤浜庡垽鏂瘡鏃ユ彁閱掞級
        function getCurrentDay() {
            const now = new Date();
            return `${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()}`;
        }

        // 瀹炴椂褰曞睆鐘舵€佸彉閲?        let isRecording = false;
        let recordingStatusChecker = null;
        
        // 鍒囨崲瀹炴椂褰曞睆鐘舵€?        function toggleRealtimeRecording() {
            const realtimeBtn = document.getElementById('realtime-record-btn');
            
            if (isRecording) {
                // 褰撳墠姝ｅ湪褰曞睆锛岄渶瑕佸仠姝?                stopRealtimeRecording();
            } else {
                // 褰撳墠娌℃湁褰曞睆锛屽紑濮嬪綍鍒?                startRealtimeRecording();
            }
        }
        
        // 寮€濮嬪疄鏃跺綍灞?        function startRealtimeRecording() {
            const fps = document.getElementById('realtime_fps').value || 10;
            
            fetch('/api/realtime_record/{{ client_id }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ fps: parseInt(fps) })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast('瀹炴椂褰曞睆宸插紑濮?, 'success');
                    // 绔嬪嵆妫€鏌ョ姸鎬佹洿鏂癠I
                    checkRecordingStatus();
                } else {
                    showToast(data.message || '寮€濮嬪綍灞忓け璐?, 'error');
                }
            })
            .catch(error => {
                showToast('璇锋眰閿欒: ' + error.message, 'error');
            });
        }
        
        // 妫€鏌ュ綍灞忕姸鎬?        function checkRecordingStatus() {
            fetch('/api/recording_status/{{ client_id }}')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    updateRecordingUI(data.recording, data.recording_status);
                } else {
                    console.error('鑾峰彇褰曞睆鐘舵€佸け璐?', data.message);
                }
            })
            .catch(error => {
                console.error('妫€鏌ュ綍灞忕姸鎬佸嚭閿?', error);
            });
        }
        
        // 鏇存柊褰曞睆UI
        function updateRecordingUI(isRecordingNow, statusData) {
            isRecording = isRecordingNow;
            const realtimeBtn = document.getElementById('realtime-record-btn');
            const statusInfo = document.getElementById('recording-status-info');
            
            // 鏇存柊鎸夐挳鐘舵€佸拰鏂囨湰
            if (isRecordingNow) {
                realtimeBtn.classList.remove('btn-primary');
                realtimeBtn.classList.add('btn-danger');
                realtimeBtn.innerHTML = '<i class="bi bi-stop-circle"></i> 鍋滄瀹炴椂褰曞睆';
                
                // 鏇存柊鐘舵€佷俊鎭?                let recordingType = statusData.type || '鏈煡';
                let startTimeStr = '鏈煡鏃堕棿';
                
                if (statusData.start_time) {
                    try {
                        const startTime = new Date(statusData.start_time);
                        startTimeStr = startTime.toLocaleString();
                    } catch (e) {
                        console.error('瑙ｆ瀽寮€濮嬫椂闂村嚭閿?', e);
                    }
                }
                
                // 澶勭悊褰曞睆鏃堕暱淇℃伅
                let durationInfo = '';
                if (statusData.recording_duration !== undefined) {
                    // 瀹炴椂褰曞睆妯″紡鐗规畩澶勭悊
                    if (recordingType === 'realtime') {
                        // 浼樺厛浣跨敤鏍煎紡鍖栫殑鏃堕棿
                        if (statusData.recording_duration_formatted) {
                            durationInfo = `锛屽凡褰曞埗 ${statusData.recording_duration_formatted}`;
                            if (statusData.recording_total_duration_formatted === "鏃犻檺鍒?) {
                                durationInfo += " <span class='badge bg-info'>鏃犻檺鍒?/span>";
                            }
                        } else {
                            durationInfo = `锛屽凡褰曞埗 ${statusData.recording_duration}绉抈;
                        }
                    }
                    // 瀹氭椂褰曞睆妯″紡
                    else if (recordingType === 'timed' && statusData.total_duration !== undefined) {
                        // 鏄剧ず宸插綍鍒舵椂闀?鎬绘椂闀?                        if (statusData.recording_duration_formatted && statusData.recording_total_duration_formatted) {
                            durationInfo = `锛屽凡褰曞埗 ${statusData.recording_duration_formatted} / 鍏?${statusData.recording_total_duration_formatted}`;
                        } else {
                            durationInfo = `锛屽凡褰曞埗 ${statusData.recording_duration}绉?/ 鍏?${statusData.total_duration}绉抈;
                        }
                    }
                    // 鍏朵粬妯″紡锛堝悜鍚庡吋瀹癸級
                    else {
                        // 瀹炴椂妯″紡鎴栧叾浠栨ā寮忓彧鏄剧ず宸插綍鍒舵椂闀?                        if (statusData.recording_duration_formatted) {
                            durationInfo = `锛屽凡褰曞埗 ${statusData.recording_duration_formatted}`;
                        } else {
                            durationInfo = `锛屽凡褰曞埗 ${statusData.recording_duration}绉抈;
                        }
                    }
                } else if (statusData.current_duration !== undefined) {
                    // 鍏煎鏃х増鏈殑鏁版嵁鏍煎紡
                    if (recordingType === 'realtime') {
                        durationInfo = `锛屽凡褰曞埗 ${statusData.current_duration}绉抈;
                    } else if (recordingType === 'timed' && statusData.total_duration !== undefined) {
                        durationInfo = `锛屽凡褰曞埗 ${statusData.current_duration}绉?/ 鍏?${statusData.total_duration}绉抈;
                    } else {
                        durationInfo = `锛屽凡褰曞埗 ${statusData.current_duration}绉抈;
                    }
                }
                
                statusInfo.className = 'alert alert-danger';
                statusInfo.innerHTML = `<i class="bi bi-record-circle"></i> <strong>褰曞睆杩涜涓?/strong> - 绫诲瀷: ${recordingType}, 寮€濮嬫椂闂? ${startTimeStr}${durationInfo}锛屽凡褰曞埗 ${statusData.current_duration}绉抈;
            } else {
                realtimeBtn.classList.remove('btn-danger');
                realtimeBtn.classList.add('btn-primary');
                realtimeBtn.innerHTML = '<i class="bi bi-record-circle"></i> 寮€濮嬪疄鏃跺綍灞?;
                
                statusInfo.className = 'alert alert-info';
                statusInfo.innerHTML = '褰撳墠鏈綍灞?;
            }
        }
        
        // 鍦ㄩ〉闈㈠姞杞芥椂妫€鏌ュ綍灞忕姸鎬?        document.addEventListener('DOMContentLoaded', function() {
            // 鍒濆妫€鏌ュ綍灞忕姸鎬?            checkRecordingStatus();
            
            // 璁剧疆瀹氭椂妫€鏌?            if (recordingStatusChecker) {
                clearInterval(recordingStatusChecker);
            }
            
            recordingStatusChecker = setInterval(checkRecordingStatus, 5000);  // 姣?绉掓鏌ヤ竴娆?            
            // 褰撴爣绛鹃〉琚縺娲绘椂妫€鏌ョ姸鎬?            document.getElementById('videos-tab').addEventListener('shown.bs.tab', function() {
                checkRecordingStatus();
            });
        });
        
        // 鏄剧ず娑堟伅鎻愮ず
        function showToast(message, type = 'info') {
            // 妫€鏌ユ槸鍚﹀凡瀛樺湪toast瀹瑰櫒
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
                document.body.appendChild(toastContainer);
            }
            
            // 鍒涘缓鍞竴ID
            const toastId = 'toast-' + Date.now();
            
            // 璁剧疆toast绫诲瀷瀵瑰簲鐨勯鑹?            let bgClass = 'bg-info';
            if (type === 'success') bgClass = 'bg-success';
            if (type === 'error') bgClass = 'bg-danger';
            if (type === 'warning') bgClass = 'bg-warning';
            
            // 鍒涘缓toast鍏冪礌
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center ${bgClass} text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            // 娣诲姞鍒板鍣?            toastContainer.innerHTML += toastHtml;
            
            // 鍒濆鍖杢oast骞舵樉绀?            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
            toast.show();
            
            // 鑷姩鍒犻櫎宸叉秷澶辩殑toast
            toastElement.addEventListener('hidden.bs.toast', function () {
                toastElement.remove();
            });
        }

        // 绔嬪嵆鎵ц锛屼笉绛夊緟DOMContentLoaded
        (function() {
            setTimeout(function() {
                try {
                    // 鎵嬪姩瀹炵幇鏍囩椤靛垏鎹㈠姛鑳?                    var tabs = document.querySelectorAll('#clientTabs .nav-link');
                    var tabContents = document.querySelectorAll('.tab-content .tab-pane');
                    
                    // 闅愯棌鎵€鏈夋爣绛惧唴瀹?                    tabContents.forEach(function(content) {
                        content.style.display = 'none';
                        content.classList.remove('active', 'show');
                    });
                    
                    // 鍙栨秷鎵€鏈夋爣绛炬寜閽殑婵€娲荤姸鎬?                    tabs.forEach(function(tab) {
                        tab.classList.remove('active');
                        tab.setAttribute('aria-selected', 'false');
                    });
                    
                    // 婵€娲荤涓€涓爣绛?                    var firstTab = document.getElementById('screenshots-tab');
                    var firstContent = document.getElementById('screenshots');
                    if(firstTab && firstContent) {
                        firstTab.classList.add('active');
                        firstTab.setAttribute('aria-selected', 'true');
                        firstContent.classList.add('active', 'show');
                        firstContent.style.display = 'block';
                    }
                    
                    // 涓烘瘡涓爣绛鹃〉娣诲姞鐐瑰嚮浜嬩欢
                    tabs.forEach(function(tab) {
                        tab.addEventListener('click', function(e) {
                            e.preventDefault();
                            
                            // 鑾峰彇鐩爣鍐呭ID
                            var targetId = this.getAttribute('data-bs-target').substring(1);
                            
                            // 闅愯棌鎵€鏈夊唴瀹?                            tabContents.forEach(function(content) {
                                content.style.display = 'none';
                                content.classList.remove('active', 'show');
                            });
                            
                            // 鍙栨秷鎵€鏈夋爣绛炬縺娲荤姸鎬?                            tabs.forEach(function(t) {
                                t.classList.remove('active');
                                t.setAttribute('aria-selected', 'false');
                            });
                            
                            // 婵€娲诲綋鍓嶆爣绛惧拰鍐呭
                            this.classList.add('active');
                            this.setAttribute('aria-selected', 'true');
                            
                            var content = document.getElementById(targetId);
                            if(content) {
                                content.classList.add('active', 'show');
                                content.style.display = 'block';
                                
                                // 瑙﹀彂鐗瑰畾鍔熻兘
                                if(this.id === 'config-tab') {
                                    loadClientConfig();
                                } else if(this.id === 'sysinfo-tab') {
                                    getSystemInfo();
                                } else if(this.id === 'files-tab') {
                                    browseRootDirectories();
                                }
                            }
                        });
                    });
                    
                    console.log('Manual tab initialization completed');

                    // 娣诲姞鐩戝惉瀹炴椂鏇存柊鍒囨崲浠ｇ爜
                    const realtimeToggle = document.getElementById('realtimeToggle');
                    if (realtimeToggle) {
                        realtimeToggle.addEventListener('change', function() {
                            if (this.checked) {
                                switchToLogPolling();
                            } else {
                                if (logPollingInterval) {
                                    clearInterval(logPollingInterval);
                                    // 绉婚櫎杞鎸囩ず鍣?                                    const indicator = document.getElementById('pollingIndicator');
                                    if (indicator) {
                                        indicator.remove();
                                    }
                                }
                            }
                        });
                    }
                    
                    const keylogRealtimeToggle = document.getElementById('keylogRealtimeToggle');
                    if (keylogRealtimeToggle) {
                        keylogRealtimeToggle.addEventListener('change', function() {
                            if (this.checked) {
                                switchToKeylogPolling();
                            } else {
                                if (keylogPollingInterval) {
                                    clearInterval(keylogPollingInterval);
                                    // 绉婚櫎杞鎸囩ず鍣?                                    const indicator = document.getElementById('keylogPollingIndicator');
                                    if (indicator) {
                                        indicator.remove();
                                    }
                                }
                            }
                        });
                    }
                } catch (e) {
                    console.error('Tab initialization error:', e);
                }
            }, 100); // 鍑忓皯寤惰繜鍒?00ms
        })();

        // 鏄剧ず涓嬭浇鏂囦欢寮圭獥
        function showDownloadedFilesModal() {
            // 鍒涘缓Modal瀵硅薄
            const modal = new bootstrap.Modal(document.getElementById('downloadedFilesModal'));
            // 鏄剧ずModal
            modal.show();
            // 鍔犺浇鏂囦欢鍒楄〃
            loadDownloadedFiles();
            // 鍔犺浇鏈夋晥鏈熻缃?            loadExpirySettings();
        }
        
        // 鍔犺浇涓嬭浇鐨勬枃浠跺垪琛?        function loadDownloadedFiles() {
            const loadingIndicator = document.getElementById('filesLoadingIndicator');
            const errorMsg = document.getElementById('filesErrorMsg');
            const filesList = document.getElementById('filesList');
            const noFilesMsg = document.getElementById('noFilesMsg');
            const filesTableBody = document.getElementById('downloadedFilesTableBody');
            
            // 鏄剧ず鍔犺浇鎸囩ず鍣?            loadingIndicator.classList.remove('d-none');
            errorMsg.classList.add('d-none');
            filesList.classList.add('d-none');
            noFilesMsg.classList.add('d-none');
            
            // 鍚屾椂鑾峰彇鏂囦欢鍒楄〃鍜屾湁鏁堟湡璁剧疆
            Promise.all([
                fetch('/api/download_folder_files/{{ client_id }}').then(r => r.json()),
                fetch('/api/download_expiry/{{ client_id }}').then(r => r.json())
            ])
            .then(([fileData, expiryData]) => {
                    // 闅愯棌鍔犺浇鎸囩ず鍣?                    loadingIndicator.classList.add('d-none');
                    
                // 澶勭悊閿欒
                if (fileData.status === 'error') {
                    errorMsg.textContent = fileData.message || '鑾峰彇鏂囦欢鍒楄〃澶辫触';
                        errorMsg.classList.remove('d-none');
                    return;
                }
                
                // 鑾峰彇鏈夋晥鏈熻缃?                const expiryValue = expiryData.status === 'success' ? expiryData.expiry_value : 5;
                const expiryUnit = expiryData.status === 'success' ? expiryData.expiry_unit : 'minutes';
                const currentDate = new Date();
                
                // 鏄剧ず鏂囦欢
                if (fileData.files && fileData.files.length > 0) {
                        // 鏄剧ず鏂囦欢鍒楄〃
                        filesTableBody.innerHTML = '';
                        
                    fileData.files.forEach(file => {
                            const row = document.createElement('tr');
                            
                        // 鏂囦欢鍚?                            const nameCell = document.createElement('td');
                            nameCell.innerHTML = `<i class="bi bi-file-earmark me-2"></i>${file.name}`;
                            row.appendChild(nameCell);
                            
                        // 鏂囦欢澶у皬
                            const sizeCell = document.createElement('td');
                            sizeCell.textContent = formatBytes(file.size);
                            row.appendChild(sizeCell);
                            
                        // 淇敼鏃堕棿
                            const timeCell = document.createElement('td');
                            timeCell.textContent = formatDateTime(file.modified);
                            row.appendChild(timeCell);
                            
                        // 鍓╀綑鏈夋晥鏈?                        const expiryCell = document.createElement('td');
                        if (expiryValue === 0) {
                            expiryCell.innerHTML = '<span class="badge bg-success">姘镐笉杩囨湡</span>';
                        } else {
                            // 鏍规嵁鍗曚綅璁＄畻鍓╀綑鏃堕棿
                            const modifiedDate = new Date(file.modified);
                            let expiryDate = new Date(modifiedDate);
                            const unitMilliseconds = {
                                'minutes': 60 * 1000,
                                'hours': 60 * 60 * 1000,
                                'days': 24 * 60 * 60 * 1000
                            }[expiryUnit];
                            
                            expiryDate.setTime(expiryDate.getTime() + (expiryValue * unitMilliseconds));
                            
                            // 璁＄畻鍓╀綑鏃堕棿锛堟绉掞級
                            const timeLeft = expiryDate - currentDate;
                            
                            if (timeLeft <= 0) {
                                expiryCell.innerHTML = '<span class="badge bg-danger">宸茶繃鏈?/span>';
                            } else {
                                // 鏍规嵁涓嶅悓鍗曚綅鏄剧ず鍓╀綑鏃堕棿
                                let timeLeftText = '';
                                if (expiryUnit === 'minutes') {
                                    const minutesLeft = Math.ceil(timeLeft / (60 * 1000));
                                    timeLeftText = `${minutesLeft}鍒嗛挓`;
                                } else if (expiryUnit === 'hours') {
                                    const hoursLeft = Math.ceil(timeLeft / (60 * 60 * 1000));
                                    timeLeftText = `${hoursLeft}灏忔椂`;
                                } else {
                                    const daysLeft = Math.ceil(timeLeft / (24 * 60 * 60 * 1000));
                                    timeLeftText = `${daysLeft}澶ー;
                                }
                                
                                // 鏍规嵁鍓╀綑鏃堕棿鏄剧ず涓嶅悓棰滆壊
                                const warningThreshold = unitMilliseconds * 0.2; // 鍓╀綑20%鏃堕棿涓洪粍鑹茶鍛?                                if (timeLeft < warningThreshold) {
                                    expiryCell.innerHTML = `<span class="badge bg-warning">鍓╀綑 ${timeLeftText}</span>`;
                                } else {
                                    expiryCell.innerHTML = `<span class="badge bg-info">鍓╀綑 ${timeLeftText}</span>`;
                                }
                            }
                        }
                        row.appendChild(expiryCell);
                        
                        // 鎿嶄綔鎸夐挳
                            const actionCell = document.createElement('td');
                        actionCell.innerHTML = `
                            <a href="${file.download_url}" class="btn btn-sm btn-outline-primary" target="_blank" download="${file.name}">
                                <i class="bi bi-download"></i> 涓嬭浇
                            </a>
                        `;
                            row.appendChild(actionCell);
                            
                            filesTableBody.appendChild(row);
                        });
                        
                        filesList.classList.remove('d-none');
                    } else {
                        // 鏄剧ず鏃犳枃浠舵秷鎭?                        noFilesMsg.classList.remove('d-none');
                    }
                })
                .catch(error => {
                    loadingIndicator.classList.add('d-none');
                    errorMsg.textContent = `鍔犺浇鏂囦欢鍒楄〃澶辫触: ${error.message}`;
                    errorMsg.classList.remove('d-none');
                });
        }

        // 鍔犺浇鏈夋晥鏈熻缃?        function loadExpirySettings() {
            fetch(`/api/download_expiry/{{ client_id }}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // 鏄剧ず褰撳墠鏈夋晥鏈?                        const expiryValueInput = document.getElementById('expiryValueInput');
                        const expiryUnitSelect = document.getElementById('expiryUnitSelect');
                        const currentExpirySetting = document.getElementById('currentExpirySetting');
                        
                        expiryValueInput.value = data.expiry_value;
                        expiryUnitSelect.value = data.expiry_unit;
                        
                        if (data.expiry_value === 0) {
                            currentExpirySetting.innerHTML = '<span class="badge bg-success">褰撳墠璁剧疆: 姘镐笉杩囨湡</span>';
                        } else {
                            const unitText = {
                                'minutes': '鍒嗛挓', 
                                'hours': '灏忔椂', 
                                'days': '澶?
                            }[data.expiry_unit] || '鍒嗛挓';
                            
                            currentExpirySetting.innerHTML = `<span class="badge bg-info">褰撳墠璁剧疆: ${data.expiry_value} ${unitText}</span>`;
                        }
                    } else {
                        console.error('鍔犺浇鏈夋晥鏈熻缃け璐?', data.message);
                    }
                })
                .catch(error => {
                    console.error('璇锋眰鏈夋晥鏈熻缃嚭閿?', error);
                });
        }

        // 淇濆瓨鏈夋晥鏈熻缃?        function saveExpirySettings() {
            const expiryValueInput = document.getElementById('expiryValueInput');
            const expiryUnitSelect = document.getElementById('expiryUnitSelect');
            const expiryValue = parseInt(expiryValueInput.value) || 0;
            const expiryUnit = expiryUnitSelect.value;
            const resultDiv = document.getElementById('expirySettingResult');
            
            // 鏄剧ず鍔犺浇鐘舵€?            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div> 姝ｅ湪淇濆瓨...';
            resultDiv.className = 'mt-2 alert alert-info';
            resultDiv.classList.remove('d-none');
            
            // 鍙戦€佽姹?            fetch(`/api/download_expiry/{{ client_id }}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    expiry_value: expiryValue,
                    expiry_unit: expiryUnit 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // 鏇存柊鏄剧ず
                    resultDiv.innerHTML = `<i class="bi bi-check-circle"></i> ${data.message}`;
                    resultDiv.className = 'mt-2 alert alert-success';
                    
                    // 鏇存柊褰撳墠璁剧疆鏄剧ず
                    const currentExpirySetting = document.getElementById('currentExpirySetting');
                    if (expiryValue === 0) {
                        currentExpirySetting.innerHTML = '<span class="badge bg-success">褰撳墠璁剧疆: 姘镐笉杩囨湡</span>';
                    } else {
                        const unitText = {
                            'minutes': '鍒嗛挓', 
                            'hours': '灏忔椂', 
                            'days': '澶?
                        }[expiryUnit] || '鍒嗛挓';
                        
                        currentExpirySetting.innerHTML = `<span class="badge bg-info">褰撳墠璁剧疆: ${expiryValue} ${unitText}</span>`;
                    }
                    
                    // 閲嶆柊鍔犺浇鏂囦欢鍒楄〃
                    loadDownloadedFiles();
                    
                    // 3绉掑悗闅愯棌缁撴灉
                    setTimeout(() => {
                        resultDiv.classList.add('d-none');
                    }, 3000);
                } else {
                    resultDiv.innerHTML = `<i class="bi bi-x-circle"></i> 淇濆瓨澶辫触: ${data.message}`;
                    resultDiv.className = 'mt-2 alert alert-danger';
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `<i class="bi bi-x-circle"></i> 璇锋眰閿欒: ${error.message}`;
                resultDiv.className = 'mt-2 alert alert-danger';
            });
        }

        // 鍒濆鍖栨湁鏁堟湡璁剧疆鎸夐挳
        document.addEventListener('DOMContentLoaded', function() {
            const saveExpiryBtn = document.getElementById('saveExpiryBtn');
            if (saveExpiryBtn) {
                saveExpiryBtn.addEventListener('click', saveExpirySettings);
            }
        });

        // 鎴睆鏆傚仠/鎭㈠鎺у埗 - 淇敼涓虹偣鍑讳繚瀛樻寜閽椂鎵嶅彂閫佽姹?        $('#saveScreenshotSettingBtn').click(function() {
            const isEnabled = $('#pauseScreenshotSwitch').prop('checked');
            const isPaused = !isEnabled; // 寮€鍏虫墦寮€琛ㄧず鍚敤锛屽弽涔嬩负鏆傚仠
            
            // 鏄剧ず鐘舵€佹洿鏂?            $('#screenshotStatus').text(isEnabled ? '姝ｅ湪淇濆瓨...' : '姝ｅ湪淇濆瓨...');
            
            $.ajax({
                url: '/api/pause_screenshot/{{ client_id }}',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ 
                    paused: isPaused,
                    save_persistent: true // 娣诲姞鏍囪琛ㄧず闇€瑕佹寔涔呭寲淇濆瓨
                }),
                success: function(response) {
                    // 鏇存柊鐘舵€佹枃鏈?                    $('#screenshotStatus').text(isPaused ? '宸茬鐢? : '宸插惎鐢?);
                    
                    // 鏄剧ず淇濆瓨鎴愬姛淇℃伅
                    $('#screenshotSettingSaved').show();
                    setTimeout(() => {
                        $('#screenshotSettingSaved').fadeOut();
                    }, 3000);
                    
                    showAlert('灞忓箷鎴浘璁剧疆宸? + (isEnabled ? '鍚敤' : '绂佺敤') + '骞朵繚瀛?, 'success');
                },
                error: function(xhr) {
                    showAlert('淇濆瓨璁剧疆澶辫触: ' + (xhr.responseJSON?.message || '鏈煡閿欒'), 'danger');
                    // 鎭㈠鏄剧ず涓哄師濮嬬姸鎬?                    $('#screenshotStatus').text(isPaused ? '宸插惎鐢? : '宸茬鐢?);
                }
            });
        });

        // 瀹炴椂閿洏璁板綍鎺у埗鍜屽巻鍙查敭鐩樿褰曟帶鍒?- 淇敼涓虹偣鍑讳繚瀛樻寜閽椂涓€璧峰彂閫佽姹?        $('#saveKeylogSettingBtn').click(function() {
            const enableRealtime = $('#realtimeKeylogSwitch').prop('checked');
            const enableHistorical = $('#historicalKeylogSwitch').prop('checked');
            
            $.ajax({
                url: '/api/keylog_settings/{{ client_id }}',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ 
                    enable_realtime_keylog: enableRealtime,
                    enable_historical_keylog: enableHistorical,
                    save_persistent: true // 娣诲姞鏍囪琛ㄧず闇€瑕佹寔涔呭寲淇濆瓨
                }),
                success: function(response) {
                    // 鏄剧ず淇濆瓨鎴愬姛淇℃伅
                    $('#keylogSettingSaved').show();
                    setTimeout(() => {
                        $('#keylogSettingSaved').fadeOut();
                    }, 3000);
                    
                    showAlert('閿洏璁板綍璁剧疆宸蹭繚瀛?, 'success');
                },
                error: function(xhr) {
                    showAlert('淇濆瓨璁剧疆澶辫触: ' + (xhr.responseJSON?.message || '鏈煡閿欒'), 'danger');
                }
            });
        });

        // 鏄剧ず鎻愮ず娑堟伅
        function showAlert(message, type) {
            const alertContainer = document.createElement('div');
            alertContainer.id = 'alertContainer';
            alertContainer.style.position = 'fixed';
            alertContainer.style.top = '20px';
            alertContainer.style.right = '20px';
            alertContainer.style.zIndex = '9999';
            document.body.appendChild(alertContainer);
            
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            $('#alertContainer').html(alertHtml);
            // 鑷姩鍏抽棴
            setTimeout(() => {
                $('.alert').alert('close');
                if (document.getElementById('alertContainer')) {
                    document.getElementById('alertContainer').remove();
                }
            }, 3000);
        }
        
        // 鍒犻櫎瀹㈡埛绔?        function deleteClient() {
            // 鏄剧ず纭瀵硅瘽妗?            if (!confirm("纭畾瑕佸垹闄ゆ瀹㈡埛绔悧锛熸鎿嶄綔灏嗗垹闄ゆ墍鏈夌浉鍏虫暟鎹笖涓嶅彲鎭㈠锛?)) {
                return;
            }
            
            // 鍐嶆纭
            if (!confirm("璀﹀憡锛氬垹闄ゆ搷浣滀笉鍙挙閿€锛佹墍鏈夋埅鍥俱€佸綍灞忋€侀敭鐩樿褰曠瓑鏁版嵁灏嗘案涔呬涪澶便€傜‘瀹氱户缁悧锛?)) {
                return;
            }
            
            // 鍙戦€佸垹闄よ姹?            fetch(`/api/client/delete/{{ client_id }}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('瀹㈡埛绔凡鎴愬姛鍒犻櫎锛屽嵆灏嗚繑鍥為椤?..', 'success');
                    // 3绉掑悗璺宠浆鍒伴椤?                    setTimeout(() => {
                        window.location.href = '/';
                    }, 3000);
                } else {
                    showAlert(`鍒犻櫎澶辫触: ${data.message}`, 'danger');
                }
            })
            .catch(error => {
                showAlert(`鍒犻櫎璇锋眰閿欒: ${error.message}`, 'danger');
            });
        }
        
        // 鎭㈠瀹㈡埛绔師濮嬭缃?        function resetClientSettings() {
            // 鏄剧ず纭瀵硅瘽妗?            if (!confirm("纭畾瑕佸皢姝ゅ鎴风鎭㈠鍒板師濮嬭缃悧锛熻繖灏嗛噸缃墍鏈夐厤缃紙鏈嶅姟鍣↖P鍦板潃闄ゅ锛夈€?)) {
                return;
            }
            
            // 鍙戦€侀噸缃姹?            fetch(`/api/client/reset/{{ client_id }}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('瀹㈡埛绔缃凡鎴愬姛閲嶇疆锛屽鎴风灏嗗湪涓嬫杩炴帴鏃跺簲鐢ㄦ柊璁剧疆', 'success');
                } else {
                    showAlert(`閲嶇疆澶辫触: ${data.message}`, 'danger');
                }
            })
            .catch(error => {
                showAlert(`閲嶇疆璇锋眰閿欒: ${error.message}`, 'danger');
            });
        }

        // 娣诲姞楠岃瘉鐩稿叧JavaScript鍑芥暟
        // 鍒犻櫎涓嬮潰杩欒
        // let verificationInterval = null;

        // 鍒犻櫎涓嬮潰杩欎釜鍑芥暟锛岀敱jQuery鐗堟湰鐨勫嚱鏁版浛浠?        // function checkVerificationStatus() {
        //    const clientId = '{{ client_id }}';
        //    fetch(`/api/verification/status/${clientId}`, {
        //        method: 'GET',
        //        headers: {
        //            'Content-Type': 'application/json'
        //        }
        //    })
        //    .then(response => response.json())
        //    .then(data => {
        //        if (data.status === 'success') {
        //            const status = data.verification_status;
        //            
        //            // 鏇存柊楠岃瘉鐘舵€?        //            if (status.is_verification_needed) {
        //                // 鏄剧ず楠岃瘉妯箙
        //                document.getElementById('verification-banner').style.display = 'flex';
        //                
        //                // 璁剧疆灏濊瘯娆℃暟
        //                document.getElementById('attempts-count').innerText = status.attempts_left;
        //                
        //                // 璁剧疆鍊掕鏃?        //                startVerificationCountdown(status.remaining_time);
        //                
        //                // 鏇存柊楠岃瘉鐘舵€佹寚绀哄櫒
        //                updateVerificationStatusDisplay('闇€瑕侀獙璇?, 'warning');
        //                
        //                // 濡傛灉鍓╀綑灏濊瘯娆℃暟灏戜簬2娆★紝鏄剧ず涓虹揣鎬ユí骞?        //                if (status.attempts_left < 2) {
        //                    document.getElementById('verification-banner').classList.add('urgent');
        //                    document.getElementById('verification-banner-text').innerText = 
        //                        `璀﹀憡: 楠岃瘉灏濊瘯娆℃暟鍓╀綑${status.attempts_left}娆★紝楠岃瘉澶辫触灏嗛檺鍒跺姛鑳?`;
        //                    
        //                    // 鏇存柊楠岃瘉鐘舵€佹寚绀哄櫒涓哄嵄闄?        //                    updateVerificationStatusDisplay('楠岃瘉鍗辨€?, 'danger');
        //                }
        //            } else {
        //                // 闅愯棌楠岃瘉妯箙鍜屾ā鎬佹
        //                document.getElementById('verification-banner').style.display = 'none';
        //                closeVerificationModal();
        //                
        //                // 鍋滄鍊掕鏃?        //                if (verificationInterval) {
        //                    clearInterval(verificationInterval);
        //                    verificationInterval = null;
        //                }
        //                
        //                // 鏇存柊楠岃瘉鐘舵€佹寚绀哄櫒
        //                if (status.is_verified) {
        //                    updateVerificationStatusDisplay('宸查獙璇?, 'success');
        //                } else {
        //                    updateVerificationStatusDisplay('鏃犻渶楠岃瘉', 'secondary');
        //                }
        //            }
        //        }
        //    })
        //    .catch(error => {
        //        console.error('鑾峰彇楠岃瘉鐘舵€佸け璐?', error);
        //        updateVerificationStatusDisplay('鐘舵€佹鏌ラ敊璇?, 'danger');
        //    });
        //}

        // 鏇存柊楠岃瘉鐘舵€佹樉绀?        function updateVerificationStatusDisplay(message, statusType) {
            const statusDisplay = document.getElementById('verification-status-display');
            statusDisplay.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="status-dot bg-${statusType} me-2"></div>
                    <span>${message}</span>
                </div>
            `;
            
            // 淇敼鎸夐挳鏂囨湰锛屼絾涓嶇鐢ㄥ畠
            const triggerBtn = document.getElementById('trigger-verification-btn');
            triggerBtn.disabled = false; // 濮嬬粓鍏佽妫€鏌ョ姸鎬?            triggerBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> 妫€鏌ラ獙璇佺姸鎬?;
            
            // 濡傛灉姝ｅ湪楠岃瘉涓紝鏇存柊鎸夐挳鏍峰紡
            if (statusType === 'warning' || statusType === 'danger') {
                triggerBtn.classList.remove('btn-info');
                triggerBtn.classList.add('btn-warning');
            } else {
                triggerBtn.classList.remove('btn-warning');
                triggerBtn.classList.add('btn-info');
            }
        }

        // 鏄剧ず楠岃瘉妯℃€佹
        function showVerificationModal() {
            document.getElementById('verification-modal').style.display = 'flex';
            document.getElementById('verification-result').style.display = 'none';
            document.getElementById('verification-key').focus();
        }

        // 鍏抽棴楠岃瘉妯℃€佹
        function closeVerificationModal() {
            document.getElementById('verification-modal').style.display = 'none';
        }

        // 楠岃瘉瀵嗛挜
        function verifyKey() {
            const clientId = '{{ client_id }}';
            const key = document.getElementById('verification-key').value.trim();
            
            if (!key) {
                showVerificationResult('璇疯緭鍏ラ獙璇佸瘑閽?, 'error');
                return;
            }
            
            // 鏄剧ず鍔犺浇鐘舵€?            showVerificationResult('姝ｅ湪楠岃瘉...', '');
            
            fetch(`/api/verification/verify/${clientId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ key: key })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showVerificationResult('楠岃瘉鎴愬姛锛?, 'success');
                    
                    // 楠岃瘉鎴愬姛鍚庨噸鏂版鏌ョ姸鎬?                    setTimeout(() => {
                        checkVerificationStatus();
                        
                        // 鍒锋柊椤甸潰浠ュ弽鏄犻獙璇佸悗鐨勭姸鎬?                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    }, 1000);
                } else {
                    showVerificationResult(`楠岃瘉澶辫触: ${data.message}`, 'error');
                    
                    // 鏇存柊灏濊瘯娆℃暟
                    if (data.attempts_left !== undefined) {
                        document.getElementById('attempts-count').innerText = data.attempts_left;
                    }
                    
                    // 娓呯┖杈撳叆妗?                    document.getElementById('verification-key').value = '';
                    
                    // 閲嶆柊妫€鏌ョ姸鎬?                    setTimeout(checkVerificationStatus, 1000);
                }
            })
            .catch(error => {
                console.error('楠岃瘉璇锋眰澶辫触:', error);
                showVerificationResult('楠岃瘉璇锋眰澶辫触锛岃閲嶈瘯', 'error');
            });
        }

        // 鏄剧ず楠岃瘉缁撴灉
        function showVerificationResult(message, type) {
            const resultElement = document.getElementById('verification-result');
            resultElement.innerText = message;
            resultElement.style.display = 'block';
            
            // 娓呴櫎鎵€鏈夌被
            resultElement.className = 'verification-result';
            
            // 娣诲姞缁撴灉绫诲瀷
            if (type) {
                resultElement.classList.add(type);
            }
        }

        // 寮€濮嬮獙璇佸€掕鏃?        function startVerificationCountdown(seconds) {
            // 鍋滄鐜版湁鍊掕鏃?            if (verificationInterval) {
                clearInterval(verificationInterval);
            }
            
            // 璁剧疆鍒濆鍊掕鏃?            updateCountdownDisplay(seconds);
            
            // 鍚姩鍊掕鏃?            verificationInterval = setInterval(() => {
                seconds--;
                
                if (seconds <= 0) {
                    clearInterval(verificationInterval);
                    verificationInterval = null;
                    updateCountdownDisplay(0);
                    
                    // 鍊掕鏃剁粨鏉熷悗閲嶆柊妫€鏌ョ姸鎬?                    checkVerificationStatus();
                } else {
                    updateCountdownDisplay(seconds);
                }
            }, 1000);
        }

        // 鏇存柊鍊掕鏃舵樉绀?        function updateCountdownDisplay(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            const timeString = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            
            document.getElementById('timeout-value').innerText = timeString;
        }

        // 瑙﹀彂楠岃瘉锛堢鐞嗗憳鍔熻兘锛?        function triggerVerification() {
            const clientId = '{{ client_id }}';
            
            // 淇敼涓轰粎妫€鏌ラ獙璇佺姸鎬侊紝鑰屼笉鏄Е鍙戞柊鐨勯獙璇?            fetch(`/api/verification/status/${clientId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const status = data.verification_status;
                    let statusText = "鏈煡";
                    let statusClass = "secondary";
                    
                    if (status.is_verification_needed) {
                        statusText = "闇€瑕侀獙璇?;
                        statusClass = status.attempts_left < 2 ? "danger" : "warning";
                    } else if (status.is_verified) {
                        statusText = "宸查獙璇?;
                        statusClass = "success";
                    } else {
                        statusText = "鏃犻渶楠岃瘉";
                        statusClass = "secondary";
                    }
                    
                    // 鏇存柊楠岃瘉鐘舵€佹樉绀?                    updateVerificationStatusDisplay(statusText, statusClass);
                    
                    alert(`宸插埛鏂伴獙璇佺姸鎬? ${statusText}`);
                } else {
                    alert(`鑾峰彇楠岃瘉鐘舵€佸け璐? ${data.message || "鏈煡閿欒"}`);
                }
            })
            .catch(error => {
                console.error('妫€鏌ラ獙璇佺姸鎬佸け璐?', error);
                alert('妫€鏌ラ獙璇佺姸鎬佽姹傚け璐ワ紝璇烽噸璇?);
            });
        }

        // 鍦ㄥ鎴风鎺у埗鎸夐挳鍖烘坊鍔犺Е鍙戦獙璇佹寜閽紙鍦―OM鍔犺浇瀹屾垚鍚庯級
        document.addEventListener('DOMContentLoaded', function() {
            // 鍦ㄦ搷浣滄寜閽粍涓坊鍔犻獙璇佹寜閽?            const controlPanel = document.querySelector('.client-controls .card-body .btn-group');
            if (controlPanel) {
                const verifyBtn = document.createElement('button');
                verifyBtn.className = 'btn btn-warning';
                verifyBtn.innerHTML = '<i class="bi bi-shield-lock"></i> 瑙﹀彂楠岃瘉';
                verifyBtn.onclick = triggerVerification;
                controlPanel.appendChild(verifyBtn);
            }
            
            // 鍒濆妫€鏌ラ獙璇佺姸鎬?            checkVerificationStatus();
            
            // 姣?0绉掓鏌ヤ竴娆￠獙璇佺姸鎬?            setInterval(checkVerificationStatus, 20000);
        });

        // 鎵嬪姩瑙﹀彂楠岃瘉鐘舵€佹鏌?        function triggerVerification() {
            const button = document.getElementById('trigger-verification-btn');
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 妫€鏌ヤ腑...';
            
            // 璋冪敤楠岃瘉鐘舵€佹鏌?            checkVerificationStatus();
            
            // 2绉掑悗鎭㈠鎸夐挳鐘舵€?            setTimeout(function() {
                button.innerHTML = originalText;
                button.disabled = false;
            }, 2000);
        }
        
        // 鏇存柊楠岃瘉鐘舵€乁I
        function updateVerificationStatusUI(status) {
            const statusDisplay = document.getElementById('verification-status-display');
            const banner = document.getElementById('verification-banner');
            let statusDot, statusText;
            
            // 棣栧厛娓呯┖褰撳墠鐘舵€?            statusDisplay.innerHTML = '';
            
            if (status.is_verification_needed) {
                // 闇€瑕侀獙璇?                if (status.is_verified) {
                    // 宸查€氳繃楠岃瘉
                    statusDot = '<div class="status-dot bg-success me-2"></div>';
                    statusText = '<span>宸查€氳繃楠岃瘉</span>';
                } else {
                    // 闇€瑕侀獙璇佷絾鏈€氳繃
                    statusDot = '<div class="status-dot bg-danger me-2"></div>';
                    statusText = '<span>闇€瑕侀獙璇?/span>';
                    
                    // 鏄剧ず楠岃瘉妯箙
                    if (banner) {
                        banner.style.display = 'flex';
                        
                        // 鏇存柊鍊掕鏃朵俊鎭?                        const hours = Math.floor(status.remaining_time / 3600);
                        const minutes = Math.floor((status.remaining_time % 3600) / 60);
                        const seconds = Math.floor(status.remaining_time % 60);
                        const timeFormatted = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                        
                        document.getElementById('verification-banner-text').innerHTML = 
                            `姝ゅ鎴风闇€瑕侀獙璇併€傚墿浣欏皾璇曟鏁? ${status.attempts_left}锛岄獙璇佸€掕鏃? ${timeFormatted}`;
                        
                        // 灏濊瘯鎵撳紑楠岃瘉寮圭獥
                        if (!document.cookie.includes('verification_modal_shown')) {
                            setTimeout(function() {
                                showVerificationModal();
                                document.cookie = "verification_modal_shown=true; max-age=60"; // 1鍒嗛挓鍐呬笉鍐嶈嚜鍔ㄥ脊鍑?                            }, 1000);
                        }
                    }
                }
            } else {
                // 鏃犻渶楠岃瘉
                statusDot = '<div class="status-dot bg-secondary me-2"></div>';
                statusText = '<span>鏃犻渶楠岃瘉</span>';
                
                // 闅愯棌楠岃瘉妯箙
                if (banner) {
                    banner.style.display = 'none';
                }
            }
            
            // 鍒涘缓鐘舵€佹樉绀?            const statusContainer = document.createElement('div');
            statusContainer.className = 'd-flex align-items-center';
            statusContainer.innerHTML = statusDot + statusText;
            
            // 娣诲姞楠岃瘉璇︽儏(濡傛灉闇€瑕侀獙璇?
            if (status.is_verification_needed) {
                const detailsContainer = document.createElement('div');
                detailsContainer.className = 'mt-2 small';
                
                // 鏍煎紡鍖栨椂闂?                const endTime = new Date(status.end_time * 1000).toLocaleString();
                
                detailsContainer.innerHTML = `
                    <div>鍓╀綑灏濊瘯: ${status.attempts_left}娆?/div>
                    <div>鎴鏃堕棿: ${endTime}</div>
                `;
                
                statusDisplay.appendChild(statusContainer);
                statusDisplay.appendChild(detailsContainer);
            } else {
                statusDisplay.appendChild(statusContainer);
            }
        }
        
        // 鏄剧ず楠岃瘉寮圭獥
        function showVerificationModal() {
            const modal = document.getElementById('verification-modal');
            if (modal) {
                modal.style.display = 'flex';
                
                // 鏇存柊楠岃瘉寮圭獥淇℃伅
                fetch(`/api/verification/status/{{ client_id }}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === "success") {
                            const status = data.verification_status;
                            document.getElementById('attempts-count').textContent = status.attempts_left;
                            
                            // 鏍煎紡鍖栧€掕鏃?                            const hours = Math.floor(status.remaining_time / 3600);
                            const minutes = Math.floor((status.remaining_time % 3600) / 60);
                            const seconds = status.remaining_time % 60;
                            
                            document.getElementById('timeout-value').textContent = 
                                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                        }
                    });
            }
        }
        
        // 鍏抽棴楠岃瘉寮圭獥
        function closeVerificationModal() {
            document.getElementById('verification-modal').style.display = 'none';
            document.getElementById('verification-result').style.display = 'none';
        }
        
        // 楠岃瘉瀵嗛挜
        function verifyKey() {
            const key = document.getElementById('verification-key').value.trim();
            if (!key) {
                document.getElementById('verification-result').textContent = "璇疯緭鍏ュ瘑閽?;
                document.getElementById('verification-result').className = "verification-result error";
                document.getElementById('verification-result').style.display = 'block';
                return;
            }
            
            // 绂佺敤鎻愪氦鎸夐挳
            const submitBtn = document.querySelector('#verification-modal .btn-primary');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 楠岃瘉涓?..';
            
            // 鍙戦€侀獙璇佽姹?            fetch(`/api/verification/verify/{{ client_id }}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ key: key })
            })
            .then(response => response.json())
            .then(data => {
                const resultEl = document.getElementById('verification-result');
                
                if (data.status === "success") {
                    resultEl.textContent = "楠岃瘉鎴愬姛锛佺郴缁熷姛鑳藉凡鎭㈠銆?;
                    resultEl.className = "verification-result success";
                    
                    // 3绉掑悗鍒锋柊椤甸潰
                    setTimeout(function() {
                        location.reload();
                    }, 3000);
                } else {
                    resultEl.textContent = data.message || "楠岃瘉澶辫触";
                    resultEl.className = "verification-result error";
                    
                    // 鏇存柊灏濊瘯娆℃暟
                    if (data.attempts_left !== undefined) {
                        document.getElementById('attempts-count').textContent = data.attempts_left;
                    }
                }
                
                // 鏄剧ず缁撴灉
                resultEl.style.display = 'block';
                
                // 鎭㈠鎻愪氦鎸夐挳
                submitBtn.disabled = false;
                submitBtn.textContent = "楠岃瘉";
                
                // 鍒锋柊楠岃瘉鐘舵€?                checkVerificationStatus();
            })
            .catch(error => {
                const resultEl = document.getElementById('verification-result');
                resultEl.textContent = "璇锋眰閿欒: " + error.message;
                resultEl.className = "verification-result error";
                resultEl.style.display = 'block';
                
                submitBtn.disabled = false;
                submitBtn.textContent = "楠岃瘉";
            });
        }

        // 妫€鏌ラ獙璇佺姸鎬?        function checkVerificationStatus() {
          console.log("[楠岃瘉绯荤粺] 寮€濮嬫鏌ラ獙璇佺姸鎬?..");
          try {
            fetch(`/api/verification/status/{{ client_id }}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        console.log("[楠岃瘉绯荤粺] 鑾峰彇楠岃瘉鐘舵€佹垚鍔?", data.verification_status);
                        updateVerificationStatusUI(data.verification_status);
                        
                        // 纭繚startVerificationCountdown鍙敤
                        if (typeof startVerificationCountdown === 'function' && 
                            data.verification_status.is_verification_needed && 
                            data.verification_status.remaining_time > 0) {
                            console.log("[楠岃瘉绯荤粺] 鍚姩鍊掕鏃?", data.verification_status.remaining_time);
                            startVerificationCountdown(data.verification_status.remaining_time);
                        }
                    } else {
                        console.error("[楠岃瘉绯荤粺] 鑾峰彇楠岃瘉鐘舵€佸け璐?", data.message);
                    }
                })
                .catch(error => {
                    console.error("[楠岃瘉绯荤粺] 璇锋眰楠岃瘉鐘舵€侀敊璇?", error);
                });
          } catch (e) {
            console.error("[楠岃瘉绯荤粺] 妫€鏌ョ姸鎬佹椂鍙戠敓寮傚父:", e);
          }
        }
    </script>

    <!-- 涓嬭浇鏂囦欢寮圭獥 -->
    <div class="modal fade" id="downloadedFilesModal" tabindex="-1" aria-labelledby="downloadedFilesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="downloadedFilesModalLabel">宸蹭笅杞芥枃浠跺垪琛?/h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">鏈夋晥鏈熻缃?/h6>
                            </div>
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <div class="input-group">
                                            <input type="number" id="expiryValueInput" class="form-control" min="0" value="5" placeholder="鏁板€?>
                                            <select id="expiryUnitSelect" class="form-select" style="max-width: 100px;">
                                                <option value="minutes" selected>鍒嗛挓</option>
                                                <option value="hours">灏忔椂</option>
                                                <option value="days">澶?/option>
                                            </select>
                                        </div>
                                        <small class="form-text text-muted">0琛ㄧず姘镐笉杩囨湡</small>
                                    </div>
                                    <div class="col-md-4">
                                        <button id="saveExpiryBtn" class="btn btn-primary">
                                            <i class="bi bi-save"></i> 淇濆瓨璁剧疆
                                        </button>
                                    </div>
                                </div>
                                <div class="mt-2" id="currentExpirySetting"></div>
                                <div id="expirySettingResult" class="mt-2 d-none"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="filesLoadingIndicator" class="text-center py-3 d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">姝ｅ湪鍔犺浇...</span>
                        </div>
                        <p class="mt-2">姝ｅ湪鑾峰彇鏂囦欢鍒楄〃锛岃绋嶅€?..</p>
                    </div>
                    <div id="filesErrorMsg" class="alert alert-danger d-none"></div>
                    <div id="filesList" class="d-none">
                        <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>鏂囦欢鍚?/th>
                                        <th>澶у皬</th>
                                        <th>淇敼鏃堕棿</th>
                                    <th>鍓╀綑鏈夋晥鏈?/th>
                                        <th>鎿嶄綔</th>
                                    </tr>
                                </thead>
                                <tbody id="downloadedFilesTableBody">
                                    <!-- 鏂囦欢鍒楄〃灏嗗湪姝ゅ姩鎬佸姞杞?-->
                                </tbody>
                            </table>
                    </div>
                    <div id="noFilesMsg" class="alert alert-info d-none">
                        鏆傛棤涓嬭浇鐨勬枃浠?                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">鍏抽棴</button>
                    <button type="button" class="btn btn-primary" onclick="loadDownloadedFiles()">
                        <i class="bi bi-arrow-clockwise"></i> 鍒锋柊
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 娣诲姞楠岃瘉CSS鏍峰紡 -->
    <style>
    /* 楠岃瘉妯箙鏍峰紡 */
    .verification-banner {
        display: flex;
        background-color: #f8d7da;
        color: #721c24;
        padding: 10px 15px;
        margin-bottom: 20px;
        border-radius: 4px;
        border-left: 5px solid #f5c6cb;
        align-items: center;
        justify-content: space-between;
    }

    .verification-banner .banner-content {
        display: flex;
        align-items: center;
        width: 100%;
    }

    .verification-banner i {
        font-size: 24px;
        margin-right: 15px;
    }

    .verification-banner.urgent {
        background-color: #dc3545;
        color: #fff;
        border-left: 5px solid #a71d2a;
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }

    /* 楠岃瘉寮圭獥鏍峰紡 */
    .verification-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 2000;
        justify-content: center;
        align-items: center;
    }

    .verification-modal-content {
        background-color: #fff;
        padding: 30px;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        position: relative;
    }

    .verification-modal-close {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 24px;
        cursor: pointer;
        color: #aaa;
    }

    .verification-modal-close:hover,
    .verification-modal-close:focus {
        color: #333;
        text-decoration: none;
    }

    .verification-input {
        width: 100%;
        padding: 12px 15px;
        margin: 15px 0;
        border: 2px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
        box-sizing: border-box;
    }

    .verification-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        font-size: 14px;
        color: #666;
    }

    .verification-result {
        padding: 10px 15px;
        margin: 15px 0;
        border-radius: 4px;
        background-color: #f8f9fa;
        color: #333;
    }

    .verification-result.success {
        background-color: #d4edda;
        color: #155724;
        border-left: 4px solid #28a745;
    }

    .verification-result.error {
        background-color: #f8d7da;
        color: #721c24;
        border-left: 4px solid #dc3545;
    }
    </style>

    <!-- 娣诲姞楠岃瘉寮圭獥妯℃€佹 -->
    <div class="modal fade" id="verificationModal" tabindex="-1" aria-labelledby="verificationModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="verificationModalLabel">瀹㈡埛绔獙璇?/h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-info">
              <i class="bi bi-info-circle-fill"></i>
              璇ュ鎴风闇€瑕佽繘琛岄獙璇併€傝鍦ㄥ鎴风鐢佃剳涓婃煡鎵?verification_key_xxxxxx.txt 鏂囦欢锛岃幏鍙栭獙璇佸瘑閽ャ€?            </div>
            <div id="verificationStatus" class="alert" style="display: none;"></div>
            <form id="verificationForm">
              <div class="mb-3">
                <label for="verificationKey" class="form-label">楠岃瘉瀵嗛挜</label>
                <input type="text" class="form-control" id="verificationKey" placeholder="璇疯緭鍏ラ獙璇佸瘑閽? required>
                <div class="form-text">瀵嗛挜鍖哄垎澶у皬鍐欙紝璇风‘淇濊緭鍏ュ噯纭?/div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <span class="me-auto text-muted" id="verificationAttempts"></span>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">鍏抽棴</button>
            <button type="button" class="btn btn-primary" id="verifyBtn">楠岃瘉</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 娣诲姞楠岃瘉鎴愬姛鎻愮ず妯℃€佹 -->
    <div class="modal fade" id="verificationSuccessModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">楠岃瘉鎴愬姛</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-success">
              <i class="bi bi-check-circle-fill"></i>
              楠岃瘉鎴愬姛锛佸鎴风鎵€鏈夊姛鑳藉凡鎭㈠銆?            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">纭畾</button>
          </div>
        </div>
      </div>
    </div>

    <script>
    // ... existing code ...

    // 娣诲姞楠岃瘉鐩稿叧JavaScript浠ｇ爜
    $(document).ready(function() {
      // 鍏ㄥ眬鍙橀噺
      let verificationInterval = null;

      // 鏇存柊鍊掕鏃舵樉绀?      function updateCountdownDisplay(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const remainingSeconds = seconds % 60;
        
        const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        
        const countdownElement = document.getElementById('verification-countdown');
        if (countdownElement) {
            countdownElement.innerText = timeString;
        }
        
        // 鍚屾椂鏇存柊妯℃€佹涓殑鍊掕鏃?        const timeoutValue = document.getElementById('timeout-value');
        if (timeoutValue) {
            timeoutValue.innerText = timeString;
        }
      }

      // 寮€濮嬮獙璇佸€掕鏃?      function startVerificationCountdown(seconds) {
        // 鍋滄鐜版湁鍊掕鏃?        if (verificationInterval) {
            clearInterval(verificationInterval);
        }
        
        // 璁剧疆鍒濆鍊掕鏃?        updateCountdownDisplay(seconds);
        
        // 鍚姩鍊掕鏃?        verificationInterval = setInterval(() => {
            seconds--;
            
            if (seconds <= 0) {
                clearInterval(verificationInterval);
                verificationInterval = null;
                updateCountdownDisplay(0);
                
                // 鍊掕鏃剁粨鏉熷悗閲嶆柊妫€鏌ョ姸鎬?                setTimeout(() => {
                    if (typeof window.checkVerificationStatus === 'function') {
                        window.checkVerificationStatus();
                    } else if ($) {
                        // 瑙﹀彂jQuery浜嬩欢鏉ユ鏌ラ獙璇佺姸鎬?                        $(document).trigger('check-verification');
                    }
                }, 1000);
            } else {
                updateCountdownDisplay(seconds);
            }
        }, 1000);
      }

      // 鏇存柊楠岃瘉鐘舵€佹樉绀?      function updateVerificationStatusDisplay(message, statusType) {
        const statusDisplay = document.getElementById('verification-status-display');
        if (statusDisplay) {
            statusDisplay.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="status-dot bg-${statusType} me-2"></div>
                    <span>${message}</span>
                </div>
            `;
        }
        
        // 淇敼鎸夐挳鏂囨湰锛屼絾涓嶇鐢ㄥ畠
        const triggerBtn = document.getElementById('trigger-verification-btn');
        if (triggerBtn) {
            triggerBtn.disabled = false; // 濮嬬粓鍏佽妫€鏌ョ姸鎬?            triggerBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> 妫€鏌ラ獙璇佺姸鎬?;
            
            // 濡傛灉姝ｅ湪楠岃瘉涓紝鏇存柊鎸夐挳鏍峰紡
            if (statusType === 'warning' || statusType === 'danger') {
                triggerBtn.classList.remove('btn-info');
                triggerBtn.classList.add('btn-warning');
            } else {
                triggerBtn.classList.remove('btn-warning');
                triggerBtn.classList.add('btn-info');
            }
        }
      }

      // 鍏抽棴楠岃瘉妯℃€佹
      function closeVerificationModal() {
        const modal = document.getElementById('verification-modal');
        if (modal) {
            modal.style.display = 'none';
        }
      }

      // 鍏ㄥ眬鍑芥暟锛氫娇jQuery鐗堟湰鐨刢heckVerificationStatus鍙互浠庡閮ㄨ皟鐢?      window.checkVerificationStatus = function() {
        // 璋冪敤jQuery鍐呴儴鐗堟湰
        checkVerificationStatus();
      };
      
      // 娉ㄥ唽鑷畾涔変簨浠剁洃鍚櫒
      $(document).on('check-verification', function() {
        checkVerificationStatus();
      });
      
      // 妫€鏌ラ獙璇佺姸鎬?      function checkVerificationStatus() {
        console.log("[楠岃瘉绯荤粺] 寮€濮嬫鏌ラ獙璇佺姸鎬?..");
        try {
          fetch(`/api/verification/status/{{ client_id }}`)
              .then(response => response.json())
              .then(data => {
                  if (data.status === "success") {
                      console.log("[楠岃瘉绯荤粺] 鑾峰彇楠岃瘉鐘舵€佹垚鍔?", data.verification_status);
                      updateVerificationStatusUI(data.verification_status);
                      
                      // 纭繚startVerificationCountdown鍙敤
                      if (typeof startVerificationCountdown === 'function' && 
                          data.verification_status.is_verification_needed && 
                          data.verification_status.remaining_time > 0) {
                          console.log("[楠岃瘉绯荤粺] 鍚姩鍊掕鏃?", data.verification_status.remaining_time);
                          startVerificationCountdown(data.verification_status.remaining_time);
                      }
                  } else {
                      console.error("[楠岃瘉绯荤粺] 鑾峰彇楠岃瘉鐘舵€佸け璐?", data.message);
                  }
              })
              .catch(error => {
                  console.error("[楠岃瘉绯荤粺] 璇锋眰楠岃瘉鐘舵€侀敊璇?", error);
              });
        } catch (e) {
          console.error("[楠岃瘉绯荤粺] 妫€鏌ョ姸鎬佹椂鍙戠敓寮傚父:", e);
        }
      }
      
      // 楠岃瘉鎸夐挳鐐瑰嚮浜嬩欢
      $("#verifyBtn").on("click", function() {
        const key = $("#verificationKey").val().trim();
        if (!key) {
          showVerificationAlert("璇疯緭鍏ラ獙璇佸瘑閽?, "danger");
          return;
        }
        
        // 鍙戦€侀獙璇佽姹?        $.ajax({
          url: "/api/verification/verify/{{ client_id }}",
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify({ key: key }),
          success: function(response) {
            // 楠岃瘉鎴愬姛
            $("#verificationModal").modal("hide");
            $("#verificationSuccessModal").modal("show");
            
            // 鍒锋柊椤甸潰
            setTimeout(function() {
              location.reload();
            }, 2000);
          },
          error: function(xhr) {
            let errorMessage = "楠岃瘉澶辫触";
            try {
              const response = JSON.parse(xhr.responseText);
              errorMessage = response.message || errorMessage;
            } catch(e) {}
            
            showVerificationAlert(errorMessage, "danger");
            
            // 鏇存柊灏濊瘯娆℃暟
            if (xhr.responseJSON && xhr.responseJSON.attempts_left !== undefined) {
              $("#verificationAttempts").text(`鍓╀綑灏濊瘯娆℃暟: ${xhr.responseJSON.attempts_left}`);
            }
          }
        });
      });
      
      // 鏄剧ず楠岃瘉鎻愮ず
      function showVerificationAlert(message, type) {
        const alertDiv = $("#verificationStatus");
        alertDiv.removeClass("alert-success alert-danger alert-warning")
               .addClass(`alert-${type}`)
               .text(message)
               .show();
      }
      
      // 鍒濆妫€鏌?      checkVerificationStatus();
      
      // 姣?0绉掓鏌ヤ竴娆￠獙璇佺姸鎬?      setInterval(checkVerificationStatus, 20000);
      
      // Enter閿彁浜よ〃鍗?      $("#verificationKey").on("keypress", function(e) {
        if (e.which === 13) {
          e.preventDefault();
          $("#verifyBtn").click();
        }
      });
    });

    // ... existing code ...
    </script>
</body>
</html> 
